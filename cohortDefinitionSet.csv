"cohortId","cohortName","json","sql","subsetParent","isSubset","subsetDefinitionId"
26,"[P] Asthma or Chronic obstructive pulmonary disease (COPD) (FP)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 0,
					""ConditionTypeExclude"" : false
				}
			},
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 3,
					""ConditionTypeExclude"" : false
				}
			},
			{
				""DrugExposure"" : {
					""CorrelatedCriteria"" : {
						""Type"" : ""ALL"",
						""CriteriaList"" : [
							{
								""Criteria"" : {
									""DrugExposure"" : {
										""CodesetId"" : 4,
										""DrugTypeExclude"" : false
									}
								},
								""StartWindow"" : {
									""Start"" : {
										""Days"" : 180,
										""Coeff"" : 1
									},
									""End"" : {
										""Days"" : 365,
										""Coeff"" : 1
									},
									""UseIndexEnd"" : false,
									""UseEventEnd"" : false
								},
								""RestrictVisit"" : false,
								""IgnoreObservationPeriod"" : true,
								""Occurrence"" : {
									""Type"" : 2,
									""Count"" : 1,
									""IsDistinct"" : false
								}
							}
						],
						""DemographicCriteriaList"" : [],
						""Groups"" : []
					},
					""CodesetId"" : 4,
					""DrugTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""First""
		}
	},
	""ConceptSets"" : [
		{
			""id"" : 0,
			""name"" : "" Chronic obstructive lung disease"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 255573,
							""CONCEPT_NAME"" : ""Chronic obstructive lung disease"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""13645005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 258780,
							""CONCEPT_NAME"" : ""Emphysematous bronchitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""185086009"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 3,
			""name"" : ""Asthma"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 317009,
							""CONCEPT_NAME"" : ""Asthma"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""195967001"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4235703,
							""CONCEPT_NAME"" : ""Asthma management"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""406162001"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4279553,
							""CONCEPT_NAME"" : ""Eosinophilic asthma"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""367542003"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 4,
			""name"" : ""Respiratory therapy"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 42483138,
							""CONCEPT_NAME"" : ""Albuterol / Beclomethasone Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP418868"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36812530,
							""CONCEPT_NAME"" : ""Albuterol / Beclomethasone Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4826562"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40727741,
							""CONCEPT_NAME"" : ""Albuterol / Ipratropium Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4729368"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356123,
							""CONCEPT_NAME"" : ""Albuterol / Ipratropium Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108259"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40142665,
							""CONCEPT_NAME"" : ""Albuterol / Ipratropium Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""745734"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 46234463,
							""CONCEPT_NAME"" : ""Albuterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1649559"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356111,
							""CONCEPT_NAME"" : ""Albuterol Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108233"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356108,
							""CONCEPT_NAME"" : ""Albuterol Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108226"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40142703,
							""CONCEPT_NAME"" : ""Albuterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""745678"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36421291,
							""CONCEPT_NAME"" : ""Beclomethasone / formoterol / glycopyrronium Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4763575"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40745353,
							""CONCEPT_NAME"" : ""Beclomethasone / formoterol / glycopyrronium Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4711820"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36787954,
							""CONCEPT_NAME"" : ""Beclomethasone / formoterol / glycopyrronium Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4776216"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 21158944,
							""CONCEPT_NAME"" : ""Beclomethasone / formoterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP286058"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36894458,
							""CONCEPT_NAME"" : ""Beclomethasone / formoterol Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP1002030"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 21090035,
							""CONCEPT_NAME"" : ""Beclomethasone / formoterol Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP286036"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36883710,
							""CONCEPT_NAME"" : ""Beclomethasone Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP1004751"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35130061,
							""CONCEPT_NAME"" : ""Beclomethasone Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4787320"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40142784,
							""CONCEPT_NAME"" : ""Beclomethasone Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""746190"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 42479684,
							""CONCEPT_NAME"" : ""Budesonide / formoterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP419122"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35133500,
							""CONCEPT_NAME"" : ""Budesonide / formoterol Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4790710"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 783228,
							""CONCEPT_NAME"" : ""Budesonide / formoterol Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4831059"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40142910,
							""CONCEPT_NAME"" : ""Budesonide / formoterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""745797"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36787269,
							""CONCEPT_NAME"" : ""Budesonide / salmeterol Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4775534"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356143,
							""CONCEPT_NAME"" : ""Budesonide Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108302"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35135829,
							""CONCEPT_NAME"" : ""Budesonide Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4793016"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356140,
							""CONCEPT_NAME"" : ""Budesonide Inhalation Suspension"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108295"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44120754,
							""CONCEPT_NAME"" : ""Budesonide Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP1115385"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 41205832,
							""CONCEPT_NAME"" : ""Butanilicaine / Epinephrine Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2403794"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40924271,
							""CONCEPT_NAME"" : ""Butanilicaine / Norepinephrine Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2122233"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40986621,
							""CONCEPT_NAME"" : ""Carbuterol Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2184583"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40830666,
							""CONCEPT_NAME"" : ""Cromoglycate / Isoproterenol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2028628"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 41205663,
							""CONCEPT_NAME"" : ""Cromoglycate / reproterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2403625"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40861866,
							""CONCEPT_NAME"" : ""Cromoglycate / reproterol Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2059828"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 43274335,
							""CONCEPT_NAME"" : ""Cromoglycate Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP551853"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 43263324,
							""CONCEPT_NAME"" : ""Cromoglycate Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP551855"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 43621601,
							""CONCEPT_NAME"" : ""Cromolyn / reproterol Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP956780"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356154,
							""CONCEPT_NAME"" : ""Cromolyn Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108327"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356147,
							""CONCEPT_NAME"" : ""Cromolyn Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108316"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40143105,
							""CONCEPT_NAME"" : ""Cromolyn Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""746181"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 43134418,
							""CONCEPT_NAME"" : ""Fenoterol / Ipratropium Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP443574"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40727834,
							""CONCEPT_NAME"" : ""Fenoterol / Ipratropium Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4729268"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36811735,
							""CONCEPT_NAME"" : ""Fenoterol / Ipratropium Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4825769"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40861768,
							""CONCEPT_NAME"" : ""Fenoterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2059730"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40727839,
							""CONCEPT_NAME"" : ""Fenoterol Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4729263"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35150375,
							""CONCEPT_NAME"" : ""Fenoterol Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4807426"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44081619,
							""CONCEPT_NAME"" : ""Fenoterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP1076250"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36811485,
							""CONCEPT_NAME"" : ""Ipratropium Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4825521"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356213,
							""CONCEPT_NAME"" : ""Ipratropium Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108449"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40143214,
							""CONCEPT_NAME"" : ""Ipratropium Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""746447"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356217,
							""CONCEPT_NAME"" : ""Isoetharine Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108457"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356215,
							""CONCEPT_NAME"" : ""Isoetharine Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108453"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356101,
							""CONCEPT_NAME"" : ""Isoproterenol Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108199"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 42800913,
							""CONCEPT_NAME"" : ""Isoproterenol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1299671"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40143326,
							""CONCEPT_NAME"" : ""Mometasone Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""746792"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36894464,
							""CONCEPT_NAME"" : ""Mometasone Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP994725"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44817882,
							""CONCEPT_NAME"" : ""Mometasone Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1536141"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40143337,
							""CONCEPT_NAME"" : ""Nedocromil Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""748721"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 42941603,
							""CONCEPT_NAME"" : ""Procaterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4668248"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35146684,
							""CONCEPT_NAME"" : ""Procaterol Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4803760"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35160199,
							""CONCEPT_NAME"" : ""Procaterol Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4817177"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44029688,
							""CONCEPT_NAME"" : ""Procaterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP1024319"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 42481922,
							""CONCEPT_NAME"" : ""Terbutaline Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP418565"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36813480,
							""CONCEPT_NAME"" : ""Terbutaline Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4827512"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36812414,
							""CONCEPT_NAME"" : ""Terbutaline Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4826446"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356244,
							""CONCEPT_NAME"" : ""Terbutaline Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108534"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 21150787,
							""CONCEPT_NAME"" : ""aclidinium / formoterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP365897"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44082127,
							""CONCEPT_NAME"" : ""aclidinium / formoterol Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP1076758"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 41206083,
							""CONCEPT_NAME"" : ""aclidinium / formoterol Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2404045"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 42873412,
							""CONCEPT_NAME"" : ""aclidinium Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1303101"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44069324,
							""CONCEPT_NAME"" : ""aclidinium Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP1063955"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 41236953,
							""CONCEPT_NAME"" : ""aclidinium Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2434915"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356138,
							""CONCEPT_NAME"" : ""bitolterol Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108291"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356136,
							""CONCEPT_NAME"" : ""bitolterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108287"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40152662,
							""CONCEPT_NAME"" : ""ciclesonide Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""799033"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40156382,
							""CONCEPT_NAME"" : ""flunisolide Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""828926"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 41048760,
							""CONCEPT_NAME"" : ""fluticasone / formoterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2246722"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40754973,
							""CONCEPT_NAME"" : ""fluticasone / formoterol Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4702057"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 21089505,
							""CONCEPT_NAME"" : ""fluticasone / formoterol Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP357047"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40144020,
							""CONCEPT_NAME"" : ""fluticasone / salmeterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""746717"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36882733,
							""CONCEPT_NAME"" : ""fluticasone / salmeterol Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP994600"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 42482744,
							""CONCEPT_NAME"" : ""fluticasone / salmeterol Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP419713"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40144024,
							""CONCEPT_NAME"" : ""fluticasone / salmeterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""744485"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 792484,
							""CONCEPT_NAME"" : ""fluticasone / umeclidinium / vilanterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1945037"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40755794,
							""CONCEPT_NAME"" : ""fluticasone / umeclidinium / vilanterol Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4701920"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37592046,
							""CONCEPT_NAME"" : ""fluticasone / vilanterol / vilanterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4781501"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 43532281,
							""CONCEPT_NAME"" : ""fluticasone / vilanterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1424887"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 43291091,
							""CONCEPT_NAME"" : ""fluticasone / vilanterol Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP557209"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 41267401,
							""CONCEPT_NAME"" : ""fluticasone / vilanterol Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2465363"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40144035,
							""CONCEPT_NAME"" : ""fluticasone Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""746765"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35147990,
							""CONCEPT_NAME"" : ""fluticasone Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4805056"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35149212,
							""CONCEPT_NAME"" : ""fluticasone Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4806270"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40144037,
							""CONCEPT_NAME"" : ""fluticasone Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""746403"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40223712,
							""CONCEPT_NAME"" : ""formoterol / Mometasone Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""998040"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 42629522,
							""CONCEPT_NAME"" : ""formoterol / glycopyrronium Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1790637"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 42480849,
							""CONCEPT_NAME"" : ""formoterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP419273"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356191,
							""CONCEPT_NAME"" : ""formoterol Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108402"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356187,
							""CONCEPT_NAME"" : ""formoterol Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108395"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44107471,
							""CONCEPT_NAME"" : ""formoterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP1102102"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 43145868,
							""CONCEPT_NAME"" : ""glycopyrronium / indacaterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP448437"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 43259954,
							""CONCEPT_NAME"" : ""glycopyrronium / indacaterol Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP573715"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356196,
							""CONCEPT_NAME"" : ""glycopyrronium / indacaterol Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108413"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35145836,
							""CONCEPT_NAME"" : ""glycopyrronium / indacaterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4802923"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 43292583,
							""CONCEPT_NAME"" : ""glycopyrronium Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP573663"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356199,
							""CONCEPT_NAME"" : ""glycopyrronium Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108419"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 42479568,
							""CONCEPT_NAME"" : ""indacaterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP418726"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356211,
							""CONCEPT_NAME"" : ""indacaterol Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108445"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44055847,
							""CONCEPT_NAME"" : ""indacaterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP1050478"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44081467,
							""CONCEPT_NAME"" : ""metaproterenol Gas for Inhalation"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP1076098"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356120,
							""CONCEPT_NAME"" : ""metaproterenol Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108252"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40182262,
							""CONCEPT_NAME"" : ""metaproterenol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""979330"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40746092,
							""CONCEPT_NAME"" : ""olodaterol / tiotropium Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4711610"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 21026290,
							""CONCEPT_NAME"" : ""olodaterol / tiotropium Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP256714"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 46275343,
							""CONCEPT_NAME"" : ""olodaterol / tiotropium Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1658459"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40746100,
							""CONCEPT_NAME"" : ""olodaterol Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4711602"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 21174574,
							""CONCEPT_NAME"" : ""olodaterol Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP275394"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 45775117,
							""CONCEPT_NAME"" : ""olodaterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1546062"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40861610,
							""CONCEPT_NAME"" : ""oxitropium Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2059572"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36810762,
							""CONCEPT_NAME"" : ""oxitropium Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4824799"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35147090,
							""CONCEPT_NAME"" : ""oxitropium Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4804165"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 41205378,
							""CONCEPT_NAME"" : ""pirbuterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2403340"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40152687,
							""CONCEPT_NAME"" : ""pirbuterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""801916"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40167702,
							""CONCEPT_NAME"" : ""salmeterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""866043"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35158799,
							""CONCEPT_NAME"" : ""salmeterol Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4815788"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 783089,
							""CONCEPT_NAME"" : ""salmeterol Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4830921"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356189,
							""CONCEPT_NAME"" : ""salmeterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108399"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 42482075,
							""CONCEPT_NAME"" : ""tiotropium Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP419850"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 42482607,
							""CONCEPT_NAME"" : ""tiotropium Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP419849"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356250,
							""CONCEPT_NAME"" : ""tiotropium Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108544"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 45774773,
							""CONCEPT_NAME"" : ""tiotropium Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1552001"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36421515,
							""CONCEPT_NAME"" : ""umeclidinium / umeclidinium / vilanterol / vilanterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4763797"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37592341,
							""CONCEPT_NAME"" : ""umeclidinium / umeclidinium / vilanterol / vilanterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4781790"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44785908,
							""CONCEPT_NAME"" : ""umeclidinium / vilanterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1487517"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 43263899,
							""CONCEPT_NAME"" : ""umeclidinium / vilanterol Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP557201"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 41267166,
							""CONCEPT_NAME"" : ""umeclidinium / vilanterol Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2465128"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 45774869,
							""CONCEPT_NAME"" : ""umeclidinium Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1539250"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 43285708,
							""CONCEPT_NAME"" : ""umeclidinium Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP557191"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 41142750,
							""CONCEPT_NAME"" : ""umeclidinium Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2340712"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""First""
	},
	""ExpressionLimit"" : {
		""Type"" : ""First""
	},
	""InclusionRules"" : [],
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 0
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 0 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (255573,258780)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (255573,258780)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 3 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (317009,4235703,4279553)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (317009,4235703,4279553)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 4 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (42483138,36812530,40727741,1356123,40142665,46234463,1356111,1356108,40142703,36421291,40745353,36787954,21158944,36894458,21090035,36883710,35130061,40142784,42479684,35133500,783228,40142910,36787269,1356143,35135829,1356140,44120754,41205832,40924271,40986621,40830666,41205663,40861866,43274335,43263324,43621601,1356154,1356147,40143105,43134418,40727834,36811735,40861768,40727839,35150375,44081619,36811485,1356213,40143214,1356217,1356215,1356101,42800913,40143326,36894464,44817882,40143337,42941603,35146684,35160199,44029688,42481922,36813480,36812414,1356244,21150787,44082127,41206083,42873412,44069324,41236953,1356138,1356136,40152662,40156382,41048760,40754973,21089505,40144020,36882733,42482744,40144024,792484,40755794,37592046,43532281,43291091,41267401,40144035,35147990,35149212,40144037,40223712,42629522,42480849,1356191,1356187,44107471,43145868,43259954,1356196,35145836,43292583,1356199,42479568,1356211,44055847,44081467,1356120,40182262,40746092,21026290,46275343,40746100,21174574,45775117,40861610,36810762,35147090,41205378,40152687,40167702,35158799,783089,1356189,42482075,42482607,1356250,45774773,36421515,37592341,44785908,43263899,41267166,45774869,43285708,41142750)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (42483138,36812530,40727741,1356123,40142665,46234463,1356111,1356108,40142703,36421291,40745353,36787954,21158944,36894458,21090035,36883710,35130061,40142784,42479684,35133500,783228,40142910,36787269,1356143,35135829,1356140,44120754,41205832,40924271,40986621,40830666,41205663,40861866,43274335,43263324,43621601,1356154,1356147,40143105,43134418,40727834,36811735,40861768,40727839,35150375,44081619,36811485,1356213,40143214,1356217,1356215,1356101,42800913,40143326,36894464,44817882,40143337,42941603,35146684,35160199,44029688,42481922,36813480,36812414,1356244,21150787,44082127,41206083,42873412,44069324,41236953,1356138,1356136,40152662,40156382,41048760,40754973,21089505,40144020,36882733,42482744,40144024,792484,40755794,37592046,43532281,43291091,41267401,40144035,35147990,35149212,40144037,40223712,42629522,42480849,1356191,1356187,44107471,43145868,43259954,1356196,35145836,43292583,1356199,42479568,1356211,44055847,44081467,1356120,40182262,40746092,21026290,46275343,40746100,21174574,45775117,40861610,36810762,35147090,41205378,40152687,40167702,35158799,783089,1356189,42482075,42482607,1356250,45774773,36421515,37592341,44785908,43263899,41267166,45774869,43285708,41142750)
  and c.invalid_reason is null

) I
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 0)
) C


-- End Condition Occurrence Criteria

UNION ALL
-- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria

UNION ALL
select PE.person_id, PE.event_id, PE.start_date, PE.end_date, PE.visit_occurrence_id, PE.sort_date FROM (
-- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.DRUG_EXPOSURE_END_DATE, DATEADD(day,C.DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,C.DRUG_EXPOSURE_START_DATE)) as end_date,
       C.visit_occurrence_id,C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets cs on (de.drug_concept_id = cs.concept_id and cs.codeset_id = 4)
) C


-- End Drug Exposure Criteria

) PE
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.DRUG_EXPOSURE_END_DATE, DATEADD(day,C.DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,C.DRUG_EXPOSURE_START_DATE)) as end_date,
       C.visit_occurrence_id,C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets cs on (de.drug_concept_id = cs.concept_id and cs.codeset_id = 4)
) C


-- End Drug Exposure Criteria
) Q
JOIN @cdm_database_schema.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.DRUG_EXPOSURE_END_DATE, DATEADD(day,C.DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,C.DRUG_EXPOSURE_START_DATE)) as end_date,
       C.visit_occurrence_id,C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets cs on (de.drug_concept_id = cs.concept_id and cs.codeset_id = 4)
) C


-- End Drug Exposure Criteria
) Q
JOIN @cdm_database_schema.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) P
JOIN (
  -- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.DRUG_EXPOSURE_END_DATE, DATEADD(day,C.DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,C.DRUG_EXPOSURE_START_DATE)) as end_date,
       C.visit_occurrence_id,C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets cs on (de.drug_concept_id = cs.concept_id and cs.codeset_id = 4)
) C


-- End Drug Exposure Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,180,P.START_DATE) AND A.START_DATE <= DATEADD(day,365,P.START_DATE) ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id and AC.event_id = pe.event_id

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P
WHERE P.ordinal = 1
-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

) Results
WHERE Results.ordinal = 1
;



-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- By default, cohort exit at the event's op end date
select event_id, person_id, op_end_date as end_date from #included_events
    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 0, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,0,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats





TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",26,FALSE,
27,"[P] Asthma without COPD (FP)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""DrugExposure"" : {
					""CorrelatedCriteria"" : {
						""Type"" : ""ALL"",
						""CriteriaList"" : [
							{
								""Criteria"" : {
									""DrugExposure"" : {
										""CodesetId"" : 4,
										""DrugTypeExclude"" : false
									}
								},
								""StartWindow"" : {
									""Start"" : {
										""Days"" : 365,
										""Coeff"" : -1
									},
									""End"" : {
										""Days"" : 180,
										""Coeff"" : -1
									},
									""UseIndexEnd"" : false,
									""UseEventEnd"" : false
								},
								""RestrictVisit"" : false,
								""IgnoreObservationPeriod"" : true,
								""Occurrence"" : {
									""Type"" : 2,
									""Count"" : 1,
									""IsDistinct"" : false
								}
							}
						],
						""DemographicCriteriaList"" : [],
						""Groups"" : []
					},
					""CodesetId"" : 4,
					""DrugTypeExclude"" : false,
					""Age"" : {
						""Value"" : 55,
						""Op"" : ""lt""
					}
				}
			},
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 0,
					""ConditionTypeExclude"" : false
				}
			},
			{
				""Observation"" : {
					""CodesetId"" : 0,
					""ObservationTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""First""
		}
	},
	""ConceptSets"" : [
		{
			""id"" : 0,
			""name"" : ""Asthma"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 317009,
							""CONCEPT_NAME"" : ""Asthma"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""195967001"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4235703,
							""CONCEPT_NAME"" : ""Asthma management"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""406162001"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4279553,
							""CONCEPT_NAME"" : ""Eosinophilic asthma"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""367542003"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 2,
			""name"" : ""Chronic Obstructive Lung Disease"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 255573,
							""CONCEPT_NAME"" : ""Chronic obstructive lung disease"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""13645005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 258780,
							""CONCEPT_NAME"" : ""Emphysematous bronchitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""185086009"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 3,
			""name"" : ""Long-acting muscarinic antagonists (LAMAs)"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 21603292,
							""CONCEPT_NAME"" : ""Anticholinergics"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""R03BB"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""ATC"",
							""CONCEPT_CLASS_ID"" : ""ATC 4th""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 4,
			""name"" : ""Asthma therapy"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 42483138,
							""CONCEPT_NAME"" : ""Albuterol / Beclomethasone Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP418868"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36812530,
							""CONCEPT_NAME"" : ""Albuterol / Beclomethasone Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4826562"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40727741,
							""CONCEPT_NAME"" : ""Albuterol / Ipratropium Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4729368"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356123,
							""CONCEPT_NAME"" : ""Albuterol / Ipratropium Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108259"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40142665,
							""CONCEPT_NAME"" : ""Albuterol / Ipratropium Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""745734"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 46234463,
							""CONCEPT_NAME"" : ""Albuterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1649559"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356111,
							""CONCEPT_NAME"" : ""Albuterol Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108233"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356108,
							""CONCEPT_NAME"" : ""Albuterol Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108226"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40142703,
							""CONCEPT_NAME"" : ""Albuterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""745678"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 21603292,
							""CONCEPT_NAME"" : ""Anticholinergics"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""R03BB"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""ATC"",
							""CONCEPT_CLASS_ID"" : ""ATC 4th""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 41143395,
							""CONCEPT_NAME"" : ""Ascorbic Acid / Benzoate / Epinephrine / Potassium / Sodium Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2341357"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36421291,
							""CONCEPT_NAME"" : ""Beclomethasone / formoterol / glycopyrronium Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4763575"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40745353,
							""CONCEPT_NAME"" : ""Beclomethasone / formoterol / glycopyrronium Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4711820"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36787954,
							""CONCEPT_NAME"" : ""Beclomethasone / formoterol / glycopyrronium Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4776216"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 21158944,
							""CONCEPT_NAME"" : ""Beclomethasone / formoterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP286058"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36894458,
							""CONCEPT_NAME"" : ""Beclomethasone / formoterol Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP1002030"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 21090035,
							""CONCEPT_NAME"" : ""Beclomethasone / formoterol Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP286036"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36883710,
							""CONCEPT_NAME"" : ""Beclomethasone Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP1004751"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35130061,
							""CONCEPT_NAME"" : ""Beclomethasone Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4787320"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40142784,
							""CONCEPT_NAME"" : ""Beclomethasone Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""746190"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 42479684,
							""CONCEPT_NAME"" : ""Budesonide / formoterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP419122"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35133500,
							""CONCEPT_NAME"" : ""Budesonide / formoterol Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4790710"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 783228,
							""CONCEPT_NAME"" : ""Budesonide / formoterol Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4831059"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40142910,
							""CONCEPT_NAME"" : ""Budesonide / formoterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""745797"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36787269,
							""CONCEPT_NAME"" : ""Budesonide / salmeterol Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4775534"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356143,
							""CONCEPT_NAME"" : ""Budesonide Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108302"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35135829,
							""CONCEPT_NAME"" : ""Budesonide Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4793016"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356140,
							""CONCEPT_NAME"" : ""Budesonide Inhalation Suspension"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108295"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44120754,
							""CONCEPT_NAME"" : ""Budesonide Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP1115385"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 41205832,
							""CONCEPT_NAME"" : ""Butanilicaine / Epinephrine Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2403794"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40924271,
							""CONCEPT_NAME"" : ""Butanilicaine / Norepinephrine Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2122233"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40986621,
							""CONCEPT_NAME"" : ""Carbuterol Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2184583"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40830666,
							""CONCEPT_NAME"" : ""Cromoglycate / Isoproterenol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2028628"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 41205663,
							""CONCEPT_NAME"" : ""Cromoglycate / reproterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2403625"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40861866,
							""CONCEPT_NAME"" : ""Cromoglycate / reproterol Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2059828"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 43274335,
							""CONCEPT_NAME"" : ""Cromoglycate Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP551853"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 43263324,
							""CONCEPT_NAME"" : ""Cromoglycate Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP551855"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 43621601,
							""CONCEPT_NAME"" : ""Cromolyn / reproterol Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP956780"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356154,
							""CONCEPT_NAME"" : ""Cromolyn Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108327"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356147,
							""CONCEPT_NAME"" : ""Cromolyn Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108316"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40143105,
							""CONCEPT_NAME"" : ""Cromolyn Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""746181"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 41080205,
							""CONCEPT_NAME"" : ""Epinephrine / Theophylline Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2278167"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 41174344,
							""CONCEPT_NAME"" : ""Epinephrine / ethaverine / homatropine / polidocanol Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2372306"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 41111516,
							""CONCEPT_NAME"" : ""Epinephrine / hypophysis extract Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2309478"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356173,
							""CONCEPT_NAME"" : ""Epinephrine Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108366"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356180,
							""CONCEPT_NAME"" : ""Epinephrine Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108382"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40144087,
							""CONCEPT_NAME"" : ""Epinephrine Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""746206"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 43134418,
							""CONCEPT_NAME"" : ""Fenoterol / Ipratropium Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP443574"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40727834,
							""CONCEPT_NAME"" : ""Fenoterol / Ipratropium Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4729268"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36811735,
							""CONCEPT_NAME"" : ""Fenoterol / Ipratropium Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4825769"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40861768,
							""CONCEPT_NAME"" : ""Fenoterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2059730"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40727839,
							""CONCEPT_NAME"" : ""Fenoterol Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4729263"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35150375,
							""CONCEPT_NAME"" : ""Fenoterol Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4807426"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44081619,
							""CONCEPT_NAME"" : ""Fenoterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP1076250"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356217,
							""CONCEPT_NAME"" : ""Isoetharine Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108457"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356215,
							""CONCEPT_NAME"" : ""Isoetharine Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108453"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356101,
							""CONCEPT_NAME"" : ""Isoproterenol Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108199"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 42800913,
							""CONCEPT_NAME"" : ""Isoproterenol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1299671"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40143326,
							""CONCEPT_NAME"" : ""Mometasone Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""746792"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36894464,
							""CONCEPT_NAME"" : ""Mometasone Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP994725"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44817882,
							""CONCEPT_NAME"" : ""Mometasone Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1536141"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40143337,
							""CONCEPT_NAME"" : ""Nedocromil Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""748721"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 42941603,
							""CONCEPT_NAME"" : ""Procaterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4668248"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35146684,
							""CONCEPT_NAME"" : ""Procaterol Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4803760"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35160199,
							""CONCEPT_NAME"" : ""Procaterol Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4817177"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44029688,
							""CONCEPT_NAME"" : ""Procaterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP1024319"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 42481922,
							""CONCEPT_NAME"" : ""Terbutaline Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP418565"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36813480,
							""CONCEPT_NAME"" : ""Terbutaline Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4827512"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36812414,
							""CONCEPT_NAME"" : ""Terbutaline Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4826446"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356244,
							""CONCEPT_NAME"" : ""Terbutaline Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108534"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40143708,
							""CONCEPT_NAME"" : ""Triamcinolone Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""746202"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 21150787,
							""CONCEPT_NAME"" : ""aclidinium / formoterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP365897"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44082127,
							""CONCEPT_NAME"" : ""aclidinium / formoterol Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP1076758"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 41206083,
							""CONCEPT_NAME"" : ""aclidinium / formoterol Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2404045"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356138,
							""CONCEPT_NAME"" : ""bitolterol Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108291"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356136,
							""CONCEPT_NAME"" : ""bitolterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108287"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40152662,
							""CONCEPT_NAME"" : ""ciclesonide Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""799033"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40156382,
							""CONCEPT_NAME"" : ""flunisolide Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""828926"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 41048760,
							""CONCEPT_NAME"" : ""fluticasone / formoterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2246722"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40754973,
							""CONCEPT_NAME"" : ""fluticasone / formoterol Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4702057"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 21089505,
							""CONCEPT_NAME"" : ""fluticasone / formoterol Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP357047"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40144020,
							""CONCEPT_NAME"" : ""fluticasone / salmeterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""746717"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36882733,
							""CONCEPT_NAME"" : ""fluticasone / salmeterol Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP994600"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 42482744,
							""CONCEPT_NAME"" : ""fluticasone / salmeterol Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP419713"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40144024,
							""CONCEPT_NAME"" : ""fluticasone / salmeterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""744485"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37592046,
							""CONCEPT_NAME"" : ""fluticasone / vilanterol / vilanterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4781501"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 43532281,
							""CONCEPT_NAME"" : ""fluticasone / vilanterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1424887"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 43291091,
							""CONCEPT_NAME"" : ""fluticasone / vilanterol Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP557209"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 41267401,
							""CONCEPT_NAME"" : ""fluticasone / vilanterol Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2465363"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40144035,
							""CONCEPT_NAME"" : ""fluticasone Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""746765"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35147990,
							""CONCEPT_NAME"" : ""fluticasone Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4805056"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35149212,
							""CONCEPT_NAME"" : ""fluticasone Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4806270"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40144037,
							""CONCEPT_NAME"" : ""fluticasone Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""746403"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40223712,
							""CONCEPT_NAME"" : ""formoterol / Mometasone Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""998040"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 42629522,
							""CONCEPT_NAME"" : ""formoterol / glycopyrronium Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1790637"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 42480849,
							""CONCEPT_NAME"" : ""formoterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP419273"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356191,
							""CONCEPT_NAME"" : ""formoterol Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108402"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356187,
							""CONCEPT_NAME"" : ""formoterol Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108395"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44107471,
							""CONCEPT_NAME"" : ""formoterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP1102102"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 43145868,
							""CONCEPT_NAME"" : ""glycopyrronium / indacaterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP448437"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 43259954,
							""CONCEPT_NAME"" : ""glycopyrronium / indacaterol Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP573715"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356196,
							""CONCEPT_NAME"" : ""glycopyrronium / indacaterol Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108413"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35145836,
							""CONCEPT_NAME"" : ""glycopyrronium / indacaterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4802923"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 42479568,
							""CONCEPT_NAME"" : ""indacaterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP418726"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356211,
							""CONCEPT_NAME"" : ""indacaterol Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108445"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44055847,
							""CONCEPT_NAME"" : ""indacaterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP1050478"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44081467,
							""CONCEPT_NAME"" : ""metaproterenol Gas for Inhalation"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP1076098"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356120,
							""CONCEPT_NAME"" : ""metaproterenol Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108252"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40182262,
							""CONCEPT_NAME"" : ""metaproterenol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""979330"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40746100,
							""CONCEPT_NAME"" : ""olodaterol Inhalant Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4711602"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 21174574,
							""CONCEPT_NAME"" : ""olodaterol Inhalant Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP275394"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 45775117,
							""CONCEPT_NAME"" : ""olodaterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1546062"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 41205378,
							""CONCEPT_NAME"" : ""pirbuterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP2403340"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40152687,
							""CONCEPT_NAME"" : ""pirbuterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""801916"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40167702,
							""CONCEPT_NAME"" : ""salmeterol Dry Powder Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""866043"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35158799,
							""CONCEPT_NAME"" : ""salmeterol Inhalation Powder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4815788"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 783089,
							""CONCEPT_NAME"" : ""salmeterol Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4830921"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1356189,
							""CONCEPT_NAME"" : ""salmeterol Metered Dose Inhaler"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2108399"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35152712,
							""CONCEPT_NAME"" : ""trimetoquinol hydrochloride hydrate Inhalation Solution"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4809745"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Clinical Drug Form""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""First""
	},
	""ExpressionLimit"" : {
		""Type"" : ""First""
	},
	""InclusionRules"" : [
		{
			""name"" : ""No COPD prior"",
			""expression"" : {
				""Type"" : ""ALL"",
				""CriteriaList"" : [
					{
						""Criteria"" : {
							""ConditionOccurrence"" : {
								""CodesetId"" : 2,
								""ConditionTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 0,
								""Coeff"" : 1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : false,
						""Occurrence"" : {
							""Type"" : 0,
							""Count"" : 0,
							""IsDistinct"" : false
						}
					},
					{
						""Criteria"" : {
							""DrugExposure"" : {
								""CodesetId"" : 3,
								""DrugTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 0,
								""Coeff"" : 1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : false,
						""Occurrence"" : {
							""Type"" : 0,
							""Count"" : 0,
							""IsDistinct"" : false
						}
					}
				],
				""DemographicCriteriaList"" : [],
				""Groups"" : []
			}
		}
	],
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 0
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 0 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (317009,4235703,4279553)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (317009,4235703,4279553)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 2 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (255573,258780)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (255573,258780)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 3 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (21603292)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (21603292)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 4 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (42483138,36812530,40727741,1356123,40142665,46234463,1356111,1356108,40142703,21603292,41143395,36421291,40745353,36787954,21158944,36894458,21090035,36883710,35130061,40142784,42479684,35133500,783228,40142910,36787269,1356143,35135829,1356140,44120754,41205832,40924271,40986621,40830666,41205663,40861866,43274335,43263324,43621601,1356154,1356147,40143105,41080205,41174344,41111516,1356173,1356180,40144087,43134418,40727834,36811735,40861768,40727839,35150375,44081619,1356217,1356215,1356101,42800913,40143326,36894464,44817882,40143337,42941603,35146684,35160199,44029688,42481922,36813480,36812414,1356244,40143708,21150787,44082127,41206083,1356138,1356136,40152662,40156382,41048760,40754973,21089505,40144020,36882733,42482744,40144024,37592046,43532281,43291091,41267401,40144035,35147990,35149212,40144037,40223712,42629522,42480849,1356191,1356187,44107471,43145868,43259954,1356196,35145836,42479568,1356211,44055847,44081467,1356120,40182262,40746100,21174574,45775117,41205378,40152687,40167702,35158799,783089,1356189,35152712)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (42483138,36812530,40727741,1356123,40142665,46234463,1356111,1356108,40142703,21603292,41143395,36421291,40745353,36787954,21158944,36894458,21090035,36883710,35130061,40142784,42479684,35133500,783228,40142910,36787269,1356143,35135829,1356140,44120754,41205832,40924271,40986621,40830666,41205663,40861866,43274335,43263324,43621601,1356154,1356147,40143105,41080205,41174344,41111516,1356173,1356180,40144087,43134418,40727834,36811735,40861768,40727839,35150375,44081619,1356217,1356215,1356101,42800913,40143326,36894464,44817882,40143337,42941603,35146684,35160199,44029688,42481922,36813480,36812414,1356244,40143708,21150787,44082127,41206083,1356138,1356136,40152662,40156382,41048760,40754973,21089505,40144020,36882733,42482744,40144024,37592046,43532281,43291091,41267401,40144035,35147990,35149212,40144037,40223712,42629522,42480849,1356191,1356187,44107471,43145868,43259954,1356196,35145836,42479568,1356211,44055847,44081467,1356120,40182262,40746100,21174574,45775117,41205378,40152687,40167702,35158799,783089,1356189,35152712)
  and c.invalid_reason is null

) I
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  select PE.person_id, PE.event_id, PE.start_date, PE.end_date, PE.visit_occurrence_id, PE.sort_date FROM (
-- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.DRUG_EXPOSURE_END_DATE, DATEADD(day,C.DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,C.DRUG_EXPOSURE_START_DATE)) as end_date,
       C.visit_occurrence_id,C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets cs on (de.drug_concept_id = cs.concept_id and cs.codeset_id = 4)
) C
JOIN @cdm_database_schema.PERSON P on C.person_id = P.person_id
WHERE YEAR(C.drug_exposure_start_date) - P.year_of_birth < 55
-- End Drug Exposure Criteria

) PE
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.DRUG_EXPOSURE_END_DATE, DATEADD(day,C.DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,C.DRUG_EXPOSURE_START_DATE)) as end_date,
       C.visit_occurrence_id,C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets cs on (de.drug_concept_id = cs.concept_id and cs.codeset_id = 4)
) C
JOIN @cdm_database_schema.PERSON P on C.person_id = P.person_id
WHERE YEAR(C.drug_exposure_start_date) - P.year_of_birth < 55
-- End Drug Exposure Criteria
) Q
JOIN @cdm_database_schema.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.DRUG_EXPOSURE_END_DATE, DATEADD(day,C.DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,C.DRUG_EXPOSURE_START_DATE)) as end_date,
       C.visit_occurrence_id,C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets cs on (de.drug_concept_id = cs.concept_id and cs.codeset_id = 4)
) C
JOIN @cdm_database_schema.PERSON P on C.person_id = P.person_id
WHERE YEAR(C.drug_exposure_start_date) - P.year_of_birth < 55
-- End Drug Exposure Criteria
) Q
JOIN @cdm_database_schema.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) P
JOIN (
  -- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.DRUG_EXPOSURE_END_DATE, DATEADD(day,C.DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,C.DRUG_EXPOSURE_START_DATE)) as end_date,
       C.visit_occurrence_id,C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets cs on (de.drug_concept_id = cs.concept_id and cs.codeset_id = 4)
) C


-- End Drug Exposure Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,-365,P.START_DATE) AND A.START_DATE <= DATEADD(day,-180,P.START_DATE) ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id and AC.event_id = pe.event_id

UNION ALL
-- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 0)
) C


-- End Condition Occurrence Criteria

UNION ALL
-- Begin Observation Criteria
select C.person_id, C.observation_id as event_id, C.observation_date as start_date, DATEADD(d,1,C.observation_date) as END_DATE,
       C.visit_occurrence_id, C.observation_date as sort_date
from 
(
  select o.* 
  FROM @cdm_database_schema.OBSERVATION o
JOIN #Codesets cs on (o.observation_concept_id = cs.concept_id and cs.codeset_id = 0)
) C


-- End Observation Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P
WHERE P.ordinal = 1
-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

select 0 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_0
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 2)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= DATEADD(day,0,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

UNION ALL
-- Begin Correlated Criteria
select 1 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.DRUG_EXPOSURE_END_DATE, DATEADD(day,C.DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,C.DRUG_EXPOSURE_START_DATE)) as end_date,
       C.visit_occurrence_id,C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets cs on (de.drug_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Drug Exposure Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= DATEADD(day,0,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 2
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

SELECT inclusion_rule_id, person_id, event_id
INTO #inclusion_events
FROM (select inclusion_rule_id, person_id, event_id from #Inclusion_0) I;
TRUNCATE TABLE #Inclusion_0;
DROP TABLE #Inclusion_0;


select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

  -- the matching group with all bits set ( POWER(2,# of inclusion rules) - 1 = inclusion_rule_mask
  WHERE (MG.inclusion_rule_mask = POWER(cast(2 as bigint),1)-1)

) Results
WHERE Results.ordinal = 1
;



-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- By default, cohort exit at the event's op end date
select event_id, person_id, op_end_date as end_date from #included_events
    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 0, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,0,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



-- Create a temp table of inclusion rule rows for joining in the inclusion rule impact analysis

select cast(rule_sequence as int) as rule_sequence
into #inclusion_rules
from (
  SELECT CAST(0 as int) as rule_sequence
) IR;


-- Find the event that is the 'best match' per person.  
-- the 'best match' is defined as the event that satisfies the most inclusion rules.
-- ties are solved by choosing the event that matches the earliest inclusion rule, and then earliest.

select q.person_id, q.event_id
into #best_events
from #qualified_events Q
join (
	SELECT R.person_id, R.event_id, ROW_NUMBER() OVER (PARTITION BY R.person_id ORDER BY R.rule_count DESC,R.min_rule_id ASC, R.start_date ASC) AS rank_value
	FROM (
		SELECT Q.person_id, Q.event_id, COALESCE(COUNT(DISTINCT I.inclusion_rule_id), 0) AS rule_count, COALESCE(MIN(I.inclusion_rule_id), 0) AS min_rule_id, Q.start_date
		FROM #qualified_events Q
		LEFT JOIN #inclusion_events I ON q.person_id = i.person_id AND q.event_id = i.event_id
		GROUP BY Q.person_id, Q.event_id, Q.start_date
	) R
) ranked on Q.person_id = ranked.person_id and Q.event_id = ranked.event_id
WHERE ranked.rank_value = 1
;

-- modes of generation: (the same tables store the results for the different modes, identified by the mode_id column)
-- 0: all events
-- 1: best event


-- BEGIN: Inclusion Impact Analysis - event
-- calculte matching group counts
delete from @results_database_schema.cohort_inclusion_result where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_inclusion_result (cohort_definition_id, inclusion_rule_mask, person_count, mode_id)
select @target_cohort_id as cohort_definition_id, inclusion_rule_mask, count_big(*) as person_count, 0 as mode_id
from
(
  select Q.person_id, Q.event_id, CAST(SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) AS bigint) as inclusion_rule_mask
  from #qualified_events Q
  LEFT JOIN #inclusion_events I on q.person_id = i.person_id and q.event_id = i.event_id
  GROUP BY Q.person_id, Q.event_id
) MG -- matching groups
group by inclusion_rule_mask
;

-- calculate gain counts 
delete from @results_database_schema.cohort_inclusion_stats where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_inclusion_stats (cohort_definition_id, rule_sequence, person_count, gain_count, person_total, mode_id)
select @target_cohort_id as cohort_definition_id, ir.rule_sequence, coalesce(T.person_count, 0) as person_count, coalesce(SR.person_count, 0) gain_count, EventTotal.total, 0 as mode_id
from #inclusion_rules ir
left join
(
  select i.inclusion_rule_id, count_big(i.event_id) as person_count
  from #qualified_events Q
  JOIN #inclusion_events i on Q.person_id = I.person_id and Q.event_id = i.event_id
  group by i.inclusion_rule_id
) T on ir.rule_sequence = T.inclusion_rule_id
CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
CROSS JOIN (select count_big(event_id) as total from #qualified_events) EventTotal
LEFT JOIN @results_database_schema.cohort_inclusion_result SR on SR.mode_id = 0 AND SR.cohort_definition_id = @target_cohort_id AND (POWER(cast(2 as bigint),RuleTotal.total_rules) - POWER(cast(2 as bigint),ir.rule_sequence) - 1) = SR.inclusion_rule_mask -- POWER(2,rule count) - POWER(2,rule sequence) - 1 is the mask for 'all except this rule'
;

-- calculate totals
delete from @results_database_schema.cohort_summary_stats where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_summary_stats (cohort_definition_id, base_count, final_count, mode_id)
select @target_cohort_id as cohort_definition_id, PC.total as person_count, coalesce(FC.total, 0) as final_count, 0 as mode_id
FROM
(select count_big(event_id) as total from #qualified_events) PC,
(select sum(sr.person_count) as total
  from @results_database_schema.cohort_inclusion_result sr
  CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
  where sr.mode_id = 0 and sr.cohort_definition_id = @target_cohort_id and sr.inclusion_rule_mask = POWER(cast(2 as bigint),RuleTotal.total_rules)-1
) FC
;

-- END: Inclusion Impact Analysis - event

-- BEGIN: Inclusion Impact Analysis - person
-- calculte matching group counts
delete from @results_database_schema.cohort_inclusion_result where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_inclusion_result (cohort_definition_id, inclusion_rule_mask, person_count, mode_id)
select @target_cohort_id as cohort_definition_id, inclusion_rule_mask, count_big(*) as person_count, 1 as mode_id
from
(
  select Q.person_id, Q.event_id, CAST(SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) AS bigint) as inclusion_rule_mask
  from #best_events Q
  LEFT JOIN #inclusion_events I on q.person_id = i.person_id and q.event_id = i.event_id
  GROUP BY Q.person_id, Q.event_id
) MG -- matching groups
group by inclusion_rule_mask
;

-- calculate gain counts 
delete from @results_database_schema.cohort_inclusion_stats where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_inclusion_stats (cohort_definition_id, rule_sequence, person_count, gain_count, person_total, mode_id)
select @target_cohort_id as cohort_definition_id, ir.rule_sequence, coalesce(T.person_count, 0) as person_count, coalesce(SR.person_count, 0) gain_count, EventTotal.total, 1 as mode_id
from #inclusion_rules ir
left join
(
  select i.inclusion_rule_id, count_big(i.event_id) as person_count
  from #best_events Q
  JOIN #inclusion_events i on Q.person_id = I.person_id and Q.event_id = i.event_id
  group by i.inclusion_rule_id
) T on ir.rule_sequence = T.inclusion_rule_id
CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
CROSS JOIN (select count_big(event_id) as total from #best_events) EventTotal
LEFT JOIN @results_database_schema.cohort_inclusion_result SR on SR.mode_id = 1 AND SR.cohort_definition_id = @target_cohort_id AND (POWER(cast(2 as bigint),RuleTotal.total_rules) - POWER(cast(2 as bigint),ir.rule_sequence) - 1) = SR.inclusion_rule_mask -- POWER(2,rule count) - POWER(2,rule sequence) - 1 is the mask for 'all except this rule'
;

-- calculate totals
delete from @results_database_schema.cohort_summary_stats where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_summary_stats (cohort_definition_id, base_count, final_count, mode_id)
select @target_cohort_id as cohort_definition_id, PC.total as person_count, coalesce(FC.total, 0) as final_count, 1 as mode_id
FROM
(select count_big(event_id) as total from #best_events) PC,
(select sum(sr.person_count) as total
  from @results_database_schema.cohort_inclusion_result sr
  CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
  where sr.mode_id = 1 and sr.cohort_definition_id = @target_cohort_id and sr.inclusion_rule_mask = POWER(cast(2 as bigint),RuleTotal.total_rules)-1
) FC
;

-- END: Inclusion Impact Analysis - person

TRUNCATE TABLE #best_events;
DROP TABLE #best_events;

TRUNCATE TABLE #inclusion_rules;
DROP TABLE #inclusion_rules;




TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",27,FALSE,
30,"[P] Tuberculosis (FP)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 7,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""ConceptSets"" : [
		{
			""id"" : 6,
			""name"" : ""All TB drugs"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 43012518,
							""CONCEPT_NAME"" : ""bedaquiline"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1364504"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1836191,
							""CONCEPT_NAME"" : ""Streptomycin"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""10109"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1782521,
							""CONCEPT_NAME"" : ""isoniazid"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""6038"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1763204,
							""CONCEPT_NAME"" : ""Rifampin"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""9384"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1749301,
							""CONCEPT_NAME"" : ""Ethambutol"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""4110"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1759455,
							""CONCEPT_NAME"" : ""Pyrazinamide"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""8987"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1777417,
							""CONCEPT_NAME"" : ""Rifabutin"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""55672"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 19035953,
							""CONCEPT_NAME"" : ""rifapentine"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""35617"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1710446,
							""CONCEPT_NAME"" : ""Cycloserine"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""3007"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1750074,
							""CONCEPT_NAME"" : ""Ethionamide"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""4127"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1726228,
							""CONCEPT_NAME"" : ""aminosalicylic acid"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""7833"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 19078424,
							""CONCEPT_NAME"" : ""terizidone"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""57047"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 19135812,
							""CONCEPT_NAME"" : ""Prothionamide"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""8871"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 19010337,
							""CONCEPT_NAME"" : ""aminosalicylate"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""113374"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 19026710,
							""CONCEPT_NAME"" : ""Capreomycin"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""78903"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1742253,
							""CONCEPT_NAME"" : ""Levofloxacin"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""82122"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1716903,
							""CONCEPT_NAME"" : ""moxifloxacin"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""139462"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1736887,
							""CONCEPT_NAME"" : ""linezolid"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""190376"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1798476,
							""CONCEPT_NAME"" : ""Clofazimine"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2592"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36879076,
							""CONCEPT_NAME"" : ""Delamanid"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP994306"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1797258,
							""CONCEPT_NAME"" : ""Cilastatin"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""2540"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1778262,
							""CONCEPT_NAME"" : ""Imipenem"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""5690"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1709170,
							""CONCEPT_NAME"" : ""meropenem"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""29561"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1790868,
							""CONCEPT_NAME"" : ""Amikacin"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""641"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 7,
			""name"" : ""Respiratory and pulmonary tuberculosis"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 45771090,
							""CONCEPT_NAME"" : ""Respiratory tuberculosis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""700272008"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4112923,
							""CONCEPT_NAME"" : ""Pleurisy without effusion or active tuberculosis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""196076002"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4090539,
							""CONCEPT_NAME"" : ""Tuberculous pleurisy, confirmed bacteriologically and histologically"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""186200004"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 258675,
							""CONCEPT_NAME"" : ""Tuberculous pleurisy in primary progressive tuberculosis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""186172004"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 432541,
							""CONCEPT_NAME"" : ""Primary tuberculosis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""63309002"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 434557,
							""CONCEPT_NAME"" : ""Tuberculosis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""56717001"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""First""
	},
	""ExpressionLimit"" : {
		""Type"" : ""First""
	},
	""InclusionRules"" : [
		{
			""name"" : ""At least 3 distinct drug eras of TB drugs"",
			""expression"" : {
				""Type"" : ""ANY"",
				""CriteriaList"" : [
					{
						""Criteria"" : {
							""DrugEra"" : {
								""CodesetId"" : 6
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Days"" : 0,
								""Coeff"" : -1
							},
							""End"" : {
								""Coeff"" : 1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : false,
						""Occurrence"" : {
							""Type"" : 2,
							""Count"" : 3,
							""IsDistinct"" : true,
							""CountColumn"" : ""DOMAIN_CONCEPT""
						}
					}
				],
				""DemographicCriteriaList"" : [],
				""Groups"" : []
			}
		}
	],
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 0
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 6 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (43012518,1836191,1782521,1763204,1749301,1759455,1777417,19035953,1710446,1750074,1726228,19078424,19135812,19010337,19026710,1742253,1716903,1736887,1798476,36879076,1797258,1778262,1709170,1790868)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (43012518,1836191,1782521,1763204,1749301,1759455,1777417,19035953,1710446,1750074,1726228,19078424,19135812,19010337,19026710,1742253,1716903,1736887,1798476,36879076,1797258,1778262,1709170,1790868)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 7 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (45771090,4112923,4090539,258675,432541,434557)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (45771090,4112923,4090539,258675,432541)
  and c.invalid_reason is null

) I
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 7)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

select 0 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_0
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id , A.domain_concept_id
FROM #qualified_events P
JOIN (
  -- Begin Drug Era Criteria
select C.person_id, C.drug_era_id as event_id, C.drug_era_start_date as start_date, C.drug_era_end_date as end_date,
    CAST(NULL as bigint) as visit_occurrence_id,C.drug_era_start_date as sort_date, C.drug_concept_id as domain_concept_id
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_ERA de
where de.drug_concept_id in (SELECT concept_id from  #Codesets where codeset_id = 6)
) C


-- End Drug Era Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= DATEADD(day,0,P.START_DATE) AND A.START_DATE <= P.OP_END_DATE ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(DISTINCT cc.domain_concept_id) >= 3
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) > 0
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

SELECT inclusion_rule_id, person_id, event_id
INTO #inclusion_events
FROM (select inclusion_rule_id, person_id, event_id from #Inclusion_0) I;
TRUNCATE TABLE #Inclusion_0;
DROP TABLE #Inclusion_0;


select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

  -- the matching group with all bits set ( POWER(2,# of inclusion rules) - 1 = inclusion_rule_mask
  WHERE (MG.inclusion_rule_mask = POWER(cast(2 as bigint),1)-1)

) Results
WHERE Results.ordinal = 1
;



-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- By default, cohort exit at the event's op end date
select event_id, person_id, op_end_date as end_date from #included_events
    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 0, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,0,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



-- Create a temp table of inclusion rule rows for joining in the inclusion rule impact analysis

select cast(rule_sequence as int) as rule_sequence
into #inclusion_rules
from (
  SELECT CAST(0 as int) as rule_sequence
) IR;


-- Find the event that is the 'best match' per person.  
-- the 'best match' is defined as the event that satisfies the most inclusion rules.
-- ties are solved by choosing the event that matches the earliest inclusion rule, and then earliest.

select q.person_id, q.event_id
into #best_events
from #qualified_events Q
join (
	SELECT R.person_id, R.event_id, ROW_NUMBER() OVER (PARTITION BY R.person_id ORDER BY R.rule_count DESC,R.min_rule_id ASC, R.start_date ASC) AS rank_value
	FROM (
		SELECT Q.person_id, Q.event_id, COALESCE(COUNT(DISTINCT I.inclusion_rule_id), 0) AS rule_count, COALESCE(MIN(I.inclusion_rule_id), 0) AS min_rule_id, Q.start_date
		FROM #qualified_events Q
		LEFT JOIN #inclusion_events I ON q.person_id = i.person_id AND q.event_id = i.event_id
		GROUP BY Q.person_id, Q.event_id, Q.start_date
	) R
) ranked on Q.person_id = ranked.person_id and Q.event_id = ranked.event_id
WHERE ranked.rank_value = 1
;

-- modes of generation: (the same tables store the results for the different modes, identified by the mode_id column)
-- 0: all events
-- 1: best event


-- BEGIN: Inclusion Impact Analysis - event
-- calculte matching group counts
delete from @results_database_schema.cohort_inclusion_result where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_inclusion_result (cohort_definition_id, inclusion_rule_mask, person_count, mode_id)
select @target_cohort_id as cohort_definition_id, inclusion_rule_mask, count_big(*) as person_count, 0 as mode_id
from
(
  select Q.person_id, Q.event_id, CAST(SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) AS bigint) as inclusion_rule_mask
  from #qualified_events Q
  LEFT JOIN #inclusion_events I on q.person_id = i.person_id and q.event_id = i.event_id
  GROUP BY Q.person_id, Q.event_id
) MG -- matching groups
group by inclusion_rule_mask
;

-- calculate gain counts 
delete from @results_database_schema.cohort_inclusion_stats where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_inclusion_stats (cohort_definition_id, rule_sequence, person_count, gain_count, person_total, mode_id)
select @target_cohort_id as cohort_definition_id, ir.rule_sequence, coalesce(T.person_count, 0) as person_count, coalesce(SR.person_count, 0) gain_count, EventTotal.total, 0 as mode_id
from #inclusion_rules ir
left join
(
  select i.inclusion_rule_id, count_big(i.event_id) as person_count
  from #qualified_events Q
  JOIN #inclusion_events i on Q.person_id = I.person_id and Q.event_id = i.event_id
  group by i.inclusion_rule_id
) T on ir.rule_sequence = T.inclusion_rule_id
CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
CROSS JOIN (select count_big(event_id) as total from #qualified_events) EventTotal
LEFT JOIN @results_database_schema.cohort_inclusion_result SR on SR.mode_id = 0 AND SR.cohort_definition_id = @target_cohort_id AND (POWER(cast(2 as bigint),RuleTotal.total_rules) - POWER(cast(2 as bigint),ir.rule_sequence) - 1) = SR.inclusion_rule_mask -- POWER(2,rule count) - POWER(2,rule sequence) - 1 is the mask for 'all except this rule'
;

-- calculate totals
delete from @results_database_schema.cohort_summary_stats where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_summary_stats (cohort_definition_id, base_count, final_count, mode_id)
select @target_cohort_id as cohort_definition_id, PC.total as person_count, coalesce(FC.total, 0) as final_count, 0 as mode_id
FROM
(select count_big(event_id) as total from #qualified_events) PC,
(select sum(sr.person_count) as total
  from @results_database_schema.cohort_inclusion_result sr
  CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
  where sr.mode_id = 0 and sr.cohort_definition_id = @target_cohort_id and sr.inclusion_rule_mask = POWER(cast(2 as bigint),RuleTotal.total_rules)-1
) FC
;

-- END: Inclusion Impact Analysis - event

-- BEGIN: Inclusion Impact Analysis - person
-- calculte matching group counts
delete from @results_database_schema.cohort_inclusion_result where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_inclusion_result (cohort_definition_id, inclusion_rule_mask, person_count, mode_id)
select @target_cohort_id as cohort_definition_id, inclusion_rule_mask, count_big(*) as person_count, 1 as mode_id
from
(
  select Q.person_id, Q.event_id, CAST(SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) AS bigint) as inclusion_rule_mask
  from #best_events Q
  LEFT JOIN #inclusion_events I on q.person_id = i.person_id and q.event_id = i.event_id
  GROUP BY Q.person_id, Q.event_id
) MG -- matching groups
group by inclusion_rule_mask
;

-- calculate gain counts 
delete from @results_database_schema.cohort_inclusion_stats where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_inclusion_stats (cohort_definition_id, rule_sequence, person_count, gain_count, person_total, mode_id)
select @target_cohort_id as cohort_definition_id, ir.rule_sequence, coalesce(T.person_count, 0) as person_count, coalesce(SR.person_count, 0) gain_count, EventTotal.total, 1 as mode_id
from #inclusion_rules ir
left join
(
  select i.inclusion_rule_id, count_big(i.event_id) as person_count
  from #best_events Q
  JOIN #inclusion_events i on Q.person_id = I.person_id and Q.event_id = i.event_id
  group by i.inclusion_rule_id
) T on ir.rule_sequence = T.inclusion_rule_id
CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
CROSS JOIN (select count_big(event_id) as total from #best_events) EventTotal
LEFT JOIN @results_database_schema.cohort_inclusion_result SR on SR.mode_id = 1 AND SR.cohort_definition_id = @target_cohort_id AND (POWER(cast(2 as bigint),RuleTotal.total_rules) - POWER(cast(2 as bigint),ir.rule_sequence) - 1) = SR.inclusion_rule_mask -- POWER(2,rule count) - POWER(2,rule sequence) - 1 is the mask for 'all except this rule'
;

-- calculate totals
delete from @results_database_schema.cohort_summary_stats where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_summary_stats (cohort_definition_id, base_count, final_count, mode_id)
select @target_cohort_id as cohort_definition_id, PC.total as person_count, coalesce(FC.total, 0) as final_count, 1 as mode_id
FROM
(select count_big(event_id) as total from #best_events) PC,
(select sum(sr.person_count) as total
  from @results_database_schema.cohort_inclusion_result sr
  CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
  where sr.mode_id = 1 and sr.cohort_definition_id = @target_cohort_id and sr.inclusion_rule_mask = POWER(cast(2 as bigint),RuleTotal.total_rules)-1
) FC
;

-- END: Inclusion Impact Analysis - person

TRUNCATE TABLE #best_events;
DROP TABLE #best_events;

TRUNCATE TABLE #inclusion_rules;
DROP TABLE #inclusion_rules;




TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",30,FALSE,
33,"[P] Dementia (FP)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 0,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""First""
		}
	},
	""ConceptSets"" : [
		{
			""id"" : 0,
			""name"" : ""Dementia"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 37312036,
							""CONCEPT_NAME"" : ""Aggression due to dementia"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""788861009"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37312035,
							""CONCEPT_NAME"" : ""Agitation due to dementia"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""788862002"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4041685,
							""CONCEPT_NAME"" : ""Amyotrophic lateral sclerosis with dementia"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""230258005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37312031,
							""CONCEPT_NAME"" : ""Anxiety due to dementia"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""788866004"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37312030,
							""CONCEPT_NAME"" : ""Apathetic behaviour due to dementia"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""788867008"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 35608576,
							""CONCEPT_NAME"" : ""Behavioral and psychological symptoms of dementia"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""10171000132106"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4092747,
							""CONCEPT_NAME"" : ""Cerebral degeneration presenting primarily with dementia"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""279982005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4182210,
							""CONCEPT_NAME"" : ""Dementia"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""52448006"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37116464,
							""CONCEPT_NAME"" : ""Dementia caused by heavy metal exposure"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""733184002"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37017549,
							""CONCEPT_NAME"" : ""Dementia co-occurrent with human immunodeficiency virus infection"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""713844000"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4244346,
							""CONCEPT_NAME"" : ""Dialysis dementia"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""9345005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37311665,
							""CONCEPT_NAME"" : ""Disinhibited behaviour due to dementia"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""789170003"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4043378,
							""CONCEPT_NAME"" : ""Frontotemporal dementia"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""230270009"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 45765480,
							""CONCEPT_NAME"" : ""Frontotemporal dementia with parkinsonism-17"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""702429008"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 45765477,
							""CONCEPT_NAME"" : ""GRN-related frontotemporal dementia"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""702426001"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 377788,
							""CONCEPT_NAME"" : ""General paresis - neurosyphilis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""51928006"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 372610,
							""CONCEPT_NAME"" : ""Postconcussion syndrome"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""40425004"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37017247,
							""CONCEPT_NAME"" : ""Presenile dementia co-occurrent with human immunodeficiency virus infection"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""713488003"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37311890,
							""CONCEPT_NAME"" : ""Psychological symptom due to dementia"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""789011007"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37312577,
							""CONCEPT_NAME"" : ""Wandering due to dementia"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""789062005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4059191,
							""CONCEPT_NAME"" : ""H/O: dementia"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""161465002"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Context-dependent""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""First""
	},
	""ExpressionLimit"" : {
		""Type"" : ""First""
	},
	""InclusionRules"" : [],
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 0
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 0 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (37312036,37312035,4041685,37312031,37312030,35608576,4092747,4182210,37311665,4043378,45765480,45765477,37311890,37312577,4059191)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (37312036,37312035,4041685,37312031,37312030,35608576,4092747,4182210,37311665,4043378,45765480,45765477,37311890,37312577,4059191)
  and c.invalid_reason is null

) I
LEFT JOIN
(
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (37116464,37017549,4244346,377788,372610,37017247)

) E ON I.concept_id = E.concept_id
WHERE E.concept_id is null
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 0)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P
WHERE P.ordinal = 1
-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

) Results
WHERE Results.ordinal = 1
;



-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- By default, cohort exit at the event's op end date
select event_id, person_id, op_end_date as end_date from #included_events
    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 0, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,0,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats





TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",33,FALSE,
68,"[W] Heart failure with inpatient admission (3Pe, 30Era)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 8,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""AdditionalCriteria"" : {
		""Type"" : ""ANY"",
		""CriteriaList"" : [
			{
				""Criteria"" : {
					""VisitOccurrence"" : {
						""CodesetId"" : 2,
						""VisitTypeExclude"" : false
					}
				},
				""StartWindow"" : {
					""Start"" : {
						""Coeff"" : -1
					},
					""End"" : {
						""Days"" : 0,
						""Coeff"" : 1
					},
					""UseIndexEnd"" : false,
					""UseEventEnd"" : false
				},
				""EndWindow"" : {
					""Start"" : {
						""Days"" : 0,
						""Coeff"" : -1
					},
					""End"" : {
						""Coeff"" : 1
					},
					""UseIndexEnd"" : false,
					""UseEventEnd"" : true
				},
				""RestrictVisit"" : false,
				""IgnoreObservationPeriod"" : false,
				""Occurrence"" : {
					""Type"" : 2,
					""Count"" : 1,
					""IsDistinct"" : false
				}
			}
		],
		""DemographicCriteriaList"" : [],
		""Groups"" : []
	},
	""ConceptSets"" : [
		{
			""id"" : 2,
			""name"" : ""Inpatient or ER visit"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 262,
							""CONCEPT_NAME"" : ""Emergency Room and Inpatient Visit"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""ERIP"",
							""DOMAIN_ID"" : ""Visit"",
							""VOCABULARY_ID"" : ""Visit"",
							""CONCEPT_CLASS_ID"" : ""Visit""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 9203,
							""CONCEPT_NAME"" : ""Emergency Room Visit"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""ER"",
							""DOMAIN_ID"" : ""Visit"",
							""VOCABULARY_ID"" : ""Visit"",
							""CONCEPT_CLASS_ID"" : ""Visit""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 9201,
							""CONCEPT_NAME"" : ""Inpatient Visit"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""IP"",
							""DOMAIN_ID"" : ""Visit"",
							""VOCABULARY_ID"" : ""Visit"",
							""CONCEPT_CLASS_ID"" : ""Visit""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 8,
			""name"" : ""Heart Failure"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 315295,
							""CONCEPT_NAME"" : ""Congestive rheumatic heart failure"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""82523003"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 316139,
							""CONCEPT_NAME"" : ""Heart failure"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""84114007"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""All""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""EndDate"",
			""Offset"" : 3
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 30
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 2 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (262,9203,9201)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (262,9203,9201)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 8 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (316139)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (316139)
  and c.invalid_reason is null

) I
LEFT JOIN
(
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (315295)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (315295)
  and c.invalid_reason is null

) E ON I.concept_id = E.concept_id
WHERE E.concept_id is null
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 8)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 8)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 8)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) P
JOIN (
  -- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_occurrence_id, C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM @cdm_database_schema.VISIT_OCCURRENCE vo
JOIN #Codesets cs on (vo.visit_concept_id = cs.concept_id and cs.codeset_id = 2)
) C


-- End Visit Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= DATEADD(day,0,P.START_DATE) AND A.END_DATE >= DATEADD(day,0,P.START_DATE) AND A.END_DATE <= P.OP_END_DATE ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) > 0
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id and AC.event_id = pe.event_id

) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,3,end_date) > op_end_date then op_end_date else DATEADD(day,3,end_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 30, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,30,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",68,FALSE,
70,"[P] Stroke (ischemic or hemorrhagic) with inpatient admission (7Ps, 30Era)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 3,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""AdditionalCriteria"" : {
		""Type"" : ""ANY"",
		""CriteriaList"" : [
			{
				""Criteria"" : {
					""VisitOccurrence"" : {
						""CodesetId"" : 2,
						""VisitTypeExclude"" : false
					}
				},
				""StartWindow"" : {
					""Start"" : {
						""Coeff"" : -1
					},
					""End"" : {
						""Days"" : 1,
						""Coeff"" : 1
					},
					""UseIndexEnd"" : false,
					""UseEventEnd"" : false
				},
				""EndWindow"" : {
					""Start"" : {
						""Days"" : 0,
						""Coeff"" : -1
					},
					""End"" : {
						""Coeff"" : 1
					},
					""UseIndexEnd"" : false,
					""UseEventEnd"" : true
				},
				""RestrictVisit"" : false,
				""IgnoreObservationPeriod"" : false,
				""Occurrence"" : {
					""Type"" : 2,
					""Count"" : 1,
					""IsDistinct"" : false
				}
			}
		],
		""DemographicCriteriaList"" : [],
		""Groups"" : []
	},
	""ConceptSets"" : [
		{
			""id"" : 2,
			""name"" : ""Inpatient or ER visit"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 262,
							""CONCEPT_NAME"" : ""Emergency Room and Inpatient Visit"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""ERIP"",
							""DOMAIN_ID"" : ""Visit"",
							""VOCABULARY_ID"" : ""Visit"",
							""CONCEPT_CLASS_ID"" : ""Visit""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 9203,
							""CONCEPT_NAME"" : ""Emergency Room Visit"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""ER"",
							""DOMAIN_ID"" : ""Visit"",
							""VOCABULARY_ID"" : ""Visit"",
							""CONCEPT_CLASS_ID"" : ""Visit""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 9201,
							""CONCEPT_NAME"" : ""Inpatient Visit"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""IP"",
							""DOMAIN_ID"" : ""Visit"",
							""VOCABULARY_ID"" : ""Visit"",
							""CONCEPT_CLASS_ID"" : ""Visit""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 3,
			""name"" : ""Stroke (ischemic or hemorrhagic)"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 372924,
							""CONCEPT_NAME"" : ""Cerebral artery occlusion"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""20059004"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 375557,
							""CONCEPT_NAME"" : ""Cerebral embolism"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""75543006"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 376713,
							""CONCEPT_NAME"" : ""Cerebral hemorrhage"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""274100004"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 443454,
							""CONCEPT_NAME"" : ""Cerebral infarction"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""432504007"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 441874,
							""CONCEPT_NAME"" : ""Cerebral thrombosis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""71444005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 439847,
							""CONCEPT_NAME"" : ""Intracranial hemorrhage"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1386000"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 432923,
							""CONCEPT_NAME"" : ""Subarachnoid hemorrhage"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""21454007"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""All""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""StartDate"",
			""Offset"" : 7
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 180
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 2 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (262,9203,9201)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (262,9203,9201)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 3 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (372924,375557,376713,443454,441874,439847,432923)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (443454)
  and c.invalid_reason is null

) I
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) P
JOIN (
  -- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_occurrence_id, C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM @cdm_database_schema.VISIT_OCCURRENCE vo
JOIN #Codesets cs on (vo.visit_concept_id = cs.concept_id and cs.codeset_id = 2)
) C


-- End Visit Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= DATEADD(day,1,P.START_DATE) AND A.END_DATE >= DATEADD(day,0,P.START_DATE) AND A.END_DATE <= P.OP_END_DATE ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) > 0
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id and AC.event_id = pe.event_id

) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,7,start_date) > op_end_date then op_end_date else DATEADD(day,7,start_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 180, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,180,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",70,FALSE,
71,"[P] Acute myocardial infarction with inpatient admission (7Pe, 180Era)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 3,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""AdditionalCriteria"" : {
		""Type"" : ""ANY"",
		""CriteriaList"" : [
			{
				""Criteria"" : {
					""VisitOccurrence"" : {
						""CodesetId"" : 2,
						""VisitTypeExclude"" : false
					}
				},
				""StartWindow"" : {
					""Start"" : {
						""Coeff"" : -1
					},
					""End"" : {
						""Days"" : 0,
						""Coeff"" : 1
					},
					""UseIndexEnd"" : false,
					""UseEventEnd"" : false
				},
				""EndWindow"" : {
					""Start"" : {
						""Days"" : 0,
						""Coeff"" : -1
					},
					""End"" : {
						""Coeff"" : 1
					},
					""UseIndexEnd"" : false,
					""UseEventEnd"" : true
				},
				""RestrictVisit"" : false,
				""IgnoreObservationPeriod"" : false,
				""Occurrence"" : {
					""Type"" : 2,
					""Count"" : 1,
					""IsDistinct"" : false
				}
			}
		],
		""DemographicCriteriaList"" : [],
		""Groups"" : []
	},
	""ConceptSets"" : [
		{
			""id"" : 2,
			""name"" : ""Inpatient or ER visit"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 262,
							""CONCEPT_NAME"" : ""Emergency Room and Inpatient Visit"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""ERIP"",
							""DOMAIN_ID"" : ""Visit"",
							""VOCABULARY_ID"" : ""Visit"",
							""CONCEPT_CLASS_ID"" : ""Visit""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 9203,
							""CONCEPT_NAME"" : ""Emergency Room Visit"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""ER"",
							""DOMAIN_ID"" : ""Visit"",
							""VOCABULARY_ID"" : ""Visit"",
							""CONCEPT_CLASS_ID"" : ""Visit""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 9201,
							""CONCEPT_NAME"" : ""Inpatient Visit"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""IP"",
							""DOMAIN_ID"" : ""Visit"",
							""VOCABULARY_ID"" : ""Visit"",
							""CONCEPT_CLASS_ID"" : ""Visit""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 3,
			""name"" : ""Acute myocardial Infarction"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 4329847,
							""CONCEPT_NAME"" : ""Myocardial infarction"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""22298006"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 314666,
							""CONCEPT_NAME"" : ""Old myocardial infarction"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1755008"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""All""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""EndDate"",
			""Offset"" : 7
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 180
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 2 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (262,9203,9201)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (262,9203,9201)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 3 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4329847)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4329847)
  and c.invalid_reason is null

) I
LEFT JOIN
(
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (314666)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (314666)
  and c.invalid_reason is null

) E ON I.concept_id = E.concept_id
WHERE E.concept_id is null
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) P
JOIN (
  -- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_occurrence_id, C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM @cdm_database_schema.VISIT_OCCURRENCE vo
JOIN #Codesets cs on (vo.visit_concept_id = cs.concept_id and cs.codeset_id = 2)
) C


-- End Visit Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= DATEADD(day,0,P.START_DATE) AND A.END_DATE >= DATEADD(day,0,P.START_DATE) AND A.END_DATE <= P.OP_END_DATE ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) > 0
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id and AC.event_id = pe.event_id

) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,7,end_date) > op_end_date then op_end_date else DATEADD(day,7,end_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 180, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,180,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",71,FALSE,
72,"[P] Influenza diagnosis or positive test result (7Pe, 90Era)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 0,
					""ConditionTypeExclude"" : false
				}
			},
			{
				""Measurement"" : {
					""CodesetId"" : 1,
					""MeasurementTypeExclude"" : false
				}
			},
			{
				""Measurement"" : {
					""CodesetId"" : 2,
					""MeasurementTypeExclude"" : false,
					""ValueAsConcept"" : [
						{
							""CONCEPT_ID"" : 4126681,
							""CONCEPT_NAME"" : ""Detected"",
							""STANDARD_CONCEPT"" : null,
							""STANDARD_CONCEPT_CAPTION"" : ""Unknown"",
							""INVALID_REASON"" : null,
							""INVALID_REASON_CAPTION"" : ""Unknown"",
							""CONCEPT_CODE"" : ""260373001"",
							""DOMAIN_ID"" : ""Meas Value"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : null
						},
						{
							""CONCEPT_ID"" : 45877985,
							""CONCEPT_NAME"" : ""Detected"",
							""STANDARD_CONCEPT"" : null,
							""STANDARD_CONCEPT_CAPTION"" : ""Unknown"",
							""INVALID_REASON"" : null,
							""INVALID_REASON_CAPTION"" : ""Unknown"",
							""CONCEPT_CODE"" : ""LA11882-0"",
							""DOMAIN_ID"" : ""Meas Value"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : null
						},
						{
							""CONCEPT_ID"" : 9191,
							""CONCEPT_NAME"" : ""Positive"",
							""STANDARD_CONCEPT"" : null,
							""STANDARD_CONCEPT_CAPTION"" : ""Unknown"",
							""INVALID_REASON"" : null,
							""INVALID_REASON_CAPTION"" : ""Unknown"",
							""CONCEPT_CODE"" : ""10828004"",
							""DOMAIN_ID"" : ""Meas Value"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : null
						},
						{
							""CONCEPT_ID"" : 45884084,
							""CONCEPT_NAME"" : ""Positive"",
							""STANDARD_CONCEPT"" : null,
							""STANDARD_CONCEPT_CAPTION"" : ""Unknown"",
							""INVALID_REASON"" : null,
							""INVALID_REASON_CAPTION"" : ""Unknown"",
							""CONCEPT_CODE"" : ""LA6576-8"",
							""DOMAIN_ID"" : ""Meas Value"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : null
						},
						{
							""CONCEPT_ID"" : 4181412,
							""CONCEPT_NAME"" : ""Present"",
							""STANDARD_CONCEPT"" : null,
							""STANDARD_CONCEPT_CAPTION"" : ""Unknown"",
							""INVALID_REASON"" : null,
							""INVALID_REASON_CAPTION"" : ""Unknown"",
							""CONCEPT_CODE"" : ""52101004"",
							""DOMAIN_ID"" : ""Meas Value"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : null
						},
						{
							""CONCEPT_ID"" : 45879438,
							""CONCEPT_NAME"" : ""Present"",
							""STANDARD_CONCEPT"" : null,
							""STANDARD_CONCEPT_CAPTION"" : ""Unknown"",
							""INVALID_REASON"" : null,
							""INVALID_REASON_CAPTION"" : ""Unknown"",
							""CONCEPT_CODE"" : ""LA9633-4"",
							""DOMAIN_ID"" : ""Meas Value"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : null
						}
					]
				}
			},
			{
				""Observation"" : {
					""CodesetId"" : 2,
					""ObservationTypeExclude"" : false,
					""ValueAsConcept"" : [
						{
							""CONCEPT_ID"" : 4126681,
							""CONCEPT_NAME"" : ""Detected"",
							""STANDARD_CONCEPT"" : null,
							""STANDARD_CONCEPT_CAPTION"" : ""Unknown"",
							""INVALID_REASON"" : null,
							""INVALID_REASON_CAPTION"" : ""Unknown"",
							""CONCEPT_CODE"" : ""260373001"",
							""DOMAIN_ID"" : ""Meas Value"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : null
						},
						{
							""CONCEPT_ID"" : 45877985,
							""CONCEPT_NAME"" : ""Detected"",
							""STANDARD_CONCEPT"" : null,
							""STANDARD_CONCEPT_CAPTION"" : ""Unknown"",
							""INVALID_REASON"" : null,
							""INVALID_REASON_CAPTION"" : ""Unknown"",
							""CONCEPT_CODE"" : ""LA11882-0"",
							""DOMAIN_ID"" : ""Meas Value"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : null
						},
						{
							""CONCEPT_ID"" : 9191,
							""CONCEPT_NAME"" : ""Positive"",
							""STANDARD_CONCEPT"" : null,
							""STANDARD_CONCEPT_CAPTION"" : ""Unknown"",
							""INVALID_REASON"" : null,
							""INVALID_REASON_CAPTION"" : ""Unknown"",
							""CONCEPT_CODE"" : ""10828004"",
							""DOMAIN_ID"" : ""Meas Value"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : null
						},
						{
							""CONCEPT_ID"" : 45884084,
							""CONCEPT_NAME"" : ""Positive"",
							""STANDARD_CONCEPT"" : null,
							""STANDARD_CONCEPT_CAPTION"" : ""Unknown"",
							""INVALID_REASON"" : null,
							""INVALID_REASON_CAPTION"" : ""Unknown"",
							""CONCEPT_CODE"" : ""LA6576-8"",
							""DOMAIN_ID"" : ""Meas Value"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : null
						},
						{
							""CONCEPT_ID"" : 4181412,
							""CONCEPT_NAME"" : ""Present"",
							""STANDARD_CONCEPT"" : null,
							""STANDARD_CONCEPT_CAPTION"" : ""Unknown"",
							""INVALID_REASON"" : null,
							""INVALID_REASON_CAPTION"" : ""Unknown"",
							""CONCEPT_CODE"" : ""52101004"",
							""DOMAIN_ID"" : ""Meas Value"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : null
						},
						{
							""CONCEPT_ID"" : 45879438,
							""CONCEPT_NAME"" : ""Present"",
							""STANDARD_CONCEPT"" : null,
							""STANDARD_CONCEPT_CAPTION"" : ""Unknown"",
							""INVALID_REASON"" : null,
							""INVALID_REASON_CAPTION"" : ""Unknown"",
							""CONCEPT_CODE"" : ""LA9633-4"",
							""DOMAIN_ID"" : ""Meas Value"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : null
						}
					]
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""ConceptSets"" : [
		{
			""id"" : 0,
			""name"" : ""Influenza (including complications) - Conditions"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 4146943,
							""CONCEPT_NAME"" : ""Encephalitis due to influenza"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""309789002"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 46274061,
							""CONCEPT_NAME"" : ""Encephalopathy due to Influenza A virus"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""10677711000119101"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4266367,
							""CONCEPT_NAME"" : ""Influenza"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""6142004"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 42537960,
							""CONCEPT_NAME"" : ""Influenza with CNS disorder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""738276008"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4112824,
							""CONCEPT_NAME"" : ""Influenza with gastrointestinal tract involvement"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""195929004"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4299935,
							""CONCEPT_NAME"" : ""Myocarditis due to influenza virus"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""78046005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 46269706,
							""CONCEPT_NAME"" : ""Otitis media due to influenza"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""10624951000119108"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 763011,
							""CONCEPT_NAME"" : ""Pneumonia due to Influenza A virus"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""434921000124108"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4042202,
							""CONCEPT_NAME"" : ""Post-influenza encephalitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""230188005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 1,
			""name"" : ""Influenza (pre-coordinated Positive Measurements)"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 45757528,
							""CONCEPT_NAME"" : ""Influenza A virus present"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""181000124108"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4262075,
							""CONCEPT_NAME"" : ""Influenza B virus present"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""441345003"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 2,
			""name"" : ""Influenza testing (excluding Ab testing)"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 44789502,
							""CONCEPT_NAME"" : ""Avian infl virus nucl acid det"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""204271000000104"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37392948,
							""CONCEPT_NAME"" : ""Avian influenza virus RNA (ribonucleic acid) detection assay"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1010721000000107"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Observable Entity""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37394408,
							""CONCEPT_NAME"" : ""Avian influenza virus nucleic acid detection assay"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1031631000000102"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Observable Entity""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36676235,
							""CONCEPT_NAME"" : ""Detection of Influenza A virus using PCR - polymerase chain reaction technique"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""772835009"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37066972,
							""CONCEPT_NAME"" : ""Equine influenza virus A1 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP379343-9"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 3001703,
							""CONCEPT_NAME"" : ""Equine influenza virus A1 Ag [Titer] in Unspecified specimen by Hemagglutination inhibition"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""23102-7"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""Lab Test""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 3016424,
							""CONCEPT_NAME"" : ""Equine influenza virus A1 Ag [Units/volume] in Unspecified specimen"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""31821-2"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""Lab Test""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 3002696,
							""CONCEPT_NAME"" : ""Equine influenza virus A2 Ab [Presence] in Serum"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""15470-8"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""Lab Test""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 3000619,
							""CONCEPT_NAME"" : ""Equine influenza virus A2 Ab [Presence] in Serum by Complement fixation"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""23103-5"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""Lab Test""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 3023674,
							""CONCEPT_NAME"" : ""Equine influenza virus A2 Ab [Titer] in Serum"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""22303-2"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""Lab Test""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 3001047,
							""CONCEPT_NAME"" : ""Equine influenza virus A2 Ab [Titer] in Serum by Hemagglutination inhibition"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""15471-6"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""Lab Test""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 3007341,
							""CONCEPT_NAME"" : ""Equine influenza virus A2 Ab [Units/volume] in Serum"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""31380-9"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""Lab Test""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 3038149,
							""CONCEPT_NAME"" : ""Equine influenza virus A2 Ag [Titer] in Unspecified specimen by Hemagglutination inhibition"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""23104-3"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""Lab Test""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 3016676,
							""CONCEPT_NAME"" : ""Equine influenza virus A2 Ag [Units/volume] in Unspecified specimen"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""31822-0"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""Lab Test""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 3017256,
							""CONCEPT_NAME"" : ""Equine influenza virus Ag [Presence] in Nose"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""31823-8"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""Lab Test""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 3020370,
							""CONCEPT_NAME"" : ""Equine influenza virus Ag [Presence] in Nose by Immunoassay"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""15472-4"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""Lab Test""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 2213094,
							""CONCEPT_NAME"" : ""Infectious agent antigen detection by immunoassay technique, (eg, enzyme immunoassay [EIA], enzyme-linked immunosorbent assay [ELISA], immunochemiluminometric assay [IMCA]) qualitative or semiquantitative, multiple-step method; Influenza, A or B, each"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""87400"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""CPT4"",
							""CONCEPT_CLASS_ID"" : ""CPT4""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 2213181,
							""CONCEPT_NAME"" : ""Infectious agent antigen detection by immunoassay with direct optical observation; Influenza"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""87804"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""CPT4"",
							""CONCEPT_CLASS_ID"" : ""CPT4""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 2213063,
							""CONCEPT_NAME"" : ""Infectious agent antigen detection by immunofluorescent technique; influenza A virus"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""87276"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""CPT4"",
							""CONCEPT_CLASS_ID"" : ""CPT4""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 2213062,
							""CONCEPT_NAME"" : ""Infectious agent antigen detection by immunofluorescent technique; influenza B virus"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""87275"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""CPT4"",
							""CONCEPT_CLASS_ID"" : ""CPT4""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40757077,
							""CONCEPT_NAME"" : ""Infectious agent detection by nucleic acid (DNA or RNA); influenza virus, for multiple types or sub-types, includes multiplex reverse transcription, when performed, and multiplex amplified probe technique, first 2 types or sub-types"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""87502"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""CPT4"",
							""CONCEPT_CLASS_ID"" : ""CPT4""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40756898,
							""CONCEPT_NAME"" : ""Infectious agent detection by nucleic acid (DNA or RNA); influenza virus, includes reverse transcription, when performed, and amplified probe technique, each type or subtype"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""87501"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""CPT4"",
							""CONCEPT_CLASS_ID"" : ""CPT4""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37398130,
							""CONCEPT_NAME"" : ""Influenza (A and B) serology"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""996211000000100"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Observable Entity""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4039357,
							""CONCEPT_NAME"" : ""Influenza A and B virus antigen assay"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""118089005"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4201049,
							""CONCEPT_NAME"" : ""Influenza A antibody level"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""315142009"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37393224,
							""CONCEPT_NAME"" : ""Influenza A antibody level"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1014261000000103"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Observable Entity""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37392223,
							""CONCEPT_NAME"" : ""Influenza A antigen level"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1001341000000106"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Observable Entity""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44806470,
							""CONCEPT_NAME"" : ""Influenza A nucleic acid detection"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""801631000000107"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37394297,
							""CONCEPT_NAME"" : ""Influenza A nucleic acid detection assay"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1029881000000100"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Observable Entity""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44805899,
							""CONCEPT_NAME"" : ""Influenza A virus IgG antibody measurement"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""819431000000106"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4044987,
							""CONCEPT_NAME"" : ""Influenza A virus antigen assay"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""122349003"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 45757528,
							""CONCEPT_NAME"" : ""Influenza A virus present"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""181000124108"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4039358,
							""CONCEPT_NAME"" : ""Influenza A, B, and C virus antigen assay"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""118090001"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37393225,
							""CONCEPT_NAME"" : ""Influenza B antibody level"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1014271000000105"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Observable Entity""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4196405,
							""CONCEPT_NAME"" : ""Influenza B antibody level"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""315143004"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37392224,
							""CONCEPT_NAME"" : ""Influenza B antigen level"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1001351000000109"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Observable Entity""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44807860,
							""CONCEPT_NAME"" : ""Influenza B nucleic acid detection"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""838281000000105"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37394300,
							""CONCEPT_NAME"" : ""Influenza B nucleic acid detection assay"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1029911000000100"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Observable Entity""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44805900,
							""CONCEPT_NAME"" : ""Influenza B virus IgG antibody measurement"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""819441000000102"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4044988,
							""CONCEPT_NAME"" : ""Influenza B virus antigen assay"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""122350003"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4262075,
							""CONCEPT_NAME"" : ""Influenza B virus present"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""441345003"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37392761,
							""CONCEPT_NAME"" : ""Influenza B virus ribonucleic acid detection assay"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1008251000000105"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Observable Entity""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40760327,
							""CONCEPT_NAME"" : ""Influenza vaccination received in Reporting Period [CMS Assessment]"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""57208-1"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""Survey""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40653953,
							""CONCEPT_NAME"" : ""Influenza virus"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LG32757-3"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Group""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40655680,
							""CONCEPT_NAME"" : ""Influenza virus A & B Ag|Prid|Sys:ANYResp"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LG34146-7"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Group""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37048815,
							""CONCEPT_NAME"" : ""Influenza virus A Ab | Body fluid | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378370-3"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37058506,
							""CONCEPT_NAME"" : ""Influenza virus A Ab | Cerebral spinal fluid | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378371-1"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37055728,
							""CONCEPT_NAME"" : ""Influenza virus A Ab | Egg yolk | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378372-9"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37040765,
							""CONCEPT_NAME"" : ""Influenza virus A Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378373-7"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37023170,
							""CONCEPT_NAME"" : ""Influenza virus A Ab/Positive control | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378507-0"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40655681,
							""CONCEPT_NAME"" : ""Influenza virus A Ag|PrThr|Sys:ANYResp"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LG34020-4"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Group""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37075082,
							""CONCEPT_NAME"" : ""Influenza virus A Bangkok Ab | Cerebral spinal fluid | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378398-4"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37041511,
							""CONCEPT_NAME"" : ""Influenza virus A Bangkok Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378399-2"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37066453,
							""CONCEPT_NAME"" : ""Influenza virus A England Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378401-6"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37057346,
							""CONCEPT_NAME"" : ""Influenza virus A H1 2009 pandemic Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378452-9"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40655682,
							""CONCEPT_NAME"" : ""Influenza virus A H1 2009 pandemic RNA|PrThr|Sys:ANYResp"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LG34094-9"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Group""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37054344,
							""CONCEPT_NAME"" : ""Influenza virus A H1 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378404-0"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40655683,
							""CONCEPT_NAME"" : ""Influenza virus A H1 RNA|PrThr|Sys:ANYResp"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LG34092-3"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Group""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37022661,
							""CONCEPT_NAME"" : ""Influenza virus A H10 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378442-0"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37067997,
							""CONCEPT_NAME"" : ""Influenza virus A H11 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378443-8"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37028300,
							""CONCEPT_NAME"" : ""Influenza virus A H12 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378444-6"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37054453,
							""CONCEPT_NAME"" : ""Influenza virus A H13 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378445-3"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37036578,
							""CONCEPT_NAME"" : ""Influenza virus A H14 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378446-1"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37078464,
							""CONCEPT_NAME"" : ""Influenza virus A H15 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378447-9"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37067504,
							""CONCEPT_NAME"" : ""Influenza virus A H16 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378448-7"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37070652,
							""CONCEPT_NAME"" : ""Influenza virus A H2 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378413-1"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37048012,
							""CONCEPT_NAME"" : ""Influenza virus A H3 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378414-9"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40655684,
							""CONCEPT_NAME"" : ""Influenza virus A H3 RNA|PrThr|Sys:ANYResp"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LG34093-1"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Group""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37071077,
							""CONCEPT_NAME"" : ""Influenza virus A H4 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378421-4"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37042025,
							""CONCEPT_NAME"" : ""Influenza virus A H5 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378422-2"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40655685,
							""CONCEPT_NAME"" : ""Influenza virus A H5 Asian RNA|ThreshNum|Sys:ANYResp"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LG34153-3"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Group""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37024679,
							""CONCEPT_NAME"" : ""Influenza virus A H6 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378431-3"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37042070,
							""CONCEPT_NAME"" : ""Influenza virus A H7 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378433-9"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37052164,
							""CONCEPT_NAME"" : ""Influenza virus A H8 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378438-8"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37037245,
							""CONCEPT_NAME"" : ""Influenza virus A H9 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378439-6"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37072518,
							""CONCEPT_NAME"" : ""Influenza virus A Hong Kong Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378457-8"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37044556,
							""CONCEPT_NAME"" : ""Influenza virus A IgA | Cerebral spinal fluid | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378375-2"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37025175,
							""CONCEPT_NAME"" : ""Influenza virus A IgA | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378376-0"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37063376,
							""CONCEPT_NAME"" : ""Influenza virus A IgG | Cerebral spinal fluid | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378377-8"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37068553,
							""CONCEPT_NAME"" : ""Influenza virus A IgG | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378378-6"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37045806,
							""CONCEPT_NAME"" : ""Influenza virus A IgM | Cerebral spinal fluid | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378379-4"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37036252,
							""CONCEPT_NAME"" : ""Influenza virus A IgM | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378380-2"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37064420,
							""CONCEPT_NAME"" : ""Influenza virus A Leningrad Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378459-4"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37037941,
							""CONCEPT_NAME"" : ""Influenza virus A Mississippi Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378464-4"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37062169,
							""CONCEPT_NAME"" : ""Influenza virus A N1 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378466-9"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37076139,
							""CONCEPT_NAME"" : ""Influenza virus A N2 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378468-5"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37034233,
							""CONCEPT_NAME"" : ""Influenza virus A N3 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378470-1"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37051887,
							""CONCEPT_NAME"" : ""Influenza virus A N4 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378471-9"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37075960,
							""CONCEPT_NAME"" : ""Influenza virus A N5 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378472-7"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37022372,
							""CONCEPT_NAME"" : ""Influenza virus A N6 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378473-5"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37031117,
							""CONCEPT_NAME"" : ""Influenza virus A N7 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378474-3"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37073627,
							""CONCEPT_NAME"" : ""Influenza virus A N8 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378475-0"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37057853,
							""CONCEPT_NAME"" : ""Influenza virus A N9 Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378476-8"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37042870,
							""CONCEPT_NAME"" : ""Influenza virus A Phillipines Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378484-2"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37075259,
							""CONCEPT_NAME"" : ""Influenza virus A Port Chalmers Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378491-7"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40655686,
							""CONCEPT_NAME"" : ""Influenza virus A RNA|PrThr|Sys:ANYResp"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LG34064-2"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Group""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37030627,
							""CONCEPT_NAME"" : ""Influenza virus A Texas Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378505-4"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37059249,
							""CONCEPT_NAME"" : ""Influenza virus A Victoria Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378506-2"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37037961,
							""CONCEPT_NAME"" : ""Influenza virus A and B Ab | Body fluid | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378508-8"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37047321,
							""CONCEPT_NAME"" : ""Influenza virus A avian origin nucleoprotein Ab/Negative control | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378397-6"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37075847,
							""CONCEPT_NAME"" : ""Influenza virus A porcine origin nucleoprotein Ab.IgA/Positive control | XXX | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378489-1"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37073492,
							""CONCEPT_NAME"" : ""Influenza virus A porcine origin nucleoprotein Ab.IgG/Positive control | XXX | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378490-9"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37080282,
							""CONCEPT_NAME"" : ""Influenza virus A subtype|Prid|Sys:ANYResp"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LG50856-0"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Group""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37056311,
							""CONCEPT_NAME"" : ""Influenza virus A+B Ab | Body fluid | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378509-6"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37029363,
							""CONCEPT_NAME"" : ""Influenza virus A+B Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378510-4"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40655687,
							""CONCEPT_NAME"" : ""Influenza virus A+B Ag|PrThr|Sys:ANYResp"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LG34021-2"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Group""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40655688,
							""CONCEPT_NAME"" : ""Influenza virus A+B+C Ag|PrThr|Sys:ANYResp"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LG34022-0"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Group""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37023424,
							""CONCEPT_NAME"" : ""Influenza virus Ab | Cerebral spinal fluid | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378526-0"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37073273,
							""CONCEPT_NAME"" : ""Influenza virus Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378527-8"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37076384,
							""CONCEPT_NAME"" : ""Influenza virus B Ab | Body fluid | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378529-4"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37069805,
							""CONCEPT_NAME"" : ""Influenza virus B Ab | Cerebral spinal fluid | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378530-2"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37026917,
							""CONCEPT_NAME"" : ""Influenza virus B Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378531-0"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40655689,
							""CONCEPT_NAME"" : ""Influenza virus B Ag|PrThr|Sys:ANYResp"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LG34023-8"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Group""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37048913,
							""CONCEPT_NAME"" : ""Influenza virus B IgA | Cerebral spinal fluid | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378533-6"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37074405,
							""CONCEPT_NAME"" : ""Influenza virus B IgA | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378534-4"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37040736,
							""CONCEPT_NAME"" : ""Influenza virus B IgG | Cerebral spinal fluid | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378535-1"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37076803,
							""CONCEPT_NAME"" : ""Influenza virus B IgG | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378536-9"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37075491,
							""CONCEPT_NAME"" : ""Influenza virus B IgM | Cerebral spinal fluid | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378537-7"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37072743,
							""CONCEPT_NAME"" : ""Influenza virus B IgM | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP378538-5"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40655690,
							""CONCEPT_NAME"" : ""Influenza virus B RNA|PrThr|Sys:ANYResp"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LG34065-9"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Group""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4047171,
							""CONCEPT_NAME"" : ""Influenza virus culture"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""122262002"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40655691,
							""CONCEPT_NAME"" : ""Influenza virus identified|Prid|Sys:ANYResp"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LG34086-5"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Group""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40758391,
							""CONCEPT_NAME"" : ""Influenza virus immunization status"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""55262-0"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""Clinical Observation""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 42869813,
							""CONCEPT_NAME"" : ""Influenza virus vaccination received"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""72058-1"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""Survey""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40758149,
							""CONCEPT_NAME"" : ""Influenza virus vaccine received in facility [CMS Assessment]"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""55019-4"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""Survey""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 3043198,
							""CONCEPT_NAME"" : ""Influenza virus vaccine received in facility [Minimum Data Set]"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""45953-7"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""Survey""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4017924,
							""CONCEPT_NAME"" : ""Influenzavirus antibody assay"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""104310006"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40484560,
							""CONCEPT_NAME"" : ""Measurement of Influenza A virus subtype H1N1 antigen"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""443995002"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37050279,
							""CONCEPT_NAME"" : ""Porcine influenza virus A Ab | Serum | Microbiology"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""LP379495-7"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""LOINC Hierarchy""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 3002988,
							""CONCEPT_NAME"" : ""Porcine influenza virus A Ag [Presence] in Tissue by Immune stain"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""23769-3"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""Lab Test""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 3026510,
							""CONCEPT_NAME"" : ""Swine influenza virus Ab [Presence] in Serum"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""23437-7"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""Lab Test""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 3027889,
							""CONCEPT_NAME"" : ""Swine influenza virus Ab [Presence] in Serum by Hemagglutination inhibition"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""23438-5"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""Lab Test""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 3002646,
							""CONCEPT_NAME"" : ""Swine influenza virus Ag [Presence] in Tissue by Immune stain"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""23782-6"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""Lab Test""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 3003682,
							""CONCEPT_NAME"" : ""Swine influenza virus Ag [Presence] in Tissue by Immunofluorescence"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""23781-8"",
							""DOMAIN_ID"" : ""Measurement"",
							""VOCABULARY_ID"" : ""LOINC"",
							""CONCEPT_CLASS_ID"" : ""Lab Test""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""First""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""EndDate"",
			""Offset"" : 7
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 90
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 0 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4146943,46274061,4266367,42537960,4112824,4299935,46269706,763011)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4146943,46274061,4266367,42537960,4112824,4299935,46269706,763011)
  and c.invalid_reason is null

) I
LEFT JOIN
(
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4042202)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4042202)
  and c.invalid_reason is null

) E ON I.concept_id = E.concept_id
WHERE E.concept_id is null
) C UNION ALL 
SELECT 1 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (45757528,4262075)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (45757528,4262075)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 2 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (44789502,37392948,37394408,36676235,3001703,3016424,3038149,3016676,3017256,3020370,2213094,2213181,2213063,2213062,40757077,40756898,4039357,37392223,44806470,37394297,4044987,4039358,37392224,44807860,37394300,4044988,37392761,40653953,40655680,40655681,40655682,40655683,40655684,40655685,40655686,37080282,40655687,40655688,40655689,40655690,4047171,40655691,40484560,3002988,3002646,3003682)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (44789502,37392948,37394408,36676235,3001703,3016424,3038149,3016676,3017256,3020370,2213094,2213181,2213063,2213062,40757077,40756898,4039357,37392223,44806470,37394297,4044987,4039358,37392224,44807860,37394300,4044988,37392761,40653953,40655680,40655681,40655682,40655683,40655684,40655685,40655686,37080282,40655687,40655688,40655689,40655690,4047171,40655691,40484560,3002988,3002646,3003682)
  and c.invalid_reason is null

) I
LEFT JOIN
(
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (37066972,3002696,3000619,3023674,3001047,3007341,37398130,4201049,37393224,44805899,45757528,37393225,4196405,44805900,4262075,40760327,37048815,37058506,37055728,37040765,37023170,37075082,37041511,37066453,37057346,37054344,37022661,37067997,37028300,37054453,37036578,37078464,37067504,37070652,37048012,37071077,37042025,37024679,37042070,37052164,37037245,37072518,37044556,37025175,37063376,37068553,37045806,37036252,37064420,37037941,37062169,37076139,37034233,37051887,37075960,37022372,37031117,37073627,37057853,37042870,37075259,37030627,37059249,37037961,37047321,37075847,37073492,37056311,37029363,37023424,37073273,37076384,37069805,37026917,37048913,37074405,37040736,37076803,37075491,37072743,40758391,42869813,40758149,3043198,4017924,37050279,3026510,3027889)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (37066972,3002696,3000619,3023674,3001047,3007341,37398130,4201049,37393224,44805899,45757528,37393225,4196405,44805900,4262075,40760327,37048815,37058506,37055728,37040765,37023170,37075082,37041511,37066453,37057346,37054344,37022661,37067997,37028300,37054453,37036578,37078464,37067504,37070652,37048012,37071077,37042025,37024679,37042070,37052164,37037245,37072518,37044556,37025175,37063376,37068553,37045806,37036252,37064420,37037941,37062169,37076139,37034233,37051887,37075960,37022372,37031117,37073627,37057853,37042870,37075259,37030627,37059249,37037961,37047321,37075847,37073492,37056311,37029363,37023424,37073273,37076384,37069805,37026917,37048913,37074405,37040736,37076803,37075491,37072743,40758391,42869813,40758149,3043198,4017924,37050279,3026510,3027889)
  and c.invalid_reason is null

) E ON I.concept_id = E.concept_id
WHERE E.concept_id is null
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 0)
) C


-- End Condition Occurrence Criteria

UNION ALL
-- Begin Measurement Criteria
select C.person_id, C.measurement_id as event_id, C.measurement_date as start_date, DATEADD(d,1,C.measurement_date) as END_DATE,
       C.visit_occurrence_id, C.measurement_date as sort_date
from 
(
  select m.* 
  FROM @cdm_database_schema.MEASUREMENT m
JOIN #Codesets cs on (m.measurement_concept_id = cs.concept_id and cs.codeset_id = 1)
) C


-- End Measurement Criteria

UNION ALL
-- Begin Measurement Criteria
select C.person_id, C.measurement_id as event_id, C.measurement_date as start_date, DATEADD(d,1,C.measurement_date) as END_DATE,
       C.visit_occurrence_id, C.measurement_date as sort_date
from 
(
  select m.* 
  FROM @cdm_database_schema.MEASUREMENT m
JOIN #Codesets cs on (m.measurement_concept_id = cs.concept_id and cs.codeset_id = 2)
) C

WHERE C.value_as_concept_id in (4126681,45877985,9191,45884084,4181412,45879438)
-- End Measurement Criteria

UNION ALL
-- Begin Observation Criteria
select C.person_id, C.observation_id as event_id, C.observation_date as start_date, DATEADD(d,1,C.observation_date) as END_DATE,
       C.visit_occurrence_id, C.observation_date as sort_date
from 
(
  select o.* 
  FROM @cdm_database_schema.OBSERVATION o
JOIN #Codesets cs on (o.observation_concept_id = cs.concept_id and cs.codeset_id = 2)
) C

WHERE C.value_as_concept_id in (4126681,45877985,9191,45884084,4181412,45879438)
-- End Observation Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,7,end_date) > op_end_date then op_end_date else DATEADD(day,7,end_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 90, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,90,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",72,FALSE,
74,"[P] Hemorrhagic stroke (intracerebral bleeding) with inpatient admission (7Ps, 180Era)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 4,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""AdditionalCriteria"" : {
		""Type"" : ""ANY"",
		""CriteriaList"" : [
			{
				""Criteria"" : {
					""VisitOccurrence"" : {
						""CodesetId"" : 2,
						""VisitTypeExclude"" : false
					}
				},
				""StartWindow"" : {
					""Start"" : {
						""Coeff"" : -1
					},
					""End"" : {
						""Days"" : 0,
						""Coeff"" : 1
					},
					""UseIndexEnd"" : false,
					""UseEventEnd"" : false
				},
				""EndWindow"" : {
					""Start"" : {
						""Days"" : 0,
						""Coeff"" : -1
					},
					""End"" : {
						""Coeff"" : 1
					},
					""UseIndexEnd"" : false,
					""UseEventEnd"" : true
				},
				""RestrictVisit"" : false,
				""IgnoreObservationPeriod"" : false,
				""Occurrence"" : {
					""Type"" : 2,
					""Count"" : 1,
					""IsDistinct"" : false
				}
			}
		],
		""DemographicCriteriaList"" : [],
		""Groups"" : []
	},
	""ConceptSets"" : [
		{
			""id"" : 2,
			""name"" : ""Inpatient or ER visit"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 262,
							""CONCEPT_NAME"" : ""Emergency Room and Inpatient Visit"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""ERIP"",
							""DOMAIN_ID"" : ""Visit"",
							""VOCABULARY_ID"" : ""Visit"",
							""CONCEPT_CLASS_ID"" : ""Visit""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 9203,
							""CONCEPT_NAME"" : ""Emergency Room Visit"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""ER"",
							""DOMAIN_ID"" : ""Visit"",
							""VOCABULARY_ID"" : ""Visit"",
							""CONCEPT_CLASS_ID"" : ""Visit""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 9201,
							""CONCEPT_NAME"" : ""Inpatient Visit"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""IP"",
							""DOMAIN_ID"" : ""Visit"",
							""VOCABULARY_ID"" : ""Visit"",
							""CONCEPT_CLASS_ID"" : ""Visit""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 4,
			""name"" : ""Intracranial bleed Hemorrhagic stroke"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 376713,
							""CONCEPT_NAME"" : ""Cerebral hemorrhage"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""274100004"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 439847,
							""CONCEPT_NAME"" : ""Intracranial hemorrhage"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1386000"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 432923,
							""CONCEPT_NAME"" : ""Subarachnoid hemorrhage"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""21454007"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 43530727,
							""CONCEPT_NAME"" : ""Spontaneous cerebral hemorrhage"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""291571000119106"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4148906,
							""CONCEPT_NAME"" : ""Spontaneous subarachnoid hemorrhage"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""270907008"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 43530674,
							""CONCEPT_NAME"" : ""Spontaneous cerebellar hemorrhage"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""142851000119103"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 42535425,
							""CONCEPT_NAME"" : ""Spontaneous hemorrhage of cerebral hemisphere"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""291531000119108"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""All""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""StartDate"",
			""Offset"" : 7
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 180
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 2 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (262,9203,9201)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (262,9203,9201)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 4 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (376713,439847,432923,43530727,4148906,43530674,42535425)

) I
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 4)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 4)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 4)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) P
JOIN (
  -- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_occurrence_id, C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM @cdm_database_schema.VISIT_OCCURRENCE vo
JOIN #Codesets cs on (vo.visit_concept_id = cs.concept_id and cs.codeset_id = 2)
) C


-- End Visit Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= DATEADD(day,0,P.START_DATE) AND A.END_DATE >= DATEADD(day,0,P.START_DATE) AND A.END_DATE <= P.OP_END_DATE ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) > 0
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id and AC.event_id = pe.event_id

) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,7,start_date) > op_end_date then op_end_date else DATEADD(day,7,start_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 180, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,180,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",74,FALSE,
220,"[P] Angioedema (3Pe, 180Era)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 3,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""ConceptSets"" : [
		{
			""id"" : 3,
			""name"" : ""Angioedema or urticaria"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 4296370,
							""CONCEPT_NAME"" : ""Cutis laxa following urticaria-angioedema"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""403398009"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 432791,
							""CONCEPT_NAME"" : ""Angioedema"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""41291007"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4297361,
							""CONCEPT_NAME"" : ""Angioedema and/or urticaria"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""404177007"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4270861,
							""CONCEPT_NAME"" : ""Allergic angioedema"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""402387002"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 4,
			""name"" : ""Cardia edema"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 4231570,
							""CONCEPT_NAME"" : ""Cardiac edema"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""89555002"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4235646,
							""CONCEPT_NAME"" : ""Acute cardiac pulmonary edema"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""360371003"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 5,
			""name"" : ""Cellulits"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 435613,
							""CONCEPT_NAME"" : ""Cellulitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""128045006"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4299470,
							""CONCEPT_NAME"" : ""Cellulitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""385627004"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Morph Abnormality""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 133566,
							""CONCEPT_NAME"" : ""Necrotizing fasciitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""52486002"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 6,
			""name"" : ""Erysipelas"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 138346,
							""CONCEPT_NAME"" : ""Erysipelas"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""44653001"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4104689,
							""CONCEPT_NAME"" : ""Infective otitis externa due to erysipelas"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""194202008"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 7,
			""name"" : ""Dermatitis or Eczema"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 133835,
							""CONCEPT_NAME"" : ""Eczema"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""43116000"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 45766714,
							""CONCEPT_NAME"" : ""Inflammatory dermatosis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""703938007"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 8,
			""name"" : ""Lymphedema"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 435839,
							""CONCEPT_NAME"" : ""Lymphedema"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""234097001"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 9,
			""name"" : ""Insect bite or sting"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 4173025,
							""CONCEPT_NAME"" : ""Insect bite - wound"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""276433004"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 3661864,
							""CONCEPT_NAME"" : ""Allergic reaction caused by insect bite and/or insect sting"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""871927008"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 437478,
							""CONCEPT_NAME"" : ""Bite of nonvenomous arthropod"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""217706007"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4114305,
							""CONCEPT_NAME"" : ""Insect sting"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""299971005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 3661861,
							""CONCEPT_NAME"" : ""Allergic reaction to insect bite"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""871920005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36674264,
							""CONCEPT_NAME"" : ""Bite of insect"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""771191003"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Event""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4266230,
							""CONCEPT_NAME"" : ""Poisoning by venomous snake"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""61288004"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4296183,
							""CONCEPT_NAME"" : ""Insect bite reaction"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""402150002"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4032280,
							""CONCEPT_NAME"" : ""Snake bite"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""238456006"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 10,
			""name"" : ""Angioedema"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 4296370,
							""CONCEPT_NAME"" : ""Cutis laxa following urticaria-angioedema"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""403398009"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 432791,
							""CONCEPT_NAME"" : ""Angioedema"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""41291007"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""All""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [
		{
			""name"" : ""Angioedema within 3 days  "",
			""expression"" : {
				""Type"" : ""ALL"",
				""CriteriaList"" : [
					{
						""Criteria"" : {
							""ConditionOccurrence"" : {
								""CodesetId"" : 10,
								""ConditionTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Days"" : 0,
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 3,
								""Coeff"" : 1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : false,
						""Occurrence"" : {
							""Type"" : 2,
							""Count"" : 1,
							""IsDistinct"" : false
						}
					}
				],
				""DemographicCriteriaList"" : [],
				""Groups"" : []
			}
		},
		{
			""name"" : ""No Cardiac Edema"",
			""expression"" : {
				""Type"" : ""ALL"",
				""CriteriaList"" : [
					{
						""Criteria"" : {
							""ConditionOccurrence"" : {
								""CodesetId"" : 4,
								""ConditionTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Days"" : 7,
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 0,
								""Coeff"" : 1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : false,
						""Occurrence"" : {
							""Type"" : 0,
							""Count"" : 0,
							""IsDistinct"" : false
						}
					}
				],
				""DemographicCriteriaList"" : [],
				""Groups"" : []
			}
		},
		{
			""name"" : ""No Cellulitis"",
			""expression"" : {
				""Type"" : ""ALL"",
				""CriteriaList"" : [
					{
						""Criteria"" : {
							""ConditionOccurrence"" : {
								""CodesetId"" : 5,
								""ConditionTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Days"" : 7,
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 0,
								""Coeff"" : -1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : true,
						""Occurrence"" : {
							""Type"" : 0,
							""Count"" : 0,
							""IsDistinct"" : false
						}
					},
					{
						""Criteria"" : {
							""Observation"" : {
								""CodesetId"" : 5,
								""ObservationTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Days"" : 7,
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 0,
								""Coeff"" : -1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : false,
						""Occurrence"" : {
							""Type"" : 0,
							""Count"" : 0,
							""IsDistinct"" : false
						}
					}
				],
				""DemographicCriteriaList"" : [],
				""Groups"" : []
			}
		},
		{
			""name"" : ""No Erysipelas"",
			""expression"" : {
				""Type"" : ""ALL"",
				""CriteriaList"" : [
					{
						""Criteria"" : {
							""ConditionOccurrence"" : {
								""CodesetId"" : 6,
								""ConditionTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Days"" : 7,
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 0,
								""Coeff"" : -1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : true,
						""Occurrence"" : {
							""Type"" : 0,
							""Count"" : 0,
							""IsDistinct"" : false
						}
					}
				],
				""DemographicCriteriaList"" : [],
				""Groups"" : []
			}
		},
		{
			""name"" : ""No Dermatitis or Eczema"",
			""expression"" : {
				""Type"" : ""ALL"",
				""CriteriaList"" : [
					{
						""Criteria"" : {
							""ConditionOccurrence"" : {
								""CodesetId"" : 7,
								""ConditionTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Days"" : 7,
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 0,
								""Coeff"" : -1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : true,
						""Occurrence"" : {
							""Type"" : 0,
							""Count"" : 0,
							""IsDistinct"" : false
						}
					}
				],
				""DemographicCriteriaList"" : [],
				""Groups"" : []
			}
		},
		{
			""name"" : ""No Lymphedema "",
			""expression"" : {
				""Type"" : ""ALL"",
				""CriteriaList"" : [
					{
						""Criteria"" : {
							""ConditionOccurrence"" : {
								""CodesetId"" : 8,
								""ConditionTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Days"" : 7,
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 0,
								""Coeff"" : -1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : true,
						""Occurrence"" : {
							""Type"" : 0,
							""Count"" : 0,
							""IsDistinct"" : false
						}
					}
				],
				""DemographicCriteriaList"" : [],
				""Groups"" : []
			}
		},
		{
			""name"" : ""No insect bites"",
			""expression"" : {
				""Type"" : ""ALL"",
				""CriteriaList"" : [
					{
						""Criteria"" : {
							""ConditionOccurrence"" : {
								""CodesetId"" : 9,
								""ConditionTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Days"" : 7,
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 0,
								""Coeff"" : -1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : true,
						""Occurrence"" : {
							""Type"" : 0,
							""Count"" : 0,
							""IsDistinct"" : false
						}
					},
					{
						""Criteria"" : {
							""Observation"" : {
								""CodesetId"" : 9,
								""ObservationTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Days"" : 7,
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 0,
								""Coeff"" : -1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : false,
						""Occurrence"" : {
							""Type"" : 0,
							""Count"" : 0,
							""IsDistinct"" : false
						}
					}
				],
				""DemographicCriteriaList"" : [],
				""Groups"" : []
			}
		}
	],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""EndDate"",
			""Offset"" : 3
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 180
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 3 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4296370,432791,4297361,4270861)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4296370,432791,4297361,4270861)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 4 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4231570,4235646)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4231570,4235646)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 5 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (435613,4299470,133566)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (435613,4299470,133566)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 6 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (138346,4104689)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (138346,4104689)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 7 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (133835,45766714)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (133835,45766714)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 8 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (435839)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (435839)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 9 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4173025,3661864,437478,4114305,3661861,36674264,4266230,4296183,4032280)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4173025,3661864,437478,4114305,3661861,36674264,4266230,4296183,4032280)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 10 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4296370,432791)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4296370,432791)
  and c.invalid_reason is null

) I
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

select 0 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_0
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 10)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= DATEADD(day,0,P.START_DATE) AND A.START_DATE <= DATEADD(day,3,P.START_DATE) ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

select 1 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_1
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 4)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= DATEADD(day,-7,P.START_DATE) AND A.START_DATE <= DATEADD(day,0,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

select 2 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_2
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 5)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,-7,P.START_DATE) AND A.START_DATE <= DATEADD(day,0,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

UNION ALL
-- Begin Correlated Criteria
select 1 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Observation Criteria
select C.person_id, C.observation_id as event_id, C.observation_date as start_date, DATEADD(d,1,C.observation_date) as END_DATE,
       C.visit_occurrence_id, C.observation_date as sort_date
from 
(
  select o.* 
  FROM @cdm_database_schema.OBSERVATION o
JOIN #Codesets cs on (o.observation_concept_id = cs.concept_id and cs.codeset_id = 5)
) C


-- End Observation Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= DATEADD(day,-7,P.START_DATE) AND A.START_DATE <= DATEADD(day,0,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 2
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

select 3 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_3
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 6)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,-7,P.START_DATE) AND A.START_DATE <= DATEADD(day,0,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

select 4 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_4
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 7)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,-7,P.START_DATE) AND A.START_DATE <= DATEADD(day,0,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

select 5 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_5
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 8)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,-7,P.START_DATE) AND A.START_DATE <= DATEADD(day,0,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

select 6 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_6
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 9)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,-7,P.START_DATE) AND A.START_DATE <= DATEADD(day,0,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

UNION ALL
-- Begin Correlated Criteria
select 1 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Observation Criteria
select C.person_id, C.observation_id as event_id, C.observation_date as start_date, DATEADD(d,1,C.observation_date) as END_DATE,
       C.visit_occurrence_id, C.observation_date as sort_date
from 
(
  select o.* 
  FROM @cdm_database_schema.OBSERVATION o
JOIN #Codesets cs on (o.observation_concept_id = cs.concept_id and cs.codeset_id = 9)
) C


-- End Observation Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= DATEADD(day,-7,P.START_DATE) AND A.START_DATE <= DATEADD(day,0,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 2
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

SELECT inclusion_rule_id, person_id, event_id
INTO #inclusion_events
FROM (select inclusion_rule_id, person_id, event_id from #Inclusion_0
UNION ALL
select inclusion_rule_id, person_id, event_id from #Inclusion_1
UNION ALL
select inclusion_rule_id, person_id, event_id from #Inclusion_2
UNION ALL
select inclusion_rule_id, person_id, event_id from #Inclusion_3
UNION ALL
select inclusion_rule_id, person_id, event_id from #Inclusion_4
UNION ALL
select inclusion_rule_id, person_id, event_id from #Inclusion_5
UNION ALL
select inclusion_rule_id, person_id, event_id from #Inclusion_6) I;
TRUNCATE TABLE #Inclusion_0;
DROP TABLE #Inclusion_0;

TRUNCATE TABLE #Inclusion_1;
DROP TABLE #Inclusion_1;

TRUNCATE TABLE #Inclusion_2;
DROP TABLE #Inclusion_2;

TRUNCATE TABLE #Inclusion_3;
DROP TABLE #Inclusion_3;

TRUNCATE TABLE #Inclusion_4;
DROP TABLE #Inclusion_4;

TRUNCATE TABLE #Inclusion_5;
DROP TABLE #Inclusion_5;

TRUNCATE TABLE #Inclusion_6;
DROP TABLE #Inclusion_6;


select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

  -- the matching group with all bits set ( POWER(2,# of inclusion rules) - 1 = inclusion_rule_mask
  WHERE (MG.inclusion_rule_mask = POWER(cast(2 as bigint),7)-1)

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,3,end_date) > op_end_date then op_end_date else DATEADD(day,3,end_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 180, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,180,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



-- Create a temp table of inclusion rule rows for joining in the inclusion rule impact analysis

select cast(rule_sequence as int) as rule_sequence
into #inclusion_rules
from (
  SELECT CAST(0 as int) as rule_sequence UNION ALL SELECT CAST(1 as int) as rule_sequence UNION ALL SELECT CAST(2 as int) as rule_sequence UNION ALL SELECT CAST(3 as int) as rule_sequence UNION ALL SELECT CAST(4 as int) as rule_sequence UNION ALL SELECT CAST(5 as int) as rule_sequence UNION ALL SELECT CAST(6 as int) as rule_sequence
) IR;


-- Find the event that is the 'best match' per person.  
-- the 'best match' is defined as the event that satisfies the most inclusion rules.
-- ties are solved by choosing the event that matches the earliest inclusion rule, and then earliest.

select q.person_id, q.event_id
into #best_events
from #qualified_events Q
join (
	SELECT R.person_id, R.event_id, ROW_NUMBER() OVER (PARTITION BY R.person_id ORDER BY R.rule_count DESC,R.min_rule_id ASC, R.start_date ASC) AS rank_value
	FROM (
		SELECT Q.person_id, Q.event_id, COALESCE(COUNT(DISTINCT I.inclusion_rule_id), 0) AS rule_count, COALESCE(MIN(I.inclusion_rule_id), 0) AS min_rule_id, Q.start_date
		FROM #qualified_events Q
		LEFT JOIN #inclusion_events I ON q.person_id = i.person_id AND q.event_id = i.event_id
		GROUP BY Q.person_id, Q.event_id, Q.start_date
	) R
) ranked on Q.person_id = ranked.person_id and Q.event_id = ranked.event_id
WHERE ranked.rank_value = 1
;

-- modes of generation: (the same tables store the results for the different modes, identified by the mode_id column)
-- 0: all events
-- 1: best event


-- BEGIN: Inclusion Impact Analysis - event
-- calculte matching group counts
delete from @results_database_schema.cohort_inclusion_result where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_inclusion_result (cohort_definition_id, inclusion_rule_mask, person_count, mode_id)
select @target_cohort_id as cohort_definition_id, inclusion_rule_mask, count_big(*) as person_count, 0 as mode_id
from
(
  select Q.person_id, Q.event_id, CAST(SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) AS bigint) as inclusion_rule_mask
  from #qualified_events Q
  LEFT JOIN #inclusion_events I on q.person_id = i.person_id and q.event_id = i.event_id
  GROUP BY Q.person_id, Q.event_id
) MG -- matching groups
group by inclusion_rule_mask
;

-- calculate gain counts 
delete from @results_database_schema.cohort_inclusion_stats where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_inclusion_stats (cohort_definition_id, rule_sequence, person_count, gain_count, person_total, mode_id)
select @target_cohort_id as cohort_definition_id, ir.rule_sequence, coalesce(T.person_count, 0) as person_count, coalesce(SR.person_count, 0) gain_count, EventTotal.total, 0 as mode_id
from #inclusion_rules ir
left join
(
  select i.inclusion_rule_id, count_big(i.event_id) as person_count
  from #qualified_events Q
  JOIN #inclusion_events i on Q.person_id = I.person_id and Q.event_id = i.event_id
  group by i.inclusion_rule_id
) T on ir.rule_sequence = T.inclusion_rule_id
CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
CROSS JOIN (select count_big(event_id) as total from #qualified_events) EventTotal
LEFT JOIN @results_database_schema.cohort_inclusion_result SR on SR.mode_id = 0 AND SR.cohort_definition_id = @target_cohort_id AND (POWER(cast(2 as bigint),RuleTotal.total_rules) - POWER(cast(2 as bigint),ir.rule_sequence) - 1) = SR.inclusion_rule_mask -- POWER(2,rule count) - POWER(2,rule sequence) - 1 is the mask for 'all except this rule'
;

-- calculate totals
delete from @results_database_schema.cohort_summary_stats where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_summary_stats (cohort_definition_id, base_count, final_count, mode_id)
select @target_cohort_id as cohort_definition_id, PC.total as person_count, coalesce(FC.total, 0) as final_count, 0 as mode_id
FROM
(select count_big(event_id) as total from #qualified_events) PC,
(select sum(sr.person_count) as total
  from @results_database_schema.cohort_inclusion_result sr
  CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
  where sr.mode_id = 0 and sr.cohort_definition_id = @target_cohort_id and sr.inclusion_rule_mask = POWER(cast(2 as bigint),RuleTotal.total_rules)-1
) FC
;

-- END: Inclusion Impact Analysis - event

-- BEGIN: Inclusion Impact Analysis - person
-- calculte matching group counts
delete from @results_database_schema.cohort_inclusion_result where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_inclusion_result (cohort_definition_id, inclusion_rule_mask, person_count, mode_id)
select @target_cohort_id as cohort_definition_id, inclusion_rule_mask, count_big(*) as person_count, 1 as mode_id
from
(
  select Q.person_id, Q.event_id, CAST(SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) AS bigint) as inclusion_rule_mask
  from #best_events Q
  LEFT JOIN #inclusion_events I on q.person_id = i.person_id and q.event_id = i.event_id
  GROUP BY Q.person_id, Q.event_id
) MG -- matching groups
group by inclusion_rule_mask
;

-- calculate gain counts 
delete from @results_database_schema.cohort_inclusion_stats where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_inclusion_stats (cohort_definition_id, rule_sequence, person_count, gain_count, person_total, mode_id)
select @target_cohort_id as cohort_definition_id, ir.rule_sequence, coalesce(T.person_count, 0) as person_count, coalesce(SR.person_count, 0) gain_count, EventTotal.total, 1 as mode_id
from #inclusion_rules ir
left join
(
  select i.inclusion_rule_id, count_big(i.event_id) as person_count
  from #best_events Q
  JOIN #inclusion_events i on Q.person_id = I.person_id and Q.event_id = i.event_id
  group by i.inclusion_rule_id
) T on ir.rule_sequence = T.inclusion_rule_id
CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
CROSS JOIN (select count_big(event_id) as total from #best_events) EventTotal
LEFT JOIN @results_database_schema.cohort_inclusion_result SR on SR.mode_id = 1 AND SR.cohort_definition_id = @target_cohort_id AND (POWER(cast(2 as bigint),RuleTotal.total_rules) - POWER(cast(2 as bigint),ir.rule_sequence) - 1) = SR.inclusion_rule_mask -- POWER(2,rule count) - POWER(2,rule sequence) - 1 is the mask for 'all except this rule'
;

-- calculate totals
delete from @results_database_schema.cohort_summary_stats where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_summary_stats (cohort_definition_id, base_count, final_count, mode_id)
select @target_cohort_id as cohort_definition_id, PC.total as person_count, coalesce(FC.total, 0) as final_count, 1 as mode_id
FROM
(select count_big(event_id) as total from #best_events) PC,
(select sum(sr.person_count) as total
  from @results_database_schema.cohort_inclusion_result sr
  CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
  where sr.mode_id = 1 and sr.cohort_definition_id = @target_cohort_id and sr.inclusion_rule_mask = POWER(cast(2 as bigint),RuleTotal.total_rules)-1
) FC
;

-- END: Inclusion Impact Analysis - person

TRUNCATE TABLE #best_events;
DROP TABLE #best_events;

TRUNCATE TABLE #inclusion_rules;
DROP TABLE #inclusion_rules;


TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",220,FALSE,
234,"Appendicitis (1Pe, 180Era)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 2,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""AdditionalCriteria"" : {
		""Type"" : ""ALL"",
		""CriteriaList"" : [
			{
				""Criteria"" : {
					""VisitOccurrence"" : {
						""CodesetId"" : 1,
						""VisitTypeExclude"" : false
					}
				},
				""StartWindow"" : {
					""Start"" : {
						""Coeff"" : -1
					},
					""End"" : {
						""Days"" : 0,
						""Coeff"" : 1
					},
					""UseIndexEnd"" : false,
					""UseEventEnd"" : false
				},
				""EndWindow"" : {
					""Start"" : {
						""Days"" : 0,
						""Coeff"" : -1
					},
					""End"" : {
						""Coeff"" : 1
					},
					""UseIndexEnd"" : false,
					""UseEventEnd"" : true
				},
				""RestrictVisit"" : false,
				""IgnoreObservationPeriod"" : false,
				""Occurrence"" : {
					""Type"" : 2,
					""Count"" : 1,
					""IsDistinct"" : false
				}
			}
		],
		""DemographicCriteriaList"" : [],
		""Groups"" : []
	},
	""ConceptSets"" : [
		{
			""id"" : 1,
			""name"" : ""Inpatient or Inpatient/ER visit"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 262,
							""CONCEPT_NAME"" : ""Emergency Room and Inpatient Visit"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""ERIP"",
							""DOMAIN_ID"" : ""Visit"",
							""VOCABULARY_ID"" : ""Visit"",
							""CONCEPT_CLASS_ID"" : ""Visit""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 9201,
							""CONCEPT_NAME"" : ""Inpatient Visit"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""IP"",
							""DOMAIN_ID"" : ""Visit"",
							""VOCABULARY_ID"" : ""Visit"",
							""CONCEPT_CLASS_ID"" : ""Visit""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 2,
			""name"" : ""Appendicitis"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 440448,
							""CONCEPT_NAME"" : ""Appendicitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""74400008"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""All""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""EndDate"",
			""Offset"" : 1
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 180
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 1 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (262,9201)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (262,9201)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 2 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (440448)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (440448)
  and c.invalid_reason is null

) I
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 2)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 2)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 2)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) P
JOIN (
  -- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_occurrence_id, C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM @cdm_database_schema.VISIT_OCCURRENCE vo
JOIN #Codesets cs on (vo.visit_concept_id = cs.concept_id and cs.codeset_id = 1)
) C


-- End Visit Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= DATEADD(day,0,P.START_DATE) AND A.END_DATE >= DATEADD(day,0,P.START_DATE) AND A.END_DATE <= P.OP_END_DATE ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id and AC.event_id = pe.event_id

) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,1,end_date) > op_end_date then op_end_date else DATEADD(day,1,end_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 180, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,180,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",234,FALSE,
238,"[P] Optic Neuritis (7Pe, 365Era)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 3,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""ConceptSets"" : [
		{
			""id"" : 3,
			""name"" : ""Optic Neuritis"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 374954,
							""CONCEPT_NAME"" : ""Optic neuritis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""66760008"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""All""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""EndDate"",
			""Offset"" : 7
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 365
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 3 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (374954)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (374954)
  and c.invalid_reason is null

) I
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,7,end_date) > op_end_date then op_end_date else DATEADD(day,7,end_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 365, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,365,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",238,FALSE,
248,"[P] Disseminated intravascular coagulation DIC (1Pe, 0Era, 365W)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 3,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""AdditionalCriteria"" : {
		""Type"" : ""ALL"",
		""CriteriaList"" : [
			{
				""Criteria"" : {
					""VisitOccurrence"" : {
						""CodesetId"" : 1,
						""VisitTypeExclude"" : false
					}
				},
				""StartWindow"" : {
					""Start"" : {
						""Coeff"" : -1
					},
					""End"" : {
						""Days"" : 0,
						""Coeff"" : 1
					},
					""UseIndexEnd"" : false,
					""UseEventEnd"" : false
				},
				""EndWindow"" : {
					""Start"" : {
						""Days"" : 0,
						""Coeff"" : -1
					},
					""End"" : {
						""Coeff"" : 1
					},
					""UseIndexEnd"" : false,
					""UseEventEnd"" : true
				},
				""RestrictVisit"" : false,
				""IgnoreObservationPeriod"" : false,
				""Occurrence"" : {
					""Type"" : 2,
					""Count"" : 1,
					""IsDistinct"" : false
				}
			}
		],
		""DemographicCriteriaList"" : [],
		""Groups"" : []
	},
	""ConceptSets"" : [
		{
			""id"" : 1,
			""name"" : ""Inpatient or Inpatient/ER visit"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 262,
							""CONCEPT_NAME"" : ""Emergency Room and Inpatient Visit"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""ERIP"",
							""DOMAIN_ID"" : ""Visit"",
							""VOCABULARY_ID"" : ""Visit"",
							""CONCEPT_CLASS_ID"" : ""Visit""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 9201,
							""CONCEPT_NAME"" : ""Inpatient Visit"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""IP"",
							""DOMAIN_ID"" : ""Visit"",
							""VOCABULARY_ID"" : ""Visit"",
							""CONCEPT_CLASS_ID"" : ""Visit""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 3,
			""name"" : ""Disseminated intravascular coagulation"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 436093,
							""CONCEPT_NAME"" : ""Disseminated intravascular coagulation"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""67406007"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""All""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [
		{
			""name"" : ""has no events in prior 'clean window' - 365 days"",
			""expression"" : {
				""Type"" : ""ALL"",
				""CriteriaList"" : [
					{
						""Criteria"" : {
							""ConditionOccurrence"" : {
								""CorrelatedCriteria"" : {
									""Type"" : ""ALL"",
									""CriteriaList"" : [
										{
											""Criteria"" : {
												""VisitOccurrence"" : {
													""CodesetId"" : 1,
													""VisitTypeExclude"" : false
												}
											},
											""StartWindow"" : {
												""Start"" : {
													""Coeff"" : -1
												},
												""End"" : {
													""Days"" : 0,
													""Coeff"" : 1
												},
												""UseIndexEnd"" : false,
												""UseEventEnd"" : false
											},
											""EndWindow"" : {
												""Start"" : {
													""Days"" : 0,
													""Coeff"" : -1
												},
												""End"" : {
													""Coeff"" : 1
												},
												""UseIndexEnd"" : false,
												""UseEventEnd"" : true
											},
											""RestrictVisit"" : false,
											""IgnoreObservationPeriod"" : false,
											""Occurrence"" : {
												""Type"" : 2,
												""Count"" : 1,
												""IsDistinct"" : false
											}
										}
									],
									""DemographicCriteriaList"" : [],
									""Groups"" : []
								},
								""CodesetId"" : 3,
								""ConditionTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Days"" : 365,
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 1,
								""Coeff"" : -1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : true,
						""Occurrence"" : {
							""Type"" : 0,
							""Count"" : 0,
							""IsDistinct"" : false
						}
					}
				],
				""DemographicCriteriaList"" : [],
				""Groups"" : []
			}
		}
	],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""EndDate"",
			""Offset"" : 1
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 0
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 1 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (262,9201)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (262,9201)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 3 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (436093)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (436093)
  and c.invalid_reason is null

) I
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) P
JOIN (
  -- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_occurrence_id, C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM @cdm_database_schema.VISIT_OCCURRENCE vo
JOIN #Codesets cs on (vo.visit_concept_id = cs.concept_id and cs.codeset_id = 1)
) C


-- End Visit Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= DATEADD(day,0,P.START_DATE) AND A.END_DATE >= DATEADD(day,0,P.START_DATE) AND A.END_DATE <= P.OP_END_DATE ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id and AC.event_id = pe.event_id

) QE

;

--- Inclusion Rule Inserts

select 0 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_0
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  select PE.person_id, PE.event_id, PE.start_date, PE.end_date, PE.visit_occurrence_id, PE.sort_date FROM (
-- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria

) PE
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria
) Q
JOIN @cdm_database_schema.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria
) Q
JOIN @cdm_database_schema.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) P
JOIN (
  -- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_occurrence_id, C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM @cdm_database_schema.VISIT_OCCURRENCE vo
JOIN #Codesets cs on (vo.visit_concept_id = cs.concept_id and cs.codeset_id = 1)
) C


-- End Visit Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= DATEADD(day,0,P.START_DATE) AND A.END_DATE >= DATEADD(day,0,P.START_DATE) AND A.END_DATE <= P.OP_END_DATE ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id and AC.event_id = pe.event_id

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,-365,P.START_DATE) AND A.START_DATE <= DATEADD(day,-1,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

SELECT inclusion_rule_id, person_id, event_id
INTO #inclusion_events
FROM (select inclusion_rule_id, person_id, event_id from #Inclusion_0) I;
TRUNCATE TABLE #Inclusion_0;
DROP TABLE #Inclusion_0;


select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

  -- the matching group with all bits set ( POWER(2,# of inclusion rules) - 1 = inclusion_rule_mask
  WHERE (MG.inclusion_rule_mask = POWER(cast(2 as bigint),1)-1)

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,1,end_date) > op_end_date then op_end_date else DATEADD(day,1,end_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 0, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,0,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



-- Create a temp table of inclusion rule rows for joining in the inclusion rule impact analysis

select cast(rule_sequence as int) as rule_sequence
into #inclusion_rules
from (
  SELECT CAST(0 as int) as rule_sequence
) IR;


-- Find the event that is the 'best match' per person.  
-- the 'best match' is defined as the event that satisfies the most inclusion rules.
-- ties are solved by choosing the event that matches the earliest inclusion rule, and then earliest.

select q.person_id, q.event_id
into #best_events
from #qualified_events Q
join (
	SELECT R.person_id, R.event_id, ROW_NUMBER() OVER (PARTITION BY R.person_id ORDER BY R.rule_count DESC,R.min_rule_id ASC, R.start_date ASC) AS rank_value
	FROM (
		SELECT Q.person_id, Q.event_id, COALESCE(COUNT(DISTINCT I.inclusion_rule_id), 0) AS rule_count, COALESCE(MIN(I.inclusion_rule_id), 0) AS min_rule_id, Q.start_date
		FROM #qualified_events Q
		LEFT JOIN #inclusion_events I ON q.person_id = i.person_id AND q.event_id = i.event_id
		GROUP BY Q.person_id, Q.event_id, Q.start_date
	) R
) ranked on Q.person_id = ranked.person_id and Q.event_id = ranked.event_id
WHERE ranked.rank_value = 1
;

-- modes of generation: (the same tables store the results for the different modes, identified by the mode_id column)
-- 0: all events
-- 1: best event


-- BEGIN: Inclusion Impact Analysis - event
-- calculte matching group counts
delete from @results_database_schema.cohort_inclusion_result where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_inclusion_result (cohort_definition_id, inclusion_rule_mask, person_count, mode_id)
select @target_cohort_id as cohort_definition_id, inclusion_rule_mask, count_big(*) as person_count, 0 as mode_id
from
(
  select Q.person_id, Q.event_id, CAST(SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) AS bigint) as inclusion_rule_mask
  from #qualified_events Q
  LEFT JOIN #inclusion_events I on q.person_id = i.person_id and q.event_id = i.event_id
  GROUP BY Q.person_id, Q.event_id
) MG -- matching groups
group by inclusion_rule_mask
;

-- calculate gain counts 
delete from @results_database_schema.cohort_inclusion_stats where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_inclusion_stats (cohort_definition_id, rule_sequence, person_count, gain_count, person_total, mode_id)
select @target_cohort_id as cohort_definition_id, ir.rule_sequence, coalesce(T.person_count, 0) as person_count, coalesce(SR.person_count, 0) gain_count, EventTotal.total, 0 as mode_id
from #inclusion_rules ir
left join
(
  select i.inclusion_rule_id, count_big(i.event_id) as person_count
  from #qualified_events Q
  JOIN #inclusion_events i on Q.person_id = I.person_id and Q.event_id = i.event_id
  group by i.inclusion_rule_id
) T on ir.rule_sequence = T.inclusion_rule_id
CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
CROSS JOIN (select count_big(event_id) as total from #qualified_events) EventTotal
LEFT JOIN @results_database_schema.cohort_inclusion_result SR on SR.mode_id = 0 AND SR.cohort_definition_id = @target_cohort_id AND (POWER(cast(2 as bigint),RuleTotal.total_rules) - POWER(cast(2 as bigint),ir.rule_sequence) - 1) = SR.inclusion_rule_mask -- POWER(2,rule count) - POWER(2,rule sequence) - 1 is the mask for 'all except this rule'
;

-- calculate totals
delete from @results_database_schema.cohort_summary_stats where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_summary_stats (cohort_definition_id, base_count, final_count, mode_id)
select @target_cohort_id as cohort_definition_id, PC.total as person_count, coalesce(FC.total, 0) as final_count, 0 as mode_id
FROM
(select count_big(event_id) as total from #qualified_events) PC,
(select sum(sr.person_count) as total
  from @results_database_schema.cohort_inclusion_result sr
  CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
  where sr.mode_id = 0 and sr.cohort_definition_id = @target_cohort_id and sr.inclusion_rule_mask = POWER(cast(2 as bigint),RuleTotal.total_rules)-1
) FC
;

-- END: Inclusion Impact Analysis - event

-- BEGIN: Inclusion Impact Analysis - person
-- calculte matching group counts
delete from @results_database_schema.cohort_inclusion_result where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_inclusion_result (cohort_definition_id, inclusion_rule_mask, person_count, mode_id)
select @target_cohort_id as cohort_definition_id, inclusion_rule_mask, count_big(*) as person_count, 1 as mode_id
from
(
  select Q.person_id, Q.event_id, CAST(SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) AS bigint) as inclusion_rule_mask
  from #best_events Q
  LEFT JOIN #inclusion_events I on q.person_id = i.person_id and q.event_id = i.event_id
  GROUP BY Q.person_id, Q.event_id
) MG -- matching groups
group by inclusion_rule_mask
;

-- calculate gain counts 
delete from @results_database_schema.cohort_inclusion_stats where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_inclusion_stats (cohort_definition_id, rule_sequence, person_count, gain_count, person_total, mode_id)
select @target_cohort_id as cohort_definition_id, ir.rule_sequence, coalesce(T.person_count, 0) as person_count, coalesce(SR.person_count, 0) gain_count, EventTotal.total, 1 as mode_id
from #inclusion_rules ir
left join
(
  select i.inclusion_rule_id, count_big(i.event_id) as person_count
  from #best_events Q
  JOIN #inclusion_events i on Q.person_id = I.person_id and Q.event_id = i.event_id
  group by i.inclusion_rule_id
) T on ir.rule_sequence = T.inclusion_rule_id
CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
CROSS JOIN (select count_big(event_id) as total from #best_events) EventTotal
LEFT JOIN @results_database_schema.cohort_inclusion_result SR on SR.mode_id = 1 AND SR.cohort_definition_id = @target_cohort_id AND (POWER(cast(2 as bigint),RuleTotal.total_rules) - POWER(cast(2 as bigint),ir.rule_sequence) - 1) = SR.inclusion_rule_mask -- POWER(2,rule count) - POWER(2,rule sequence) - 1 is the mask for 'all except this rule'
;

-- calculate totals
delete from @results_database_schema.cohort_summary_stats where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_summary_stats (cohort_definition_id, base_count, final_count, mode_id)
select @target_cohort_id as cohort_definition_id, PC.total as person_count, coalesce(FC.total, 0) as final_count, 1 as mode_id
FROM
(select count_big(event_id) as total from #best_events) PC,
(select sum(sr.person_count) as total
  from @results_database_schema.cohort_inclusion_result sr
  CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
  where sr.mode_id = 1 and sr.cohort_definition_id = @target_cohort_id and sr.inclusion_rule_mask = POWER(cast(2 as bigint),RuleTotal.total_rules)-1
) FC
;

-- END: Inclusion Impact Analysis - person

TRUNCATE TABLE #best_events;
DROP TABLE #best_events;

TRUNCATE TABLE #inclusion_rules;
DROP TABLE #inclusion_rules;


TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",248,FALSE,
249,"[P] Ischemic (Non-hemorrhagic) Stroke (1Pe, 0Era, 365W)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 3,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""AdditionalCriteria"" : {
		""Type"" : ""ALL"",
		""CriteriaList"" : [
			{
				""Criteria"" : {
					""VisitOccurrence"" : {
						""CodesetId"" : 2,
						""VisitTypeExclude"" : false
					}
				},
				""StartWindow"" : {
					""Start"" : {
						""Coeff"" : -1
					},
					""End"" : {
						""Days"" : 0,
						""Coeff"" : 1
					},
					""UseIndexEnd"" : false,
					""UseEventEnd"" : false
				},
				""EndWindow"" : {
					""Start"" : {
						""Days"" : 0,
						""Coeff"" : -1
					},
					""End"" : {
						""Coeff"" : 1
					},
					""UseIndexEnd"" : false,
					""UseEventEnd"" : true
				},
				""RestrictVisit"" : false,
				""IgnoreObservationPeriod"" : false,
				""Occurrence"" : {
					""Type"" : 2,
					""Count"" : 1,
					""IsDistinct"" : false
				}
			}
		],
		""DemographicCriteriaList"" : [],
		""Groups"" : []
	},
	""ConceptSets"" : [
		{
			""id"" : 2,
			""name"" : ""Inpatient or Inpatient/ER visit"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 262,
							""CONCEPT_NAME"" : ""Emergency Room and Inpatient Visit"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""ERIP"",
							""DOMAIN_ID"" : ""Visit"",
							""VOCABULARY_ID"" : ""Visit"",
							""CONCEPT_CLASS_ID"" : ""Visit""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 9201,
							""CONCEPT_NAME"" : ""Inpatient Visit"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""IP"",
							""DOMAIN_ID"" : ""Visit"",
							""VOCABULARY_ID"" : ""Visit"",
							""CONCEPT_CLASS_ID"" : ""Visit""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 3,
			""name"" : ""Cerebral infarction"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 443454,
							""CONCEPT_NAME"" : ""Cerebral infarction"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""432504007"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 40479572,
							""CONCEPT_NAME"" : ""Infarct of cerebrum due to iatrogenic cerebrovascular accident"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""441526008"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4046360,
							""CONCEPT_NAME"" : ""Lacunar infarction"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""230698000"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 372435,
							""CONCEPT_NAME"" : ""Periventricular leukomalacia"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""230769007"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 377254,
							""CONCEPT_NAME"" : ""Multi-infarct dementia, uncomplicated"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""70936005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 379778,
							""CONCEPT_NAME"" : ""Multi-infarct dementia"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""56267009"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 443790,
							""CONCEPT_NAME"" : ""Multi-infarct dementia with delusions"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""25772007"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 443864,
							""CONCEPT_NAME"" : ""Multi-infarct dementia with depression"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""14070001"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 444091,
							""CONCEPT_NAME"" : ""Multi-infarct dementia with delirium"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""10349009"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4046089,
							""CONCEPT_NAME"" : ""Vascular dementia of acute onset"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""230285003"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4046090,
							""CONCEPT_NAME"" : ""Mixed cortical and subcortical vascular dementia"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""230287006"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4129534,
							""CONCEPT_NAME"" : ""Pituitary apoplexy"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""237701005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : false,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""All""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [
		{
			""name"" : ""has no events in prior 'clean window' - 365 days"",
			""expression"" : {
				""Type"" : ""ALL"",
				""CriteriaList"" : [
					{
						""Criteria"" : {
							""ConditionOccurrence"" : {
								""CorrelatedCriteria"" : {
									""Type"" : ""ALL"",
									""CriteriaList"" : [
										{
											""Criteria"" : {
												""VisitOccurrence"" : {
													""CodesetId"" : 2,
													""VisitTypeExclude"" : false
												}
											},
											""StartWindow"" : {
												""Start"" : {
													""Coeff"" : -1
												},
												""End"" : {
													""Days"" : 0,
													""Coeff"" : 1
												},
												""UseIndexEnd"" : false,
												""UseEventEnd"" : false
											},
											""EndWindow"" : {
												""Start"" : {
													""Days"" : 0,
													""Coeff"" : -1
												},
												""End"" : {
													""Coeff"" : 1
												},
												""UseIndexEnd"" : false,
												""UseEventEnd"" : true
											},
											""RestrictVisit"" : false,
											""IgnoreObservationPeriod"" : false,
											""Occurrence"" : {
												""Type"" : 2,
												""Count"" : 1,
												""IsDistinct"" : false
											}
										}
									],
									""DemographicCriteriaList"" : [],
									""Groups"" : []
								},
								""CodesetId"" : 3,
								""ConditionTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Days"" : 365,
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 1,
								""Coeff"" : -1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : true,
						""Occurrence"" : {
							""Type"" : 0,
							""Count"" : 0,
							""IsDistinct"" : false
						}
					}
				],
				""DemographicCriteriaList"" : [],
				""Groups"" : []
			}
		}
	],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""EndDate"",
			""Offset"" : 1
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 0
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 2 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (262,9201)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (262,9201)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 3 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (443454)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (443454)
  and c.invalid_reason is null

) I
LEFT JOIN
(
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (40479572,4046360,372435,377254,379778,443790,443864,444091,4046089,4046090,4129534)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (40479572,4046360)
  and c.invalid_reason is null

) E ON I.concept_id = E.concept_id
WHERE E.concept_id is null
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) P
JOIN (
  -- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_occurrence_id, C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM @cdm_database_schema.VISIT_OCCURRENCE vo
JOIN #Codesets cs on (vo.visit_concept_id = cs.concept_id and cs.codeset_id = 2)
) C


-- End Visit Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= DATEADD(day,0,P.START_DATE) AND A.END_DATE >= DATEADD(day,0,P.START_DATE) AND A.END_DATE <= P.OP_END_DATE ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id and AC.event_id = pe.event_id

) QE

;

--- Inclusion Rule Inserts

select 0 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_0
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  select PE.person_id, PE.event_id, PE.start_date, PE.end_date, PE.visit_occurrence_id, PE.sort_date FROM (
-- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria

) PE
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria
) Q
JOIN @cdm_database_schema.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria
) Q
JOIN @cdm_database_schema.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) P
JOIN (
  -- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_occurrence_id, C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM @cdm_database_schema.VISIT_OCCURRENCE vo
JOIN #Codesets cs on (vo.visit_concept_id = cs.concept_id and cs.codeset_id = 2)
) C


-- End Visit Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= DATEADD(day,0,P.START_DATE) AND A.END_DATE >= DATEADD(day,0,P.START_DATE) AND A.END_DATE <= P.OP_END_DATE ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id and AC.event_id = pe.event_id

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,-365,P.START_DATE) AND A.START_DATE <= DATEADD(day,-1,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

SELECT inclusion_rule_id, person_id, event_id
INTO #inclusion_events
FROM (select inclusion_rule_id, person_id, event_id from #Inclusion_0) I;
TRUNCATE TABLE #Inclusion_0;
DROP TABLE #Inclusion_0;


select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

  -- the matching group with all bits set ( POWER(2,# of inclusion rules) - 1 = inclusion_rule_mask
  WHERE (MG.inclusion_rule_mask = POWER(cast(2 as bigint),1)-1)

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,1,end_date) > op_end_date then op_end_date else DATEADD(day,1,end_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 0, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,0,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



-- Create a temp table of inclusion rule rows for joining in the inclusion rule impact analysis

select cast(rule_sequence as int) as rule_sequence
into #inclusion_rules
from (
  SELECT CAST(0 as int) as rule_sequence
) IR;


-- Find the event that is the 'best match' per person.  
-- the 'best match' is defined as the event that satisfies the most inclusion rules.
-- ties are solved by choosing the event that matches the earliest inclusion rule, and then earliest.

select q.person_id, q.event_id
into #best_events
from #qualified_events Q
join (
	SELECT R.person_id, R.event_id, ROW_NUMBER() OVER (PARTITION BY R.person_id ORDER BY R.rule_count DESC,R.min_rule_id ASC, R.start_date ASC) AS rank_value
	FROM (
		SELECT Q.person_id, Q.event_id, COALESCE(COUNT(DISTINCT I.inclusion_rule_id), 0) AS rule_count, COALESCE(MIN(I.inclusion_rule_id), 0) AS min_rule_id, Q.start_date
		FROM #qualified_events Q
		LEFT JOIN #inclusion_events I ON q.person_id = i.person_id AND q.event_id = i.event_id
		GROUP BY Q.person_id, Q.event_id, Q.start_date
	) R
) ranked on Q.person_id = ranked.person_id and Q.event_id = ranked.event_id
WHERE ranked.rank_value = 1
;

-- modes of generation: (the same tables store the results for the different modes, identified by the mode_id column)
-- 0: all events
-- 1: best event


-- BEGIN: Inclusion Impact Analysis - event
-- calculte matching group counts
delete from @results_database_schema.cohort_inclusion_result where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_inclusion_result (cohort_definition_id, inclusion_rule_mask, person_count, mode_id)
select @target_cohort_id as cohort_definition_id, inclusion_rule_mask, count_big(*) as person_count, 0 as mode_id
from
(
  select Q.person_id, Q.event_id, CAST(SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) AS bigint) as inclusion_rule_mask
  from #qualified_events Q
  LEFT JOIN #inclusion_events I on q.person_id = i.person_id and q.event_id = i.event_id
  GROUP BY Q.person_id, Q.event_id
) MG -- matching groups
group by inclusion_rule_mask
;

-- calculate gain counts 
delete from @results_database_schema.cohort_inclusion_stats where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_inclusion_stats (cohort_definition_id, rule_sequence, person_count, gain_count, person_total, mode_id)
select @target_cohort_id as cohort_definition_id, ir.rule_sequence, coalesce(T.person_count, 0) as person_count, coalesce(SR.person_count, 0) gain_count, EventTotal.total, 0 as mode_id
from #inclusion_rules ir
left join
(
  select i.inclusion_rule_id, count_big(i.event_id) as person_count
  from #qualified_events Q
  JOIN #inclusion_events i on Q.person_id = I.person_id and Q.event_id = i.event_id
  group by i.inclusion_rule_id
) T on ir.rule_sequence = T.inclusion_rule_id
CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
CROSS JOIN (select count_big(event_id) as total from #qualified_events) EventTotal
LEFT JOIN @results_database_schema.cohort_inclusion_result SR on SR.mode_id = 0 AND SR.cohort_definition_id = @target_cohort_id AND (POWER(cast(2 as bigint),RuleTotal.total_rules) - POWER(cast(2 as bigint),ir.rule_sequence) - 1) = SR.inclusion_rule_mask -- POWER(2,rule count) - POWER(2,rule sequence) - 1 is the mask for 'all except this rule'
;

-- calculate totals
delete from @results_database_schema.cohort_summary_stats where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_summary_stats (cohort_definition_id, base_count, final_count, mode_id)
select @target_cohort_id as cohort_definition_id, PC.total as person_count, coalesce(FC.total, 0) as final_count, 0 as mode_id
FROM
(select count_big(event_id) as total from #qualified_events) PC,
(select sum(sr.person_count) as total
  from @results_database_schema.cohort_inclusion_result sr
  CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
  where sr.mode_id = 0 and sr.cohort_definition_id = @target_cohort_id and sr.inclusion_rule_mask = POWER(cast(2 as bigint),RuleTotal.total_rules)-1
) FC
;

-- END: Inclusion Impact Analysis - event

-- BEGIN: Inclusion Impact Analysis - person
-- calculte matching group counts
delete from @results_database_schema.cohort_inclusion_result where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_inclusion_result (cohort_definition_id, inclusion_rule_mask, person_count, mode_id)
select @target_cohort_id as cohort_definition_id, inclusion_rule_mask, count_big(*) as person_count, 1 as mode_id
from
(
  select Q.person_id, Q.event_id, CAST(SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) AS bigint) as inclusion_rule_mask
  from #best_events Q
  LEFT JOIN #inclusion_events I on q.person_id = i.person_id and q.event_id = i.event_id
  GROUP BY Q.person_id, Q.event_id
) MG -- matching groups
group by inclusion_rule_mask
;

-- calculate gain counts 
delete from @results_database_schema.cohort_inclusion_stats where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_inclusion_stats (cohort_definition_id, rule_sequence, person_count, gain_count, person_total, mode_id)
select @target_cohort_id as cohort_definition_id, ir.rule_sequence, coalesce(T.person_count, 0) as person_count, coalesce(SR.person_count, 0) gain_count, EventTotal.total, 1 as mode_id
from #inclusion_rules ir
left join
(
  select i.inclusion_rule_id, count_big(i.event_id) as person_count
  from #best_events Q
  JOIN #inclusion_events i on Q.person_id = I.person_id and Q.event_id = i.event_id
  group by i.inclusion_rule_id
) T on ir.rule_sequence = T.inclusion_rule_id
CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
CROSS JOIN (select count_big(event_id) as total from #best_events) EventTotal
LEFT JOIN @results_database_schema.cohort_inclusion_result SR on SR.mode_id = 1 AND SR.cohort_definition_id = @target_cohort_id AND (POWER(cast(2 as bigint),RuleTotal.total_rules) - POWER(cast(2 as bigint),ir.rule_sequence) - 1) = SR.inclusion_rule_mask -- POWER(2,rule count) - POWER(2,rule sequence) - 1 is the mask for 'all except this rule'
;

-- calculate totals
delete from @results_database_schema.cohort_summary_stats where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_summary_stats (cohort_definition_id, base_count, final_count, mode_id)
select @target_cohort_id as cohort_definition_id, PC.total as person_count, coalesce(FC.total, 0) as final_count, 1 as mode_id
FROM
(select count_big(event_id) as total from #best_events) PC,
(select sum(sr.person_count) as total
  from @results_database_schema.cohort_inclusion_result sr
  CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
  where sr.mode_id = 1 and sr.cohort_definition_id = @target_cohort_id and sr.inclusion_rule_mask = POWER(cast(2 as bigint),RuleTotal.total_rules)-1
) FC
;

-- END: Inclusion Impact Analysis - person

TRUNCATE TABLE #best_events;
DROP TABLE #best_events;

TRUNCATE TABLE #inclusion_rules;
DROP TABLE #inclusion_rules;


TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",249,FALSE,
251,"[P] Acute pancreatitis (7Pe, 180Era)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""VisitOccurrence"" : {
					""CorrelatedCriteria"" : {
						""Type"" : ""AT_LEAST"",
						""Count"" : 1,
						""CriteriaList"" : [
							{
								""Criteria"" : {
									""ConditionOccurrence"" : {
										""CodesetId"" : 15,
										""ConditionTypeExclude"" : false
									}
								},
								""StartWindow"" : {
									""Start"" : {
										""Coeff"" : -1
									},
									""End"" : {
										""Days"" : 0,
										""Coeff"" : -1
									},
									""UseIndexEnd"" : true,
									""UseEventEnd"" : false
								},
								""EndWindow"" : {
									""Start"" : {
										""Days"" : 0,
										""Coeff"" : 1
									},
									""End"" : {
										""Coeff"" : 1
									},
									""UseIndexEnd"" : false,
									""UseEventEnd"" : false
								},
								""RestrictVisit"" : false,
								""IgnoreObservationPeriod"" : false,
								""Occurrence"" : {
									""Type"" : 2,
									""Count"" : 1,
									""IsDistinct"" : false
								}
							}
						],
						""DemographicCriteriaList"" : [],
						""Groups"" : []
					},
					""CodesetId"" : 16,
					""VisitTypeExclude"" : false
				}
			},
			{
				""VisitOccurrence"" : {
					""CorrelatedCriteria"" : {
						""Type"" : ""ALL"",
						""CriteriaList"" : [
							{
								""Criteria"" : {
									""ProcedureOccurrence"" : {
										""CodesetId"" : 21,
										""ProcedureTypeExclude"" : false
									}
								},
								""StartWindow"" : {
									""Start"" : {
										""Coeff"" : -1
									},
									""End"" : {
										""Days"" : 0,
										""Coeff"" : -1
									},
									""UseIndexEnd"" : true,
									""UseEventEnd"" : false
								},
								""EndWindow"" : {
									""Start"" : {
										""Days"" : 0,
										""Coeff"" : 1
									},
									""End"" : {
										""Coeff"" : 1
									},
									""UseIndexEnd"" : false,
									""UseEventEnd"" : false
								},
								""RestrictVisit"" : false,
								""IgnoreObservationPeriod"" : false,
								""Occurrence"" : {
									""Type"" : 2,
									""Count"" : 1,
									""IsDistinct"" : false
								}
							},
							{
								""Criteria"" : {
									""ConditionOccurrence"" : {
										""CodesetId"" : 15,
										""ConditionTypeExclude"" : false
									}
								},
								""StartWindow"" : {
									""Start"" : {
										""Coeff"" : -1
									},
									""End"" : {
										""Days"" : 0,
										""Coeff"" : -1
									},
									""UseIndexEnd"" : false,
									""UseEventEnd"" : false
								},
								""EndWindow"" : {
									""Start"" : {
										""Days"" : 0,
										""Coeff"" : 1
									},
									""End"" : {
										""Coeff"" : 1
									},
									""UseIndexEnd"" : false,
									""UseEventEnd"" : false
								},
								""RestrictVisit"" : false,
								""IgnoreObservationPeriod"" : false,
								""Occurrence"" : {
									""Type"" : 2,
									""Count"" : 1,
									""IsDistinct"" : false
								}
							}
						],
						""DemographicCriteriaList"" : [],
						""Groups"" : []
					},
					""CodesetId"" : 20,
					""VisitTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""ConceptSets"" : [
		{
			""id"" : 15,
			""name"" : ""Pancreatitis"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 4192640,
							""CONCEPT_NAME"" : ""Pancreatitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""75694006"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 16,
			""name"" : ""Inpatient or Inpatient/ER visit"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 262,
							""CONCEPT_NAME"" : ""Emergency Room and Inpatient Visit"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""ERIP"",
							""DOMAIN_ID"" : ""Visit"",
							""VOCABULARY_ID"" : ""Visit"",
							""CONCEPT_CLASS_ID"" : ""Visit""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 9201,
							""CONCEPT_NAME"" : ""Inpatient Visit"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""IP"",
							""DOMAIN_ID"" : ""Visit"",
							""VOCABULARY_ID"" : ""Visit"",
							""CONCEPT_CLASS_ID"" : ""Visit""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 9203,
							""CONCEPT_NAME"" : ""Emergency Room Visit"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""ER"",
							""DOMAIN_ID"" : ""Visit"",
							""VOCABULARY_ID"" : ""Visit"",
							""CONCEPT_CLASS_ID"" : ""Visit""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 17,
			""name"" : ""Acute Pancreatitis"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 199074,
							""CONCEPT_NAME"" : ""Acute pancreatitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""197456007"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4341076,
							""CONCEPT_NAME"" : ""Pancreatic and peripancreatic necrosis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""235959006"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4192640,
							""CONCEPT_NAME"" : ""Pancreatitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""75694006"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4243504,
							""CONCEPT_NAME"" : ""Subacute pancreatitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""59154002"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 195596,
							""CONCEPT_NAME"" : ""Chronic pancreatitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""235494005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 18,
			""name"" : ""Chronic Pancreatitis"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 195596,
							""CONCEPT_NAME"" : ""Chronic pancreatitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""235494005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36715932,
							""CONCEPT_NAME"" : ""Acute on chronic pancreatitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""721724009"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 19,
			""name"" : ""Hereditary Pancreatitis"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 4194916,
							""CONCEPT_NAME"" : ""Hereditary pancreatitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""68072000"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 20,
			""name"" : ""outpatient visit"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 9202,
							""CONCEPT_NAME"" : ""Outpatient Visit"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OP"",
							""DOMAIN_ID"" : ""Visit"",
							""VOCABULARY_ID"" : ""Visit"",
							""CONCEPT_CLASS_ID"" : ""Visit""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 21,
			""name"" : ""Emergency room visit as a procedure"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 2514436,
							""CONCEPT_NAME"" : ""Emergency department visit for the evaluation and management of a patient, which requires these 3 key components: A detailed history; A detailed examination; and Medical decision making of moderate complexity. Counseling and/or coordination of care with o"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""99284"",
							""DOMAIN_ID"" : ""Procedure"",
							""VOCABULARY_ID"" : ""CPT4"",
							""CONCEPT_CLASS_ID"" : ""CPT4""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 2514434,
							""CONCEPT_NAME"" : ""Emergency department visit for the evaluation and management of a patient, which requires these 3 key components: An expanded problem focused history; An expanded problem focused examination; and Medical decision making of low complexity. Counseling and/o"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""99282"",
							""DOMAIN_ID"" : ""Procedure"",
							""VOCABULARY_ID"" : ""CPT4"",
							""CONCEPT_CLASS_ID"" : ""CPT4""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 2514435,
							""CONCEPT_NAME"" : ""Emergency department visit for the evaluation and management of a patient, which requires these 3 key components: An expanded problem focused history; An expanded problem focused examination; and Medical decision making of moderate complexity. Counseling "",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""99283"",
							""DOMAIN_ID"" : ""Procedure"",
							""VOCABULARY_ID"" : ""CPT4"",
							""CONCEPT_CLASS_ID"" : ""CPT4""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 2514433,
							""CONCEPT_NAME"" : ""Emergency department visit for the evaluation and management of a patient, which requires these 3 key components: A problem focused history; A problem focused examination; and Straightforward medical decision making. Counseling and/or coordination of care"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""99281"",
							""DOMAIN_ID"" : ""Procedure"",
							""VOCABULARY_ID"" : ""CPT4"",
							""CONCEPT_CLASS_ID"" : ""CPT4""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 2514437,
							""CONCEPT_NAME"" : ""Emergency department visit for the evaluation and management of a patient, which requires these 3 key components within the constraints imposed by the urgency of the patient's clinical condition and/or mental status: A comprehensive history; A comprehensi"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""99285"",
							""DOMAIN_ID"" : ""Procedure"",
							""VOCABULARY_ID"" : ""CPT4"",
							""CONCEPT_CLASS_ID"" : ""CPT4""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""First""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [
		{
			""name"" : ""Should have Acute Pancreatitis within 1 day"",
			""description"" : ""Includes unspecified pancreatitis code without descendants"",
			""expression"" : {
				""Type"" : ""ALL"",
				""CriteriaList"" : [
					{
						""Criteria"" : {
							""ConditionOccurrence"" : {
								""CodesetId"" : 17,
								""ConditionTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Days"" : 0,
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 1,
								""Coeff"" : 1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : true,
						""Occurrence"" : {
							""Type"" : 2,
							""Count"" : 1,
							""IsDistinct"" : false
						}
					}
				],
				""DemographicCriteriaList"" : [],
				""Groups"" : []
			}
		},
		{
			""name"" : ""Should NOT have Chronic Pancreatitis on or before Acute Pancreatitis"",
			""description"" : ""Includes index date."",
			""expression"" : {
				""Type"" : ""ALL"",
				""CriteriaList"" : [
					{
						""Criteria"" : {
							""ConditionOccurrence"" : {
								""CodesetId"" : 18,
								""ConditionTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 0,
								""Coeff"" : -1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : true,
						""Occurrence"" : {
							""Type"" : 0,
							""Count"" : 0,
							""IsDistinct"" : false
						}
					}
				],
				""DemographicCriteriaList"" : [],
				""Groups"" : []
			}
		},
		{
			""name"" : ""Should NOT have Hereditary Pancreatitis any time"",
			""description"" : ""Any time in persons observation period"",
			""expression"" : {
				""Type"" : ""ALL"",
				""CriteriaList"" : [
					{
						""Criteria"" : {
							""ConditionOccurrence"" : {
								""CodesetId"" : 19,
								""ConditionTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Coeff"" : -1
							},
							""End"" : {
								""Coeff"" : -1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : true,
						""Occurrence"" : {
							""Type"" : 0,
							""Count"" : 0,
							""IsDistinct"" : false
						}
					}
				],
				""DemographicCriteriaList"" : [],
				""Groups"" : []
			}
		}
	],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""EndDate"",
			""Offset"" : 7
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 180
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 15 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4192640)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4192640)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 16 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (262,9201,9203)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (262,9201,9203)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 17 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (199074,4341076,4192640)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (199074,4341076)
  and c.invalid_reason is null

) I
LEFT JOIN
(
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4243504,195596)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4243504,195596)
  and c.invalid_reason is null

) E ON I.concept_id = E.concept_id
WHERE E.concept_id is null
) C UNION ALL 
SELECT 18 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (195596,36715932)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (195596,36715932)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 19 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4194916)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4194916)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 20 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (9202)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (9202)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 21 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (2514436,2514434,2514435,2514433,2514437)

) I
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  select PE.person_id, PE.event_id, PE.start_date, PE.end_date, PE.visit_occurrence_id, PE.sort_date FROM (
-- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_occurrence_id, C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM @cdm_database_schema.VISIT_OCCURRENCE vo
JOIN #Codesets cs on (vo.visit_concept_id = cs.concept_id and cs.codeset_id = 16)
) C


-- End Visit Occurrence Criteria

) PE
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_occurrence_id, C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM @cdm_database_schema.VISIT_OCCURRENCE vo
JOIN #Codesets cs on (vo.visit_concept_id = cs.concept_id and cs.codeset_id = 16)
) C


-- End Visit Occurrence Criteria
) Q
JOIN @cdm_database_schema.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_occurrence_id, C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM @cdm_database_schema.VISIT_OCCURRENCE vo
JOIN #Codesets cs on (vo.visit_concept_id = cs.concept_id and cs.codeset_id = 16)
) C


-- End Visit Occurrence Criteria
) Q
JOIN @cdm_database_schema.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 15)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= DATEADD(day,0,P.END_DATE) AND A.START_DATE >= DATEADD(day,0,P.START_DATE) AND A.START_DATE <= P.OP_END_DATE ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) >= 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id and AC.event_id = pe.event_id

UNION ALL
select PE.person_id, PE.event_id, PE.start_date, PE.end_date, PE.visit_occurrence_id, PE.sort_date FROM (
-- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_occurrence_id, C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM @cdm_database_schema.VISIT_OCCURRENCE vo
JOIN #Codesets cs on (vo.visit_concept_id = cs.concept_id and cs.codeset_id = 20)
) C


-- End Visit Occurrence Criteria

) PE
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_occurrence_id, C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM @cdm_database_schema.VISIT_OCCURRENCE vo
JOIN #Codesets cs on (vo.visit_concept_id = cs.concept_id and cs.codeset_id = 20)
) C


-- End Visit Occurrence Criteria
) Q
JOIN @cdm_database_schema.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_occurrence_id, C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM @cdm_database_schema.VISIT_OCCURRENCE vo
JOIN #Codesets cs on (vo.visit_concept_id = cs.concept_id and cs.codeset_id = 20)
) C


-- End Visit Occurrence Criteria
) Q
JOIN @cdm_database_schema.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) P
JOIN (
  -- Begin Procedure Occurrence Criteria
select C.person_id, C.procedure_occurrence_id as event_id, C.procedure_date as start_date, DATEADD(d,1,C.procedure_date) as END_DATE,
       C.visit_occurrence_id, C.procedure_date as sort_date
from 
(
  select po.* 
  FROM @cdm_database_schema.PROCEDURE_OCCURRENCE po
JOIN #Codesets cs on (po.procedure_concept_id = cs.concept_id and cs.codeset_id = 21)
) C


-- End Procedure Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= DATEADD(day,0,P.END_DATE) AND A.START_DATE >= DATEADD(day,0,P.START_DATE) AND A.START_DATE <= P.OP_END_DATE ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

UNION ALL
-- Begin Correlated Criteria
select 1 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_occurrence_id, C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM @cdm_database_schema.VISIT_OCCURRENCE vo
JOIN #Codesets cs on (vo.visit_concept_id = cs.concept_id and cs.codeset_id = 20)
) C


-- End Visit Occurrence Criteria
) Q
JOIN @cdm_database_schema.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 15)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= DATEADD(day,0,P.START_DATE) AND A.START_DATE >= DATEADD(day,0,P.START_DATE) AND A.START_DATE <= P.OP_END_DATE ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 2
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id and AC.event_id = pe.event_id

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

select 0 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_0
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 17)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,0,P.START_DATE) AND A.START_DATE <= DATEADD(day,1,P.START_DATE) ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

select 1 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_1
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 18)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE <= DATEADD(day,0,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

select 2 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_2
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 19)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

SELECT inclusion_rule_id, person_id, event_id
INTO #inclusion_events
FROM (select inclusion_rule_id, person_id, event_id from #Inclusion_0
UNION ALL
select inclusion_rule_id, person_id, event_id from #Inclusion_1
UNION ALL
select inclusion_rule_id, person_id, event_id from #Inclusion_2) I;
TRUNCATE TABLE #Inclusion_0;
DROP TABLE #Inclusion_0;

TRUNCATE TABLE #Inclusion_1;
DROP TABLE #Inclusion_1;

TRUNCATE TABLE #Inclusion_2;
DROP TABLE #Inclusion_2;


select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

  -- the matching group with all bits set ( POWER(2,# of inclusion rules) - 1 = inclusion_rule_mask
  WHERE (MG.inclusion_rule_mask = POWER(cast(2 as bigint),3)-1)

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,7,end_date) > op_end_date then op_end_date else DATEADD(day,7,end_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 180, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,180,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



-- Create a temp table of inclusion rule rows for joining in the inclusion rule impact analysis

select cast(rule_sequence as int) as rule_sequence
into #inclusion_rules
from (
  SELECT CAST(0 as int) as rule_sequence UNION ALL SELECT CAST(1 as int) as rule_sequence UNION ALL SELECT CAST(2 as int) as rule_sequence
) IR;


-- Find the event that is the 'best match' per person.  
-- the 'best match' is defined as the event that satisfies the most inclusion rules.
-- ties are solved by choosing the event that matches the earliest inclusion rule, and then earliest.

select q.person_id, q.event_id
into #best_events
from #qualified_events Q
join (
	SELECT R.person_id, R.event_id, ROW_NUMBER() OVER (PARTITION BY R.person_id ORDER BY R.rule_count DESC,R.min_rule_id ASC, R.start_date ASC) AS rank_value
	FROM (
		SELECT Q.person_id, Q.event_id, COALESCE(COUNT(DISTINCT I.inclusion_rule_id), 0) AS rule_count, COALESCE(MIN(I.inclusion_rule_id), 0) AS min_rule_id, Q.start_date
		FROM #qualified_events Q
		LEFT JOIN #inclusion_events I ON q.person_id = i.person_id AND q.event_id = i.event_id
		GROUP BY Q.person_id, Q.event_id, Q.start_date
	) R
) ranked on Q.person_id = ranked.person_id and Q.event_id = ranked.event_id
WHERE ranked.rank_value = 1
;

-- modes of generation: (the same tables store the results for the different modes, identified by the mode_id column)
-- 0: all events
-- 1: best event


-- BEGIN: Inclusion Impact Analysis - event
-- calculte matching group counts
delete from @results_database_schema.cohort_inclusion_result where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_inclusion_result (cohort_definition_id, inclusion_rule_mask, person_count, mode_id)
select @target_cohort_id as cohort_definition_id, inclusion_rule_mask, count_big(*) as person_count, 0 as mode_id
from
(
  select Q.person_id, Q.event_id, CAST(SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) AS bigint) as inclusion_rule_mask
  from #qualified_events Q
  LEFT JOIN #inclusion_events I on q.person_id = i.person_id and q.event_id = i.event_id
  GROUP BY Q.person_id, Q.event_id
) MG -- matching groups
group by inclusion_rule_mask
;

-- calculate gain counts 
delete from @results_database_schema.cohort_inclusion_stats where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_inclusion_stats (cohort_definition_id, rule_sequence, person_count, gain_count, person_total, mode_id)
select @target_cohort_id as cohort_definition_id, ir.rule_sequence, coalesce(T.person_count, 0) as person_count, coalesce(SR.person_count, 0) gain_count, EventTotal.total, 0 as mode_id
from #inclusion_rules ir
left join
(
  select i.inclusion_rule_id, count_big(i.event_id) as person_count
  from #qualified_events Q
  JOIN #inclusion_events i on Q.person_id = I.person_id and Q.event_id = i.event_id
  group by i.inclusion_rule_id
) T on ir.rule_sequence = T.inclusion_rule_id
CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
CROSS JOIN (select count_big(event_id) as total from #qualified_events) EventTotal
LEFT JOIN @results_database_schema.cohort_inclusion_result SR on SR.mode_id = 0 AND SR.cohort_definition_id = @target_cohort_id AND (POWER(cast(2 as bigint),RuleTotal.total_rules) - POWER(cast(2 as bigint),ir.rule_sequence) - 1) = SR.inclusion_rule_mask -- POWER(2,rule count) - POWER(2,rule sequence) - 1 is the mask for 'all except this rule'
;

-- calculate totals
delete from @results_database_schema.cohort_summary_stats where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_summary_stats (cohort_definition_id, base_count, final_count, mode_id)
select @target_cohort_id as cohort_definition_id, PC.total as person_count, coalesce(FC.total, 0) as final_count, 0 as mode_id
FROM
(select count_big(event_id) as total from #qualified_events) PC,
(select sum(sr.person_count) as total
  from @results_database_schema.cohort_inclusion_result sr
  CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
  where sr.mode_id = 0 and sr.cohort_definition_id = @target_cohort_id and sr.inclusion_rule_mask = POWER(cast(2 as bigint),RuleTotal.total_rules)-1
) FC
;

-- END: Inclusion Impact Analysis - event

-- BEGIN: Inclusion Impact Analysis - person
-- calculte matching group counts
delete from @results_database_schema.cohort_inclusion_result where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_inclusion_result (cohort_definition_id, inclusion_rule_mask, person_count, mode_id)
select @target_cohort_id as cohort_definition_id, inclusion_rule_mask, count_big(*) as person_count, 1 as mode_id
from
(
  select Q.person_id, Q.event_id, CAST(SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) AS bigint) as inclusion_rule_mask
  from #best_events Q
  LEFT JOIN #inclusion_events I on q.person_id = i.person_id and q.event_id = i.event_id
  GROUP BY Q.person_id, Q.event_id
) MG -- matching groups
group by inclusion_rule_mask
;

-- calculate gain counts 
delete from @results_database_schema.cohort_inclusion_stats where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_inclusion_stats (cohort_definition_id, rule_sequence, person_count, gain_count, person_total, mode_id)
select @target_cohort_id as cohort_definition_id, ir.rule_sequence, coalesce(T.person_count, 0) as person_count, coalesce(SR.person_count, 0) gain_count, EventTotal.total, 1 as mode_id
from #inclusion_rules ir
left join
(
  select i.inclusion_rule_id, count_big(i.event_id) as person_count
  from #best_events Q
  JOIN #inclusion_events i on Q.person_id = I.person_id and Q.event_id = i.event_id
  group by i.inclusion_rule_id
) T on ir.rule_sequence = T.inclusion_rule_id
CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
CROSS JOIN (select count_big(event_id) as total from #best_events) EventTotal
LEFT JOIN @results_database_schema.cohort_inclusion_result SR on SR.mode_id = 1 AND SR.cohort_definition_id = @target_cohort_id AND (POWER(cast(2 as bigint),RuleTotal.total_rules) - POWER(cast(2 as bigint),ir.rule_sequence) - 1) = SR.inclusion_rule_mask -- POWER(2,rule count) - POWER(2,rule sequence) - 1 is the mask for 'all except this rule'
;

-- calculate totals
delete from @results_database_schema.cohort_summary_stats where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_summary_stats (cohort_definition_id, base_count, final_count, mode_id)
select @target_cohort_id as cohort_definition_id, PC.total as person_count, coalesce(FC.total, 0) as final_count, 1 as mode_id
FROM
(select count_big(event_id) as total from #best_events) PC,
(select sum(sr.person_count) as total
  from @results_database_schema.cohort_inclusion_result sr
  CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
  where sr.mode_id = 1 and sr.cohort_definition_id = @target_cohort_id and sr.inclusion_rule_mask = POWER(cast(2 as bigint),RuleTotal.total_rules)-1
) FC
;

-- END: Inclusion Impact Analysis - person

TRUNCATE TABLE #best_events;
DROP TABLE #best_events;

TRUNCATE TABLE #inclusion_rules;
DROP TABLE #inclusion_rules;


TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",251,FALSE,
258,"[P] Anaphylaxis or Anaphylactic shock events (1Pe, 30Era)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 0,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""ConceptSets"" : [
		{
			""id"" : 0,
			""name"" : ""Anaphylaxis or Anaphylactic shock due to serum"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 441202,
							""CONCEPT_NAME"" : ""Anaphylaxis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""39579001"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 442038,
							""CONCEPT_NAME"" : ""Anaphylactic shock due to serum"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""213320003"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""All""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""EndDate"",
			""Offset"" : 1
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 30
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 0 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (441202,442038)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (442038)
  and c.invalid_reason is null

) I
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 0)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,1,end_date) > op_end_date then op_end_date else DATEADD(day,1,end_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 30, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,30,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",258,FALSE,
284,"[P] Myocarditis or Pericarditis (30Pe, 90Era)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 1,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""ConceptSets"" : [
		{
			""id"" : 1,
			""name"" : ""Myocarditis Pericarditis"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 4289908,
							""CONCEPT_NAME"" : ""Viral pericarditis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""70189005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 314383,
							""CONCEPT_NAME"" : ""Myocarditis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""50920009"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 318072,
							""CONCEPT_NAME"" : ""Histoplasmosis with pericarditis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""187059008"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 44782774,
							""CONCEPT_NAME"" : ""Chest pain due to pericarditis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""34791000119103"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4138837,
							""CONCEPT_NAME"" : ""Pericarditis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""3238004"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4149913,
							""CONCEPT_NAME"" : ""Systemic lupus erythematosus with pericarditis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""309762007"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""All""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""EndDate"",
			""Offset"" : 30
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 90
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 1 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4289908,314383,318072,44782774,4138837,4149913)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4289908,314383,318072,44782774,4138837,4149913)
  and c.invalid_reason is null

) I
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 1)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,30,end_date) > op_end_date then op_end_date else DATEADD(day,30,end_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 90, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,90,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",284,FALSE,
292,"[P] Hepatic Failure (365Pe, 365Era)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 33,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""ConceptSets"" : [
		{
			""id"" : 21,
			""name"" : ""\nchronic Hepatic Failure\n"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 4340390,
							""CONCEPT_NAME"" : ""Chronic hepatic failure"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""235886005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 33,
			""name"" : ""Acute Hepatic Failure"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 4029488,
							""CONCEPT_NAME"" : ""Hepatic encephalopathy"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""13920009"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4245975,
							""CONCEPT_NAME"" : ""Hepatic failure"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""59927004"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4340390,
							""CONCEPT_NAME"" : ""Chronic hepatic failure"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""235886005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""First""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [
		{
			""name"" : ""have no chronic hepatic failure on the day of diagnosis "",
			""expression"" : {
				""Type"" : ""ALL"",
				""CriteriaList"" : [
					{
						""Criteria"" : {
							""ConditionOccurrence"" : {
								""CodesetId"" : 21,
								""ConditionTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Days"" : 0,
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 0,
								""Coeff"" : 1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : false,
						""Occurrence"" : {
							""Type"" : 0,
							""Count"" : 0,
							""IsDistinct"" : false
						}
					}
				],
				""DemographicCriteriaList"" : [],
				""Groups"" : []
			}
		}
	],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""EndDate"",
			""Offset"" : 365
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 365
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 21 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4340390)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4340390)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 33 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4029488,4245975)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4029488,4245975)
  and c.invalid_reason is null

) I
LEFT JOIN
(
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4340390)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4340390)
  and c.invalid_reason is null

) E ON I.concept_id = E.concept_id
WHERE E.concept_id is null
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 33)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

select 0 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_0
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 21)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= DATEADD(day,0,P.START_DATE) AND A.START_DATE <= DATEADD(day,0,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

SELECT inclusion_rule_id, person_id, event_id
INTO #inclusion_events
FROM (select inclusion_rule_id, person_id, event_id from #Inclusion_0) I;
TRUNCATE TABLE #Inclusion_0;
DROP TABLE #Inclusion_0;


select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

  -- the matching group with all bits set ( POWER(2,# of inclusion rules) - 1 = inclusion_rule_mask
  WHERE (MG.inclusion_rule_mask = POWER(cast(2 as bigint),1)-1)

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,365,end_date) > op_end_date then op_end_date else DATEADD(day,365,end_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 365, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,365,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



-- Create a temp table of inclusion rule rows for joining in the inclusion rule impact analysis

select cast(rule_sequence as int) as rule_sequence
into #inclusion_rules
from (
  SELECT CAST(0 as int) as rule_sequence
) IR;


-- Find the event that is the 'best match' per person.  
-- the 'best match' is defined as the event that satisfies the most inclusion rules.
-- ties are solved by choosing the event that matches the earliest inclusion rule, and then earliest.

select q.person_id, q.event_id
into #best_events
from #qualified_events Q
join (
	SELECT R.person_id, R.event_id, ROW_NUMBER() OVER (PARTITION BY R.person_id ORDER BY R.rule_count DESC,R.min_rule_id ASC, R.start_date ASC) AS rank_value
	FROM (
		SELECT Q.person_id, Q.event_id, COALESCE(COUNT(DISTINCT I.inclusion_rule_id), 0) AS rule_count, COALESCE(MIN(I.inclusion_rule_id), 0) AS min_rule_id, Q.start_date
		FROM #qualified_events Q
		LEFT JOIN #inclusion_events I ON q.person_id = i.person_id AND q.event_id = i.event_id
		GROUP BY Q.person_id, Q.event_id, Q.start_date
	) R
) ranked on Q.person_id = ranked.person_id and Q.event_id = ranked.event_id
WHERE ranked.rank_value = 1
;

-- modes of generation: (the same tables store the results for the different modes, identified by the mode_id column)
-- 0: all events
-- 1: best event


-- BEGIN: Inclusion Impact Analysis - event
-- calculte matching group counts
delete from @results_database_schema.cohort_inclusion_result where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_inclusion_result (cohort_definition_id, inclusion_rule_mask, person_count, mode_id)
select @target_cohort_id as cohort_definition_id, inclusion_rule_mask, count_big(*) as person_count, 0 as mode_id
from
(
  select Q.person_id, Q.event_id, CAST(SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) AS bigint) as inclusion_rule_mask
  from #qualified_events Q
  LEFT JOIN #inclusion_events I on q.person_id = i.person_id and q.event_id = i.event_id
  GROUP BY Q.person_id, Q.event_id
) MG -- matching groups
group by inclusion_rule_mask
;

-- calculate gain counts 
delete from @results_database_schema.cohort_inclusion_stats where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_inclusion_stats (cohort_definition_id, rule_sequence, person_count, gain_count, person_total, mode_id)
select @target_cohort_id as cohort_definition_id, ir.rule_sequence, coalesce(T.person_count, 0) as person_count, coalesce(SR.person_count, 0) gain_count, EventTotal.total, 0 as mode_id
from #inclusion_rules ir
left join
(
  select i.inclusion_rule_id, count_big(i.event_id) as person_count
  from #qualified_events Q
  JOIN #inclusion_events i on Q.person_id = I.person_id and Q.event_id = i.event_id
  group by i.inclusion_rule_id
) T on ir.rule_sequence = T.inclusion_rule_id
CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
CROSS JOIN (select count_big(event_id) as total from #qualified_events) EventTotal
LEFT JOIN @results_database_schema.cohort_inclusion_result SR on SR.mode_id = 0 AND SR.cohort_definition_id = @target_cohort_id AND (POWER(cast(2 as bigint),RuleTotal.total_rules) - POWER(cast(2 as bigint),ir.rule_sequence) - 1) = SR.inclusion_rule_mask -- POWER(2,rule count) - POWER(2,rule sequence) - 1 is the mask for 'all except this rule'
;

-- calculate totals
delete from @results_database_schema.cohort_summary_stats where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_summary_stats (cohort_definition_id, base_count, final_count, mode_id)
select @target_cohort_id as cohort_definition_id, PC.total as person_count, coalesce(FC.total, 0) as final_count, 0 as mode_id
FROM
(select count_big(event_id) as total from #qualified_events) PC,
(select sum(sr.person_count) as total
  from @results_database_schema.cohort_inclusion_result sr
  CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
  where sr.mode_id = 0 and sr.cohort_definition_id = @target_cohort_id and sr.inclusion_rule_mask = POWER(cast(2 as bigint),RuleTotal.total_rules)-1
) FC
;

-- END: Inclusion Impact Analysis - event

-- BEGIN: Inclusion Impact Analysis - person
-- calculte matching group counts
delete from @results_database_schema.cohort_inclusion_result where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_inclusion_result (cohort_definition_id, inclusion_rule_mask, person_count, mode_id)
select @target_cohort_id as cohort_definition_id, inclusion_rule_mask, count_big(*) as person_count, 1 as mode_id
from
(
  select Q.person_id, Q.event_id, CAST(SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) AS bigint) as inclusion_rule_mask
  from #best_events Q
  LEFT JOIN #inclusion_events I on q.person_id = i.person_id and q.event_id = i.event_id
  GROUP BY Q.person_id, Q.event_id
) MG -- matching groups
group by inclusion_rule_mask
;

-- calculate gain counts 
delete from @results_database_schema.cohort_inclusion_stats where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_inclusion_stats (cohort_definition_id, rule_sequence, person_count, gain_count, person_total, mode_id)
select @target_cohort_id as cohort_definition_id, ir.rule_sequence, coalesce(T.person_count, 0) as person_count, coalesce(SR.person_count, 0) gain_count, EventTotal.total, 1 as mode_id
from #inclusion_rules ir
left join
(
  select i.inclusion_rule_id, count_big(i.event_id) as person_count
  from #best_events Q
  JOIN #inclusion_events i on Q.person_id = I.person_id and Q.event_id = i.event_id
  group by i.inclusion_rule_id
) T on ir.rule_sequence = T.inclusion_rule_id
CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
CROSS JOIN (select count_big(event_id) as total from #best_events) EventTotal
LEFT JOIN @results_database_schema.cohort_inclusion_result SR on SR.mode_id = 1 AND SR.cohort_definition_id = @target_cohort_id AND (POWER(cast(2 as bigint),RuleTotal.total_rules) - POWER(cast(2 as bigint),ir.rule_sequence) - 1) = SR.inclusion_rule_mask -- POWER(2,rule count) - POWER(2,rule sequence) - 1 is the mask for 'all except this rule'
;

-- calculate totals
delete from @results_database_schema.cohort_summary_stats where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_summary_stats (cohort_definition_id, base_count, final_count, mode_id)
select @target_cohort_id as cohort_definition_id, PC.total as person_count, coalesce(FC.total, 0) as final_count, 1 as mode_id
FROM
(select count_big(event_id) as total from #best_events) PC,
(select sum(sr.person_count) as total
  from @results_database_schema.cohort_inclusion_result sr
  CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
  where sr.mode_id = 1 and sr.cohort_definition_id = @target_cohort_id and sr.inclusion_rule_mask = POWER(cast(2 as bigint),RuleTotal.total_rules)-1
) FC
;

-- END: Inclusion Impact Analysis - person

TRUNCATE TABLE #best_events;
DROP TABLE #best_events;

TRUNCATE TABLE #inclusion_rules;
DROP TABLE #inclusion_rules;


TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",292,FALSE,
329,"[P] Pneumonitis and lung infections (14Pe, 30Era)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 2,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""ConceptSets"" : [
		{
			""id"" : 2,
			""name"" : ""Pneumonitis and Lung Infections"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 257010,
							""CONCEPT_NAME"" : ""Abscess of lung"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""73452002"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4028389,
							""CONCEPT_NAME"" : ""Infectious disease of lung"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""128601007"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4318404,
							""CONCEPT_NAME"" : ""Lung consolidation"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""95436008"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 253506,
							""CONCEPT_NAME"" : ""Pneumonitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""205237003"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""All""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""EndDate"",
			""Offset"" : 14
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 30
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 2 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (257010,4028389,4318404,253506)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (257010,4028389,4318404,253506)
  and c.invalid_reason is null

) I
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 2)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,14,end_date) > op_end_date then op_end_date else DATEADD(day,14,end_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 30, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,30,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",329,FALSE,
356,"[P] Epistaxis (3Pe, 7Era)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 0,
					""ConditionTypeExclude"" : false
				}
			},
			{
				""ProcedureOccurrence"" : {
					""CodesetId"" : 1,
					""ProcedureTypeExclude"" : false
				}
			},
			{
				""Observation"" : {
					""CodesetId"" : 1,
					""ObservationTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""ConceptSets"" : [
		{
			""id"" : 0,
			""name"" : ""Epistaxis"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 4051478,
							""CONCEPT_NAME"" : ""Posterior epistaxis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""232355001"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4049224,
							""CONCEPT_NAME"" : ""Anterior epistaxis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""232354002"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4082142,
							""CONCEPT_NAME"" : ""Evidence of recent epistaxis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""277236000"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4096682,
							""CONCEPT_NAME"" : ""Bleeding from nose"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""249366005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 1,
			""name"" : ""Epistaxis procedures"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 45768610,
							""CONCEPT_NAME"" : ""Epistaxis care"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""707076002"",
							""DOMAIN_ID"" : ""Observation"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4262407,
							""CONCEPT_NAME"" : ""Control of hemorrhage of nose"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""35807001"",
							""DOMAIN_ID"" : ""Procedure"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4055146,
							""CONCEPT_NAME"" : ""Packing of nose for anterior epistaxis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""242906003"",
							""DOMAIN_ID"" : ""Procedure"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 45772698,
							""CONCEPT_NAME"" : ""Epistaxis care management"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""704134002"",
							""DOMAIN_ID"" : ""Procedure"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""First""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""EndDate"",
			""Offset"" : 3
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 7
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 0 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4051478,4049224,4082142,4096682)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4051478,4049224,4082142,4096682)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 1 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (45768610,4262407,4055146,45772698)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (45768610,4262407,4055146,45772698)
  and c.invalid_reason is null

) I
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 0)
) C


-- End Condition Occurrence Criteria

UNION ALL
-- Begin Procedure Occurrence Criteria
select C.person_id, C.procedure_occurrence_id as event_id, C.procedure_date as start_date, DATEADD(d,1,C.procedure_date) as END_DATE,
       C.visit_occurrence_id, C.procedure_date as sort_date
from 
(
  select po.* 
  FROM @cdm_database_schema.PROCEDURE_OCCURRENCE po
JOIN #Codesets cs on (po.procedure_concept_id = cs.concept_id and cs.codeset_id = 1)
) C


-- End Procedure Occurrence Criteria

UNION ALL
-- Begin Observation Criteria
select C.person_id, C.observation_id as event_id, C.observation_date as start_date, DATEADD(d,1,C.observation_date) as END_DATE,
       C.visit_occurrence_id, C.observation_date as sort_date
from 
(
  select o.* 
  FROM @cdm_database_schema.OBSERVATION o
JOIN #Codesets cs on (o.observation_concept_id = cs.concept_id and cs.codeset_id = 1)
) C


-- End Observation Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,3,end_date) > op_end_date then op_end_date else DATEADD(day,3,end_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 7, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,7,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",356,FALSE,
362,"[P] Acute Kidney Injury AKI (7Pe, 30Era)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 5,
					""ConditionTypeExclude"" : false
				}
			},
			{
				""ProcedureOccurrence"" : {
					""CodesetId"" : 7,
					""ProcedureTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""ConceptSets"" : [
		{
			""id"" : 2,
			""name"" : ""End-stage renal disease"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 193782,
							""CONCEPT_NAME"" : ""End-stage renal disease"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""46177005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 443611,
							""CONCEPT_NAME"" : ""Chronic kidney disease stage 5"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""433146000"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 3,
			""name"" : ""Dialysis"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 4146536,
							""CONCEPT_NAME"" : ""Renal dialysis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""265764009"",
							""DOMAIN_ID"" : ""Procedure"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4032243,
							""CONCEPT_NAME"" : ""Dialysis procedure"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""108241001"",
							""DOMAIN_ID"" : ""Procedure"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 2617342,
							""CONCEPT_NAME"" : ""Unscheduled or emergency dialysis treatment for an esrd patient in a hospital outpatient department that is not certified as an esrd facility"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""G0257"",
							""DOMAIN_ID"" : ""Procedure"",
							""VOCABULARY_ID"" : ""HCPCS"",
							""CONCEPT_CLASS_ID"" : ""HCPCS""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 5,
			""name"" : ""Acute kidney injury (Narrow definition)"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 197320,
							""CONCEPT_NAME"" : ""Acute renal failure syndrome"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""14669001"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 196455,
							""CONCEPT_NAME"" : ""Hepatorenal syndrome"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""51292008"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 37116834,
							""CONCEPT_NAME"" : ""Postpartum acute renal failure"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""733839001"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 444044,
							""CONCEPT_NAME"" : ""Acute tubular necrosis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""35455006"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 7,
			""name"" : ""Dialysis procedure at a Medicare certified ESRD facility for acute kidney injury without ESRD"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 1314323,
							""CONCEPT_NAME"" : ""Dialysis procedure at a medicare certified esrd facility for acute kidney injury without esrd"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""G0491"",
							""DOMAIN_ID"" : ""Procedure"",
							""VOCABULARY_ID"" : ""HCPCS"",
							""CONCEPT_CLASS_ID"" : ""HCPCS""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 8,
			""name"" : ""Erythropoietin like drugs\n"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 43009086,
							""CONCEPT_NAME"" : ""erythropoietin"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""OMOP4700512"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm Extension"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1304643,
							""CONCEPT_NAME"" : ""darbepoetin alfa"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""283838"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 1301125,
							""CONCEPT_NAME"" : ""epoetin alfa"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""105694"",
							""DOMAIN_ID"" : ""Drug"",
							""VOCABULARY_ID"" : ""RxNorm"",
							""CONCEPT_CLASS_ID"" : ""Ingredient""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 9,
			""name"" : ""Kidney transplantconditions"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 42539502,
							""CONCEPT_NAME"" : ""Transplanted kidney present"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""737295003"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4324887,
							""CONCEPT_NAME"" : ""Disorder related to renal transplantation"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""429451003"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 10,
			""name"" : ""Kidney transplant procedure"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 4324887,
							""CONCEPT_NAME"" : ""Disorder related to renal transplantation"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""429451003"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4180454,
							""CONCEPT_NAME"" : ""Examination of live donor after kidney transplant"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""429496005"",
							""DOMAIN_ID"" : ""Procedure"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 2833286,
							""CONCEPT_NAME"" : ""Medical and Surgical @ Urinary System @ Transplantation @ Kidney, Left"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""0TY1"",
							""DOMAIN_ID"" : ""Procedure"",
							""VOCABULARY_ID"" : ""ICD10PCS"",
							""CONCEPT_CLASS_ID"" : ""ICD10PCS Hierarchy""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 2877118,
							""CONCEPT_NAME"" : ""Medical and Surgical @ Urinary System @ Transplantation @ Kidney, Right"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""0TY0"",
							""DOMAIN_ID"" : ""Procedure"",
							""VOCABULARY_ID"" : ""ICD10PCS"",
							""CONCEPT_CLASS_ID"" : ""ICD10PCS Hierarchy""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4163566,
							""CONCEPT_NAME"" : ""Renal replacement"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""398887003"",
							""DOMAIN_ID"" : ""Procedure"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4146256,
							""CONCEPT_NAME"" : ""Transplant nephrectomy"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""265550007"",
							""DOMAIN_ID"" : ""Procedure"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4082531,
							""CONCEPT_NAME"" : ""US scan of transplant kidney"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""241484009"",
							""DOMAIN_ID"" : ""Procedure"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Procedure""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""All""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [
		{
			""name"" : ""Washout period with no AKI codes"",
			""description"" : ""To rule out diagnosis codes that are follow ups (for example: check for status of recovery or progression, check sequelae, etc) from the actual event of AKI"",
			""expression"" : {
				""Type"" : ""ALL"",
				""CriteriaList"" : [
					{
						""Criteria"" : {
							""ConditionOccurrence"" : {
								""CodesetId"" : 5,
								""ConditionTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Days"" : 30,
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 1,
								""Coeff"" : -1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : true,
						""Occurrence"" : {
							""Type"" : 0,
							""Count"" : 0,
							""IsDistinct"" : false
						}
					},
					{
						""Criteria"" : {
							""ProcedureOccurrence"" : {
								""CodesetId"" : 7,
								""ProcedureTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Days"" : 30,
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 1,
								""Coeff"" : -1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : true,
						""Occurrence"" : {
							""Type"" : 0,
							""Count"" : 0,
							""IsDistinct"" : false
						}
					}
				],
				""DemographicCriteriaList"" : [],
				""Groups"" : []
			}
		},
		{
			""name"" : ""No ESKD at baseline"",
			""description"" : ""To exclude cases with a diagnosis of End-Stage Kidney Disease in the 365 days before AKI occurrence. Period from -365 to -7 to account for ESKD due to the index episode of AKI"",
			""expression"" : {
				""Type"" : ""ALL"",
				""CriteriaList"" : [
					{
						""Criteria"" : {
							""ConditionOccurrence"" : {
								""CodesetId"" : 2,
								""ConditionTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Days"" : 365,
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 7,
								""Coeff"" : -1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : true,
						""Occurrence"" : {
							""Type"" : 0,
							""Count"" : 0,
							""IsDistinct"" : false
						}
					}
				],
				""DemographicCriteriaList"" : [],
				""Groups"" : []
			}
		},
		{
			""name"" : ""No chronic dialysis at baseline (-365 to 8 days) "",
			""description"" : ""To exclude all patients receiving chronic dialysis defined as more than 3 recorded events of dialysis in the 1 year- 8 days before index date, or one erythropoietin dose and dialysis in same year"",
			""expression"" : {
				""Type"" : ""ANY"",
				""CriteriaList"" : [
					{
						""Criteria"" : {
							""ProcedureOccurrence"" : {
								""CodesetId"" : 3,
								""ProcedureTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Days"" : 365,
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 8,
								""Coeff"" : -1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : true,
						""Occurrence"" : {
							""Type"" : 1,
							""Count"" : 3,
							""IsDistinct"" : false
						}
					}
				],
				""DemographicCriteriaList"" : [],
				""Groups"" : [
					{
						""Type"" : ""ALL"",
						""CriteriaList"" : [
							{
								""Criteria"" : {
									""ProcedureOccurrence"" : {
										""CodesetId"" : 3,
										""ProcedureTypeExclude"" : false
									}
								},
								""StartWindow"" : {
									""Start"" : {
										""Days"" : 365,
										""Coeff"" : -1
									},
									""End"" : {
										""Days"" : 8,
										""Coeff"" : -1
									},
									""UseIndexEnd"" : false,
									""UseEventEnd"" : false
								},
								""RestrictVisit"" : false,
								""IgnoreObservationPeriod"" : true,
								""Occurrence"" : {
									""Type"" : 0,
									""Count"" : 0,
									""IsDistinct"" : false
								}
							},
							{
								""Criteria"" : {
									""DrugExposure"" : {
										""CodesetId"" : 8,
										""DrugTypeExclude"" : false
									}
								},
								""StartWindow"" : {
									""Start"" : {
										""Days"" : 365,
										""Coeff"" : -1
									},
									""End"" : {
										""Days"" : 8,
										""Coeff"" : -1
									},
									""UseIndexEnd"" : false,
									""UseEventEnd"" : false
								},
								""RestrictVisit"" : false,
								""IgnoreObservationPeriod"" : true,
								""Occurrence"" : {
									""Type"" : 0,
									""Count"" : 0,
									""IsDistinct"" : false
								}
							}
						],
						""DemographicCriteriaList"" : [],
						""Groups"" : []
					}
				]
			}
		},
		{
			""name"" : ""No Kidney Transplant any time prior "",
			""expression"" : {
				""Type"" : ""ALL"",
				""CriteriaList"" : [
					{
						""Criteria"" : {
							""ConditionOccurrence"" : {
								""CodesetId"" : 9,
								""ConditionTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 0,
								""Coeff"" : 1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : true,
						""Occurrence"" : {
							""Type"" : 0,
							""Count"" : 0,
							""IsDistinct"" : false
						}
					},
					{
						""Criteria"" : {
							""ProcedureOccurrence"" : {
								""CodesetId"" : 10,
								""ProcedureTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 0,
								""Coeff"" : 1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : true,
						""Occurrence"" : {
							""Type"" : 0,
							""Count"" : 0,
							""IsDistinct"" : false
						}
					}
				],
				""DemographicCriteriaList"" : [],
				""Groups"" : []
			}
		}
	],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""EndDate"",
			""Offset"" : 7
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 0
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 2 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (193782,443611)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (193782,443611)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 3 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4146536,4032243,2617342)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4146536,2617342)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 5 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (197320,444044)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (197320,444044)
  and c.invalid_reason is null

) I
LEFT JOIN
(
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (196455,37116834)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (196455,37116834)
  and c.invalid_reason is null

) E ON I.concept_id = E.concept_id
WHERE E.concept_id is null
) C UNION ALL 
SELECT 7 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (1314323)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (1314323)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 8 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (43009086,1304643,1301125)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (43009086,1304643,1301125)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 9 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (42539502,4324887)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (42539502,4324887)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 10 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4324887,4180454,2833286,2877118,4163566,4146256,4082531)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4324887,4180454,2833286,2877118,4163566,4146256,4082531)
  and c.invalid_reason is null

) I
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 5)
) C


-- End Condition Occurrence Criteria

UNION ALL
-- Begin Procedure Occurrence Criteria
select C.person_id, C.procedure_occurrence_id as event_id, C.procedure_date as start_date, DATEADD(d,1,C.procedure_date) as END_DATE,
       C.visit_occurrence_id, C.procedure_date as sort_date
from 
(
  select po.* 
  FROM @cdm_database_schema.PROCEDURE_OCCURRENCE po
JOIN #Codesets cs on (po.procedure_concept_id = cs.concept_id and cs.codeset_id = 7)
) C


-- End Procedure Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

select 0 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_0
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 5)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,-30,P.START_DATE) AND A.START_DATE <= DATEADD(day,-1,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

UNION ALL
-- Begin Correlated Criteria
select 1 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Procedure Occurrence Criteria
select C.person_id, C.procedure_occurrence_id as event_id, C.procedure_date as start_date, DATEADD(d,1,C.procedure_date) as END_DATE,
       C.visit_occurrence_id, C.procedure_date as sort_date
from 
(
  select po.* 
  FROM @cdm_database_schema.PROCEDURE_OCCURRENCE po
JOIN #Codesets cs on (po.procedure_concept_id = cs.concept_id and cs.codeset_id = 7)
) C


-- End Procedure Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,-30,P.START_DATE) AND A.START_DATE <= DATEADD(day,-1,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 2
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

select 1 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_1
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 2)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,-365,P.START_DATE) AND A.START_DATE <= DATEADD(day,-7,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

select 2 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_2
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Procedure Occurrence Criteria
select C.person_id, C.procedure_occurrence_id as event_id, C.procedure_date as start_date, DATEADD(d,1,C.procedure_date) as END_DATE,
       C.visit_occurrence_id, C.procedure_date as sort_date
from 
(
  select po.* 
  FROM @cdm_database_schema.PROCEDURE_OCCURRENCE po
JOIN #Codesets cs on (po.procedure_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Procedure Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,-365,P.START_DATE) AND A.START_DATE <= DATEADD(day,-8,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) <= 3
-- End Correlated Criteria

UNION ALL
-- Begin Criteria Group
select 1 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Procedure Occurrence Criteria
select C.person_id, C.procedure_occurrence_id as event_id, C.procedure_date as start_date, DATEADD(d,1,C.procedure_date) as END_DATE,
       C.visit_occurrence_id, C.procedure_date as sort_date
from 
(
  select po.* 
  FROM @cdm_database_schema.PROCEDURE_OCCURRENCE po
JOIN #Codesets cs on (po.procedure_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Procedure Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,-365,P.START_DATE) AND A.START_DATE <= DATEADD(day,-8,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

UNION ALL
-- Begin Correlated Criteria
select 1 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.DRUG_EXPOSURE_END_DATE, DATEADD(day,C.DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,C.DRUG_EXPOSURE_START_DATE)) as end_date,
       C.visit_occurrence_id,C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets cs on (de.drug_concept_id = cs.concept_id and cs.codeset_id = 8)
) C


-- End Drug Exposure Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,-365,P.START_DATE) AND A.START_DATE <= DATEADD(day,-8,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 2
) G
-- End Criteria Group

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) > 0
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

select 3 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_3
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 9)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE <= DATEADD(day,0,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

UNION ALL
-- Begin Correlated Criteria
select 1 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Procedure Occurrence Criteria
select C.person_id, C.procedure_occurrence_id as event_id, C.procedure_date as start_date, DATEADD(d,1,C.procedure_date) as END_DATE,
       C.visit_occurrence_id, C.procedure_date as sort_date
from 
(
  select po.* 
  FROM @cdm_database_schema.PROCEDURE_OCCURRENCE po
JOIN #Codesets cs on (po.procedure_concept_id = cs.concept_id and cs.codeset_id = 10)
) C


-- End Procedure Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE <= DATEADD(day,0,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 2
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

SELECT inclusion_rule_id, person_id, event_id
INTO #inclusion_events
FROM (select inclusion_rule_id, person_id, event_id from #Inclusion_0
UNION ALL
select inclusion_rule_id, person_id, event_id from #Inclusion_1
UNION ALL
select inclusion_rule_id, person_id, event_id from #Inclusion_2
UNION ALL
select inclusion_rule_id, person_id, event_id from #Inclusion_3) I;
TRUNCATE TABLE #Inclusion_0;
DROP TABLE #Inclusion_0;

TRUNCATE TABLE #Inclusion_1;
DROP TABLE #Inclusion_1;

TRUNCATE TABLE #Inclusion_2;
DROP TABLE #Inclusion_2;

TRUNCATE TABLE #Inclusion_3;
DROP TABLE #Inclusion_3;


select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

  -- the matching group with all bits set ( POWER(2,# of inclusion rules) - 1 = inclusion_rule_mask
  WHERE (MG.inclusion_rule_mask = POWER(cast(2 as bigint),4)-1)

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,7,end_date) > op_end_date then op_end_date else DATEADD(day,7,end_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 0, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,0,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



-- Create a temp table of inclusion rule rows for joining in the inclusion rule impact analysis

select cast(rule_sequence as int) as rule_sequence
into #inclusion_rules
from (
  SELECT CAST(0 as int) as rule_sequence UNION ALL SELECT CAST(1 as int) as rule_sequence UNION ALL SELECT CAST(2 as int) as rule_sequence UNION ALL SELECT CAST(3 as int) as rule_sequence
) IR;


-- Find the event that is the 'best match' per person.  
-- the 'best match' is defined as the event that satisfies the most inclusion rules.
-- ties are solved by choosing the event that matches the earliest inclusion rule, and then earliest.

select q.person_id, q.event_id
into #best_events
from #qualified_events Q
join (
	SELECT R.person_id, R.event_id, ROW_NUMBER() OVER (PARTITION BY R.person_id ORDER BY R.rule_count DESC,R.min_rule_id ASC, R.start_date ASC) AS rank_value
	FROM (
		SELECT Q.person_id, Q.event_id, COALESCE(COUNT(DISTINCT I.inclusion_rule_id), 0) AS rule_count, COALESCE(MIN(I.inclusion_rule_id), 0) AS min_rule_id, Q.start_date
		FROM #qualified_events Q
		LEFT JOIN #inclusion_events I ON q.person_id = i.person_id AND q.event_id = i.event_id
		GROUP BY Q.person_id, Q.event_id, Q.start_date
	) R
) ranked on Q.person_id = ranked.person_id and Q.event_id = ranked.event_id
WHERE ranked.rank_value = 1
;

-- modes of generation: (the same tables store the results for the different modes, identified by the mode_id column)
-- 0: all events
-- 1: best event


-- BEGIN: Inclusion Impact Analysis - event
-- calculte matching group counts
delete from @results_database_schema.cohort_inclusion_result where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_inclusion_result (cohort_definition_id, inclusion_rule_mask, person_count, mode_id)
select @target_cohort_id as cohort_definition_id, inclusion_rule_mask, count_big(*) as person_count, 0 as mode_id
from
(
  select Q.person_id, Q.event_id, CAST(SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) AS bigint) as inclusion_rule_mask
  from #qualified_events Q
  LEFT JOIN #inclusion_events I on q.person_id = i.person_id and q.event_id = i.event_id
  GROUP BY Q.person_id, Q.event_id
) MG -- matching groups
group by inclusion_rule_mask
;

-- calculate gain counts 
delete from @results_database_schema.cohort_inclusion_stats where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_inclusion_stats (cohort_definition_id, rule_sequence, person_count, gain_count, person_total, mode_id)
select @target_cohort_id as cohort_definition_id, ir.rule_sequence, coalesce(T.person_count, 0) as person_count, coalesce(SR.person_count, 0) gain_count, EventTotal.total, 0 as mode_id
from #inclusion_rules ir
left join
(
  select i.inclusion_rule_id, count_big(i.event_id) as person_count
  from #qualified_events Q
  JOIN #inclusion_events i on Q.person_id = I.person_id and Q.event_id = i.event_id
  group by i.inclusion_rule_id
) T on ir.rule_sequence = T.inclusion_rule_id
CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
CROSS JOIN (select count_big(event_id) as total from #qualified_events) EventTotal
LEFT JOIN @results_database_schema.cohort_inclusion_result SR on SR.mode_id = 0 AND SR.cohort_definition_id = @target_cohort_id AND (POWER(cast(2 as bigint),RuleTotal.total_rules) - POWER(cast(2 as bigint),ir.rule_sequence) - 1) = SR.inclusion_rule_mask -- POWER(2,rule count) - POWER(2,rule sequence) - 1 is the mask for 'all except this rule'
;

-- calculate totals
delete from @results_database_schema.cohort_summary_stats where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_summary_stats (cohort_definition_id, base_count, final_count, mode_id)
select @target_cohort_id as cohort_definition_id, PC.total as person_count, coalesce(FC.total, 0) as final_count, 0 as mode_id
FROM
(select count_big(event_id) as total from #qualified_events) PC,
(select sum(sr.person_count) as total
  from @results_database_schema.cohort_inclusion_result sr
  CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
  where sr.mode_id = 0 and sr.cohort_definition_id = @target_cohort_id and sr.inclusion_rule_mask = POWER(cast(2 as bigint),RuleTotal.total_rules)-1
) FC
;

-- END: Inclusion Impact Analysis - event

-- BEGIN: Inclusion Impact Analysis - person
-- calculte matching group counts
delete from @results_database_schema.cohort_inclusion_result where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_inclusion_result (cohort_definition_id, inclusion_rule_mask, person_count, mode_id)
select @target_cohort_id as cohort_definition_id, inclusion_rule_mask, count_big(*) as person_count, 1 as mode_id
from
(
  select Q.person_id, Q.event_id, CAST(SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) AS bigint) as inclusion_rule_mask
  from #best_events Q
  LEFT JOIN #inclusion_events I on q.person_id = i.person_id and q.event_id = i.event_id
  GROUP BY Q.person_id, Q.event_id
) MG -- matching groups
group by inclusion_rule_mask
;

-- calculate gain counts 
delete from @results_database_schema.cohort_inclusion_stats where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_inclusion_stats (cohort_definition_id, rule_sequence, person_count, gain_count, person_total, mode_id)
select @target_cohort_id as cohort_definition_id, ir.rule_sequence, coalesce(T.person_count, 0) as person_count, coalesce(SR.person_count, 0) gain_count, EventTotal.total, 1 as mode_id
from #inclusion_rules ir
left join
(
  select i.inclusion_rule_id, count_big(i.event_id) as person_count
  from #best_events Q
  JOIN #inclusion_events i on Q.person_id = I.person_id and Q.event_id = i.event_id
  group by i.inclusion_rule_id
) T on ir.rule_sequence = T.inclusion_rule_id
CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
CROSS JOIN (select count_big(event_id) as total from #best_events) EventTotal
LEFT JOIN @results_database_schema.cohort_inclusion_result SR on SR.mode_id = 1 AND SR.cohort_definition_id = @target_cohort_id AND (POWER(cast(2 as bigint),RuleTotal.total_rules) - POWER(cast(2 as bigint),ir.rule_sequence) - 1) = SR.inclusion_rule_mask -- POWER(2,rule count) - POWER(2,rule sequence) - 1 is the mask for 'all except this rule'
;

-- calculate totals
delete from @results_database_schema.cohort_summary_stats where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_summary_stats (cohort_definition_id, base_count, final_count, mode_id)
select @target_cohort_id as cohort_definition_id, PC.total as person_count, coalesce(FC.total, 0) as final_count, 1 as mode_id
FROM
(select count_big(event_id) as total from #best_events) PC,
(select sum(sr.person_count) as total
  from @results_database_schema.cohort_inclusion_result sr
  CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
  where sr.mode_id = 1 and sr.cohort_definition_id = @target_cohort_id and sr.inclusion_rule_mask = POWER(cast(2 as bigint),RuleTotal.total_rules)-1
) FC
;

-- END: Inclusion Impact Analysis - person

TRUNCATE TABLE #best_events;
DROP TABLE #best_events;

TRUNCATE TABLE #inclusion_rules;
DROP TABLE #inclusion_rules;


TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",362,FALSE,
366,"[P] Streptococcal throat infection (14Pe, 30Era)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 2,
					""ConditionTypeExclude"" : false
				}
			},
			{
				""ConditionOccurrence"" : {
					""CorrelatedCriteria"" : {
						""Type"" : ""ALL"",
						""CriteriaList"" : [
							{
								""Criteria"" : {
									""ConditionOccurrence"" : {
										""CodesetId"" : 4,
										""ConditionTypeExclude"" : false
									}
								},
								""StartWindow"" : {
									""Start"" : {
										""Days"" : 1,
										""Coeff"" : -1
									},
									""End"" : {
										""Days"" : 1,
										""Coeff"" : 1
									},
									""UseIndexEnd"" : false,
									""UseEventEnd"" : false
								},
								""RestrictVisit"" : false,
								""IgnoreObservationPeriod"" : false,
								""Occurrence"" : {
									""Type"" : 2,
									""Count"" : 1,
									""IsDistinct"" : false
								}
							}
						],
						""DemographicCriteriaList"" : [],
						""Groups"" : []
					},
					""CodesetId"" : 3,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""ConceptSets"" : [
		{
			""id"" : 2,
			""name"" : "" Streptococcal throat infection"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 28060,
							""CONCEPT_NAME"" : ""Streptococcal sore throat"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""43878008"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 3,
			""name"" : ""Pharyngitis"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 4226263,
							""CONCEPT_NAME"" : ""Pharyngitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""405737000"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 4,
			""name"" : ""Streptococcal infectious disease"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 437779,
							""CONCEPT_NAME"" : ""Streptococcal infectious disease"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""85769006"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""All""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""EndDate"",
			""Offset"" : 14
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 30
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 2 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (28060)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (28060)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 3 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4226263)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4226263)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 4 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (437779)

) I
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 2)
) C


-- End Condition Occurrence Criteria

UNION ALL
select PE.person_id, PE.event_id, PE.start_date, PE.end_date, PE.visit_occurrence_id, PE.sort_date FROM (
-- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria

) PE
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria
) Q
JOIN @cdm_database_schema.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria
) Q
JOIN @cdm_database_schema.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 4)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= DATEADD(day,-1,P.START_DATE) AND A.START_DATE <= DATEADD(day,1,P.START_DATE) ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id and AC.event_id = pe.event_id

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,14,end_date) > op_end_date then op_end_date else DATEADD(day,14,end_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 30, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,30,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",366,FALSE,
367,"[P] Allergic Rhinitis (14Pe, 30Era)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 2,
					""ConditionTypeExclude"" : false
				}
			},
			{
				""ConditionOccurrence"" : {
					""CorrelatedCriteria"" : {
						""Type"" : ""ANY"",
						""CriteriaList"" : [
							{
								""Criteria"" : {
									""ConditionOccurrence"" : {
										""CodesetId"" : 4,
										""ConditionTypeExclude"" : false
									}
								},
								""StartWindow"" : {
									""Start"" : {
										""Days"" : 0,
										""Coeff"" : -1
									},
									""End"" : {
										""Days"" : 0,
										""Coeff"" : 1
									},
									""UseIndexEnd"" : false,
									""UseEventEnd"" : false
								},
								""RestrictVisit"" : false,
								""IgnoreObservationPeriod"" : false,
								""Occurrence"" : {
									""Type"" : 2,
									""Count"" : 1,
									""IsDistinct"" : false
								}
							},
							{
								""Criteria"" : {
									""ConditionOccurrence"" : {
										""CodesetId"" : 5,
										""ConditionTypeExclude"" : false
									}
								},
								""StartWindow"" : {
									""Start"" : {
										""Days"" : 0,
										""Coeff"" : -1
									},
									""End"" : {
										""Days"" : 0,
										""Coeff"" : 1
									},
									""UseIndexEnd"" : false,
									""UseEventEnd"" : false
								},
								""RestrictVisit"" : false,
								""IgnoreObservationPeriod"" : false,
								""Occurrence"" : {
									""Type"" : 2,
									""Count"" : 1,
									""IsDistinct"" : false
								}
							}
						],
						""DemographicCriteriaList"" : [],
						""Groups"" : []
					},
					""CodesetId"" : 3,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""ConceptSets"" : [
		{
			""id"" : 2,
			""name"" : ""Allergic rhinitis"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 257007,
							""CONCEPT_NAME"" : ""Allergic rhinitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""61582004"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 3,
			""name"" : ""Rhinitis"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 4320791,
							""CONCEPT_NAME"" : ""Rhinitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""70076002"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 4,
			""name"" : ""Allergic disorder of respiratory tract"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 42536525,
							""CONCEPT_NAME"" : ""Allergic disorder of respiratory tract"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""735445000"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 5,
			""name"" : ""Allergic disorder"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 36683564,
							""CONCEPT_NAME"" : ""Allergic disorder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""781474001"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""All""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""EndDate"",
			""Offset"" : 14
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 30
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 2 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (257007)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (257007)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 3 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4320791)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4320791)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 4 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (42536525)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (42536525)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 5 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (36683564)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (36683564)
  and c.invalid_reason is null

) I
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 2)
) C


-- End Condition Occurrence Criteria

UNION ALL
select PE.person_id, PE.event_id, PE.start_date, PE.end_date, PE.visit_occurrence_id, PE.sort_date FROM (
-- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria

) PE
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria
) Q
JOIN @cdm_database_schema.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria
) Q
JOIN @cdm_database_schema.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 4)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= DATEADD(day,0,P.START_DATE) AND A.START_DATE <= DATEADD(day,0,P.START_DATE) ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

UNION ALL
-- Begin Correlated Criteria
select 1 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria
) Q
JOIN @cdm_database_schema.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 5)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= DATEADD(day,0,P.START_DATE) AND A.START_DATE <= DATEADD(day,0,P.START_DATE) ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) > 0
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id and AC.event_id = pe.event_id

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,14,end_date) > op_end_date then op_end_date else DATEADD(day,14,end_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 30, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,30,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",367,FALSE,
372,"[P] Otitis media (3Pe, 30Era)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 2,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""ConceptSets"" : [
		{
			""id"" : 2,
			""name"" : ""Otitis media"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 372328,
							""CONCEPT_NAME"" : ""Otitis media"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""65363002"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 3,
			""name"" : ""Pharyngitis"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 4226263,
							""CONCEPT_NAME"" : ""Pharyngitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""405737000"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		},
		{
			""id"" : 4,
			""name"" : ""Streptococcal infectious disease"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 437779,
							""CONCEPT_NAME"" : ""Streptococcal infectious disease"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""85769006"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""All""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""EndDate"",
			""Offset"" : 14
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 30
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 2 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (372328)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (372328)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 3 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4226263)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4226263)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 4 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (437779)

) I
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 2)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,14,end_date) > op_end_date then op_end_date else DATEADD(day,14,end_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 30, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,30,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",372,FALSE,
395,"[P] Dysmenorrhea (90Pe, 365Era)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 4,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""ConceptSets"" : [
		{
			""id"" : 4,
			""name"" : ""Dysmenorrhea"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 194696,
							""CONCEPT_NAME"" : ""Dysmenorrhea"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""266599000"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 443431,
							""CONCEPT_NAME"" : ""Disorder of menstruation"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""386804004"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : false,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""First""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""EndDate"",
			""Offset"" : 90
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 365
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 4 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (194696,443431)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (194696)
  and c.invalid_reason is null

) I
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 4)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,90,end_date) > op_end_date then op_end_date else DATEADD(day,90,end_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 365, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,365,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",395,FALSE,
396,"[P] Osteoarthritis (FP)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 0,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""First""
		}
	},
	""ConceptSets"" : [
		{
			""id"" : 0,
			""name"" : ""Osteoarthritis "",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 80180,
							""CONCEPT_NAME"" : ""Osteoarthritis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""396275006"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""First""
	},
	""ExpressionLimit"" : {
		""Type"" : ""First""
	},
	""InclusionRules"" : [],
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 0
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 0 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (80180)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (80180)
  and c.invalid_reason is null

) I
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 0)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P
WHERE P.ordinal = 1
-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

) Results
WHERE Results.ordinal = 1
;



-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- By default, cohort exit at the event's op end date
select event_id, person_id, op_end_date as end_date from #included_events
    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 0, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,0,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats





TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",396,FALSE,
407,"[P] Hemorrhoids (1Pe, 30Era)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 0,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""ConceptSets"" : [
		{
			""id"" : 0,
			""name"" : ""Hemorrhoids"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 195562,
							""CONCEPT_NAME"" : ""Hemorrhoids"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""70153002"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""First""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""EndDate"",
			""Offset"" : 1
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 30
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 0 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (195562)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (195562)
  and c.invalid_reason is null

) I
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 0)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,1,end_date) > op_end_date then op_end_date else DATEADD(day,1,end_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 30, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,30,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",407,FALSE,
410,"[P] Acute Urinary tract infections UTI (1Pe, 30Era)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 0,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""ConceptSets"" : [
		{
			""id"" : 0,
			""name"" : ""Certain Urinary Tract Infections"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 81902,
							""CONCEPT_NAME"" : ""Urinary tract infectious disease"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""68566005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4167328,
							""CONCEPT_NAME"" : ""Pyuria"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""4800001"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 77340,
							""CONCEPT_NAME"" : ""Genitourinary tract infection in pregnancy"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""267204006"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4265485,
							""CONCEPT_NAME"" : ""Bacteriuria"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""61373006"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4126297,
							""CONCEPT_NAME"" : ""Chronic obstructive pyelonephritis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""236379002"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 195588,
							""CONCEPT_NAME"" : ""Cystitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""38822007"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 198806,
							""CONCEPT_NAME"" : ""Abscess of prostate"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""8725005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4126267,
							""CONCEPT_NAME"" : ""Chronic radiation cystitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""236629009"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 194997,
							""CONCEPT_NAME"" : ""Prostatitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""9713002"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4077499,
							""CONCEPT_NAME"" : ""Sterile pyuria"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""275742001"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 442345,
							""CONCEPT_NAME"" : ""Syphilis of kidney"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""59530001"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4062493,
							""CONCEPT_NAME"" : ""Mumps nephritis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""17121006"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 45757237,
							""CONCEPT_NAME"" : ""Diphtheria tubulointerstitial nephropathy"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""1086071000119103"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36714969,
							""CONCEPT_NAME"" : ""Asymptomatic bacteriuria"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""720406004"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 195743,
							""CONCEPT_NAME"" : ""Diphtheritic cystitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""48278001"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 201353,
							""CONCEPT_NAME"" : ""Irradiation cystitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""11251000"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4047937,
							""CONCEPT_NAME"" : ""Neonatal urinary tract infection"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""12301009"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 201792,
							""CONCEPT_NAME"" : ""Nongonococcal urethritis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""84619001"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4128384,
							""CONCEPT_NAME"" : ""Non-infective cystitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""236623005"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 78357,
							""CONCEPT_NAME"" : ""Reactive arthritis triad"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""67224007"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 195313,
							""CONCEPT_NAME"" : ""Urethral abscess"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""67277002"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 197919,
							""CONCEPT_NAME"" : ""Urethral stricture due to infection"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""80375002"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 439349,
							""CONCEPT_NAME"" : ""Cystitis associated with another disorder"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""197845000"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4227291,
							""CONCEPT_NAME"" : ""Hemorrhagic cystitis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""87696004"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4060312,
							""CONCEPT_NAME"" : ""Infections of urethra in pregnancy"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""199206009"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4127564,
							""CONCEPT_NAME"" : ""Acute cystitis - culture-negative"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""236624004"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4126141,
							""CONCEPT_NAME"" : ""Chronic cystitis - culture negative"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""236626002"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : false,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4127565,
							""CONCEPT_NAME"" : ""Recurrent cystitis - culture-negative"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""236625003"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4207186,
							""CONCEPT_NAME"" : ""Viral infection by site"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""312130009"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 4207190,
							""CONCEPT_NAME"" : ""Fungal infection by site"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""312146001"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 434557,
							""CONCEPT_NAME"" : ""Tuberculosis"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""56717001"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 432251,
							""CONCEPT_NAME"" : ""Disease caused by parasite"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""17322007"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36102152,
							""CONCEPT_NAME"" : ""Protozoal infectious disorders"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""10037072"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""MedDRA"",
							""CONCEPT_CLASS_ID"" : ""HLGT""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 433417,
							""CONCEPT_NAME"" : ""Gonorrhea"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""15628003"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					},
					{
						""concept"" : {
							""CONCEPT_ID"" : 36102938,
							""CONCEPT_NAME"" : ""Chlamydial infections"",
							""STANDARD_CONCEPT"" : ""C"",
							""STANDARD_CONCEPT_CAPTION"" : ""Classification"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""10008561"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""MedDRA"",
							""CONCEPT_CLASS_ID"" : ""HLT""
						},
						""isExcluded"" : true,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""First""
	},
	""ExpressionLimit"" : {
		""Type"" : ""First""
	},
	""InclusionRules"" : [],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""EndDate"",
			""Offset"" : 1
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 30
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 0 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (81902,77340,4126297,195588)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (81902,77340,4126297,195588)
  and c.invalid_reason is null

) I
LEFT JOIN
(
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4167328,4265485,198806,4126267,194997,4077499,442345,4062493,45757237,36714969,195743,201353,4047937,201792,4128384,78357,195313,197919,439349,4227291,4060312,4127564,4126141,4127565,4207186,4207190,434557,432251,36102152,433417,36102938)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4167328,4265485,198806,4126267,4077499,442345,4062493,45757237,36714969,195743,201353,4047937,201792,78357,195313,197919,4127564,4127565,4207186,4207190,434557,432251,36102152,433417,36102938)
  and c.invalid_reason is null

) E ON I.concept_id = E.concept_id
WHERE E.concept_id is null
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 0)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

) Results
WHERE Results.ordinal = 1
;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,1,end_date) > op_end_date then op_end_date else DATEADD(day,1,end_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 30, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,30,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",410,FALSE,
412,"Transverse myelitis indexed on diagnosis (1Ps, 0Era, 365W)","{
	""cdmVersionRange"" : "">=5.0.0"",
	""PrimaryCriteria"" : {
		""CriteriaList"" : [
			{
				""ConditionOccurrence"" : {
					""CodesetId"" : 4,
					""ConditionTypeExclude"" : false
				}
			}
		],
		""ObservationWindow"" : {
			""PriorDays"" : 0,
			""PostDays"" : 0
		},
		""PrimaryCriteriaLimit"" : {
			""Type"" : ""All""
		}
	},
	""ConceptSets"" : [
		{
			""id"" : 4,
			""name"" : ""Transverse Myelitis"",
			""expression"" : {
				""items"" : [
					{
						""concept"" : {
							""CONCEPT_ID"" : 443904,
							""CONCEPT_NAME"" : ""Transverse myelopathy syndrome"",
							""STANDARD_CONCEPT"" : ""S"",
							""STANDARD_CONCEPT_CAPTION"" : ""Standard"",
							""INVALID_REASON"" : ""V"",
							""INVALID_REASON_CAPTION"" : ""Valid"",
							""CONCEPT_CODE"" : ""16631009"",
							""DOMAIN_ID"" : ""Condition"",
							""VOCABULARY_ID"" : ""SNOMED"",
							""CONCEPT_CLASS_ID"" : ""Clinical Finding""
						},
						""isExcluded"" : false,
						""includeDescendants"" : true,
						""includeMapped"" : false
					}
				]
			}
		}
	],
	""QualifiedLimit"" : {
		""Type"" : ""All""
	},
	""ExpressionLimit"" : {
		""Type"" : ""All""
	},
	""InclusionRules"" : [
		{
			""name"" : ""has no events in prior 'clean window' - 365 days"",
			""expression"" : {
				""Type"" : ""ALL"",
				""CriteriaList"" : [
					{
						""Criteria"" : {
							""ConditionOccurrence"" : {
								""CodesetId"" : 4,
								""ConditionTypeExclude"" : false
							}
						},
						""StartWindow"" : {
							""Start"" : {
								""Days"" : 365,
								""Coeff"" : -1
							},
							""End"" : {
								""Days"" : 1,
								""Coeff"" : -1
							},
							""UseIndexEnd"" : false,
							""UseEventEnd"" : false
						},
						""RestrictVisit"" : false,
						""IgnoreObservationPeriod"" : true,
						""Occurrence"" : {
							""Type"" : 0,
							""Count"" : 0,
							""IsDistinct"" : false
						}
					}
				],
				""DemographicCriteriaList"" : [],
				""Groups"" : []
			}
		}
	],
	""EndStrategy"" : {
		""DateOffset"" : {
			""DateField"" : ""StartDate"",
			""Offset"" : 1
		}
	},
	""CensoringCriteria"" : [],
	""CollapseSettings"" : {
		""CollapseType"" : ""ERA"",
		""EraPad"" : 0
	},
	""CensorWindow"" : {}
}","CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 4 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (443904)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (443904)
  and c.invalid_reason is null

) I
) C
;

SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM (-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC, E.event_id) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 4)
) C


-- End Condition Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events
) pe
  
) QE

;

--- Inclusion Rule Inserts

select 0 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_0
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 4)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,-365,P.START_DATE) AND A.START_DATE <= DATEADD(day,-1,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

SELECT inclusion_rule_id, person_id, event_id
INTO #inclusion_events
FROM (select inclusion_rule_id, person_id, event_id from #Inclusion_0) I;
TRUNCATE TABLE #Inclusion_0;
DROP TABLE #Inclusion_0;


select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM (
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

  -- the matching group with all bits set ( POWER(2,# of inclusion rules) - 1 = inclusion_rule_mask
  WHERE (MG.inclusion_rule_mask = POWER(cast(2 as bigint),1)-1)

) Results

;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,1,start_date) > op_end_date then op_end_date else DATEADD(day,1,start_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
select person_id, start_date, end_date
INTO #cohort_rows
from ( -- first_ends
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, CE.end_date, row_number() over (partition by I.person_id, I.event_id order by CE.end_date) as ordinal 
	  from #included_events I
	  join ( -- cohort_ends
-- cohort exit dates
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

    ) CE on I.event_id = CE.event_id and I.person_id = CE.person_id and CE.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
) FE;

select person_id, min(start_date) as start_date, end_date
into #final_cohort
from ( --cteEnds
	SELECT
		 c.person_id
		, c.start_date
		, MIN(ed.end_date) AS end_date
	FROM #cohort_rows c
	JOIN ( -- cteEndDates
    SELECT
      person_id
      , DATEADD(day,-1 * 0, event_date)  as end_date
    FROM
    (
      SELECT
        person_id
        , event_date
        , event_type
        , MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal ROWS UNBOUNDED PRECEDING) AS start_ordinal 
        , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type, start_ordinal) AS overall_ord
      FROM
      (
        SELECT
          person_id
          , start_date AS event_date
          , -1 AS event_type
          , ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
        FROM #cohort_rows

        UNION ALL


        SELECT
          person_id
          , DATEADD(day,0,end_date) as end_date
          , 1 AS event_type
          , NULL
        FROM #cohort_rows
      ) RAWDATA
    ) e
    WHERE (2 * e.start_ordinal) - e.overall_ord = 0
  ) ed ON c.person_id = ed.person_id AND ed.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
) e
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;


-- BEGIN: Censored Stats

delete from @results_database_schema.cohort_censor_stats where cohort_definition_id = @target_cohort_id;

-- END: Censored Stats



-- Create a temp table of inclusion rule rows for joining in the inclusion rule impact analysis

select cast(rule_sequence as int) as rule_sequence
into #inclusion_rules
from (
  SELECT CAST(0 as int) as rule_sequence
) IR;


-- Find the event that is the 'best match' per person.  
-- the 'best match' is defined as the event that satisfies the most inclusion rules.
-- ties are solved by choosing the event that matches the earliest inclusion rule, and then earliest.

select q.person_id, q.event_id
into #best_events
from #qualified_events Q
join (
	SELECT R.person_id, R.event_id, ROW_NUMBER() OVER (PARTITION BY R.person_id ORDER BY R.rule_count DESC,R.min_rule_id ASC, R.start_date ASC) AS rank_value
	FROM (
		SELECT Q.person_id, Q.event_id, COALESCE(COUNT(DISTINCT I.inclusion_rule_id), 0) AS rule_count, COALESCE(MIN(I.inclusion_rule_id), 0) AS min_rule_id, Q.start_date
		FROM #qualified_events Q
		LEFT JOIN #inclusion_events I ON q.person_id = i.person_id AND q.event_id = i.event_id
		GROUP BY Q.person_id, Q.event_id, Q.start_date
	) R
) ranked on Q.person_id = ranked.person_id and Q.event_id = ranked.event_id
WHERE ranked.rank_value = 1
;

-- modes of generation: (the same tables store the results for the different modes, identified by the mode_id column)
-- 0: all events
-- 1: best event


-- BEGIN: Inclusion Impact Analysis - event
-- calculte matching group counts
delete from @results_database_schema.cohort_inclusion_result where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_inclusion_result (cohort_definition_id, inclusion_rule_mask, person_count, mode_id)
select @target_cohort_id as cohort_definition_id, inclusion_rule_mask, count_big(*) as person_count, 0 as mode_id
from
(
  select Q.person_id, Q.event_id, CAST(SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) AS bigint) as inclusion_rule_mask
  from #qualified_events Q
  LEFT JOIN #inclusion_events I on q.person_id = i.person_id and q.event_id = i.event_id
  GROUP BY Q.person_id, Q.event_id
) MG -- matching groups
group by inclusion_rule_mask
;

-- calculate gain counts 
delete from @results_database_schema.cohort_inclusion_stats where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_inclusion_stats (cohort_definition_id, rule_sequence, person_count, gain_count, person_total, mode_id)
select @target_cohort_id as cohort_definition_id, ir.rule_sequence, coalesce(T.person_count, 0) as person_count, coalesce(SR.person_count, 0) gain_count, EventTotal.total, 0 as mode_id
from #inclusion_rules ir
left join
(
  select i.inclusion_rule_id, count_big(i.event_id) as person_count
  from #qualified_events Q
  JOIN #inclusion_events i on Q.person_id = I.person_id and Q.event_id = i.event_id
  group by i.inclusion_rule_id
) T on ir.rule_sequence = T.inclusion_rule_id
CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
CROSS JOIN (select count_big(event_id) as total from #qualified_events) EventTotal
LEFT JOIN @results_database_schema.cohort_inclusion_result SR on SR.mode_id = 0 AND SR.cohort_definition_id = @target_cohort_id AND (POWER(cast(2 as bigint),RuleTotal.total_rules) - POWER(cast(2 as bigint),ir.rule_sequence) - 1) = SR.inclusion_rule_mask -- POWER(2,rule count) - POWER(2,rule sequence) - 1 is the mask for 'all except this rule'
;

-- calculate totals
delete from @results_database_schema.cohort_summary_stats where cohort_definition_id = @target_cohort_id and mode_id = 0;
insert into @results_database_schema.cohort_summary_stats (cohort_definition_id, base_count, final_count, mode_id)
select @target_cohort_id as cohort_definition_id, PC.total as person_count, coalesce(FC.total, 0) as final_count, 0 as mode_id
FROM
(select count_big(event_id) as total from #qualified_events) PC,
(select sum(sr.person_count) as total
  from @results_database_schema.cohort_inclusion_result sr
  CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
  where sr.mode_id = 0 and sr.cohort_definition_id = @target_cohort_id and sr.inclusion_rule_mask = POWER(cast(2 as bigint),RuleTotal.total_rules)-1
) FC
;

-- END: Inclusion Impact Analysis - event

-- BEGIN: Inclusion Impact Analysis - person
-- calculte matching group counts
delete from @results_database_schema.cohort_inclusion_result where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_inclusion_result (cohort_definition_id, inclusion_rule_mask, person_count, mode_id)
select @target_cohort_id as cohort_definition_id, inclusion_rule_mask, count_big(*) as person_count, 1 as mode_id
from
(
  select Q.person_id, Q.event_id, CAST(SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) AS bigint) as inclusion_rule_mask
  from #best_events Q
  LEFT JOIN #inclusion_events I on q.person_id = i.person_id and q.event_id = i.event_id
  GROUP BY Q.person_id, Q.event_id
) MG -- matching groups
group by inclusion_rule_mask
;

-- calculate gain counts 
delete from @results_database_schema.cohort_inclusion_stats where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_inclusion_stats (cohort_definition_id, rule_sequence, person_count, gain_count, person_total, mode_id)
select @target_cohort_id as cohort_definition_id, ir.rule_sequence, coalesce(T.person_count, 0) as person_count, coalesce(SR.person_count, 0) gain_count, EventTotal.total, 1 as mode_id
from #inclusion_rules ir
left join
(
  select i.inclusion_rule_id, count_big(i.event_id) as person_count
  from #best_events Q
  JOIN #inclusion_events i on Q.person_id = I.person_id and Q.event_id = i.event_id
  group by i.inclusion_rule_id
) T on ir.rule_sequence = T.inclusion_rule_id
CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
CROSS JOIN (select count_big(event_id) as total from #best_events) EventTotal
LEFT JOIN @results_database_schema.cohort_inclusion_result SR on SR.mode_id = 1 AND SR.cohort_definition_id = @target_cohort_id AND (POWER(cast(2 as bigint),RuleTotal.total_rules) - POWER(cast(2 as bigint),ir.rule_sequence) - 1) = SR.inclusion_rule_mask -- POWER(2,rule count) - POWER(2,rule sequence) - 1 is the mask for 'all except this rule'
;

-- calculate totals
delete from @results_database_schema.cohort_summary_stats where cohort_definition_id = @target_cohort_id and mode_id = 1;
insert into @results_database_schema.cohort_summary_stats (cohort_definition_id, base_count, final_count, mode_id)
select @target_cohort_id as cohort_definition_id, PC.total as person_count, coalesce(FC.total, 0) as final_count, 1 as mode_id
FROM
(select count_big(event_id) as total from #best_events) PC,
(select sum(sr.person_count) as total
  from @results_database_schema.cohort_inclusion_result sr
  CROSS JOIN (select count(*) as total_rules from #inclusion_rules) RuleTotal
  where sr.mode_id = 1 and sr.cohort_definition_id = @target_cohort_id and sr.inclusion_rule_mask = POWER(cast(2 as bigint),RuleTotal.total_rules)-1
) FC
;

-- END: Inclusion Impact Analysis - person

TRUNCATE TABLE #best_events;
DROP TABLE #best_events;

TRUNCATE TABLE #inclusion_rules;
DROP TABLE #inclusion_rules;


TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;",412,FALSE,
26001,"[P] Asthma or Chronic obstructive pulmonary disease (COPD) (FP) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [26001],
  ""targetCohortId"": [26],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 26001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 26;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    26001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",26,TRUE,1
27001,"[P] Asthma without COPD (FP) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [27001],
  ""targetCohortId"": [27],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 27001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 27;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    27001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",27,TRUE,1
30001,"[P] Tuberculosis (FP) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [30001],
  ""targetCohortId"": [30],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 30001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 30;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    30001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",30,TRUE,1
33001,"[P] Dementia (FP) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [33001],
  ""targetCohortId"": [33],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 33001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 33;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    33001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",33,TRUE,1
68001,"[W] Heart failure with inpatient admission (3Pe, 30Era) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [68001],
  ""targetCohortId"": [68],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 68001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 68;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    68001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",68,TRUE,1
70001,"[P] Stroke (ischemic or hemorrhagic) with inpatient admission (7Ps, 30Era) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [70001],
  ""targetCohortId"": [70],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 70001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 70;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    70001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",70,TRUE,1
71001,"[P] Acute myocardial infarction with inpatient admission (7Pe, 180Era) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [71001],
  ""targetCohortId"": [71],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 71001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 71;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    71001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",71,TRUE,1
72001,"[P] Influenza diagnosis or positive test result (7Pe, 90Era) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [72001],
  ""targetCohortId"": [72],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 72001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 72;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    72001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",72,TRUE,1
74001,"[P] Hemorrhagic stroke (intracerebral bleeding) with inpatient admission (7Ps, 180Era) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [74001],
  ""targetCohortId"": [74],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 74001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 74;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    74001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",74,TRUE,1
220001,"[P] Angioedema (3Pe, 180Era) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [220001],
  ""targetCohortId"": [220],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 220001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 220;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    220001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",220,TRUE,1
234001,"Appendicitis (1Pe, 180Era) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [234001],
  ""targetCohortId"": [234],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 234001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 234;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    234001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",234,TRUE,1
238001,"[P] Optic Neuritis (7Pe, 365Era) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [238001],
  ""targetCohortId"": [238],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 238001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 238;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    238001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",238,TRUE,1
248001,"[P] Disseminated intravascular coagulation DIC (1Pe, 0Era, 365W) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [248001],
  ""targetCohortId"": [248],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 248001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 248;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    248001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",248,TRUE,1
249001,"[P] Ischemic (Non-hemorrhagic) Stroke (1Pe, 0Era, 365W) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [249001],
  ""targetCohortId"": [249],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 249001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 249;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    249001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",249,TRUE,1
251001,"[P] Acute pancreatitis (7Pe, 180Era) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [251001],
  ""targetCohortId"": [251],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 251001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 251;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    251001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",251,TRUE,1
258001,"[P] Anaphylaxis or Anaphylactic shock events (1Pe, 30Era) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [258001],
  ""targetCohortId"": [258],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 258001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 258;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    258001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",258,TRUE,1
284001,"[P] Myocarditis or Pericarditis (30Pe, 90Era) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [284001],
  ""targetCohortId"": [284],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 284001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 284;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    284001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",284,TRUE,1
292001,"[P] Hepatic Failure (365Pe, 365Era) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [292001],
  ""targetCohortId"": [292],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 292001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 292;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    292001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",292,TRUE,1
329001,"[P] Pneumonitis and lung infections (14Pe, 30Era) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [329001],
  ""targetCohortId"": [329],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 329001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 329;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    329001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",329,TRUE,1
356001,"[P] Epistaxis (3Pe, 7Era) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [356001],
  ""targetCohortId"": [356],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 356001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 356;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    356001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",356,TRUE,1
362001,"[P] Acute Kidney Injury AKI (7Pe, 30Era) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [362001],
  ""targetCohortId"": [362],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 362001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 362;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    362001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",362,TRUE,1
366001,"[P] Streptococcal throat infection (14Pe, 30Era) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [366001],
  ""targetCohortId"": [366],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 366001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 366;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    366001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",366,TRUE,1
367001,"[P] Allergic Rhinitis (14Pe, 30Era) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [367001],
  ""targetCohortId"": [367],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 367001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 367;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    367001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",367,TRUE,1
372001,"[P] Otitis media (3Pe, 30Era) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [372001],
  ""targetCohortId"": [372],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 372001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 372;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    372001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",372,TRUE,1
395001,"[P] Dysmenorrhea (90Pe, 365Era) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [395001],
  ""targetCohortId"": [395],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 395001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 395;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    395001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",395,TRUE,1
396001,"[P] Osteoarthritis (FP) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [396001],
  ""targetCohortId"": [396],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 396001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 396;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    396001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",396,TRUE,1
407001,"[P] Hemorrhoids (1Pe, 30Era) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [407001],
  ""targetCohortId"": [407],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 407001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 407;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    407001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",407,TRUE,1
410001,"[P] Acute Urinary tract infections UTI (1Pe, 30Era) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [410001],
  ""targetCohortId"": [410],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 410001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 410;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    410001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",410,TRUE,1
412001,"Transverse myelitis indexed on diagnosis (1Ps, 0Era, 365W) - - 1st w 365d pr first ever occurence with at least 365 days prior observation","{
  ""cohortId"": [412001],
  ""targetCohortId"": [412],
  ""subsetDefinitionId"": [1]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 412001;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 412;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    412001 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",412,TRUE,1
26002,"[P] Asthma or Chronic obstructive pulmonary disease (COPD) (FP) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [26002],
  ""targetCohortId"": [26],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 26002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 26;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    26002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",26,TRUE,2
27002,"[P] Asthma without COPD (FP) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [27002],
  ""targetCohortId"": [27],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 27002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 27;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    27002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",27,TRUE,2
30002,"[P] Tuberculosis (FP) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [30002],
  ""targetCohortId"": [30],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 30002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 30;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    30002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",30,TRUE,2
33002,"[P] Dementia (FP) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [33002],
  ""targetCohortId"": [33],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 33002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 33;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    33002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",33,TRUE,2
68002,"[W] Heart failure with inpatient admission (3Pe, 30Era) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [68002],
  ""targetCohortId"": [68],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 68002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 68;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    68002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",68,TRUE,2
70002,"[P] Stroke (ischemic or hemorrhagic) with inpatient admission (7Ps, 30Era) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [70002],
  ""targetCohortId"": [70],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 70002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 70;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    70002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",70,TRUE,2
71002,"[P] Acute myocardial infarction with inpatient admission (7Pe, 180Era) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [71002],
  ""targetCohortId"": [71],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 71002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 71;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    71002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",71,TRUE,2
72002,"[P] Influenza diagnosis or positive test result (7Pe, 90Era) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [72002],
  ""targetCohortId"": [72],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 72002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 72;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    72002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",72,TRUE,2
74002,"[P] Hemorrhagic stroke (intracerebral bleeding) with inpatient admission (7Ps, 180Era) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [74002],
  ""targetCohortId"": [74],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 74002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 74;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    74002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",74,TRUE,2
220002,"[P] Angioedema (3Pe, 180Era) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [220002],
  ""targetCohortId"": [220],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 220002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 220;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    220002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",220,TRUE,2
234002,"Appendicitis (1Pe, 180Era) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [234002],
  ""targetCohortId"": [234],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 234002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 234;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    234002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",234,TRUE,2
238002,"[P] Optic Neuritis (7Pe, 365Era) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [238002],
  ""targetCohortId"": [238],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 238002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 238;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    238002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",238,TRUE,2
248002,"[P] Disseminated intravascular coagulation DIC (1Pe, 0Era, 365W) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [248002],
  ""targetCohortId"": [248],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 248002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 248;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    248002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",248,TRUE,2
249002,"[P] Ischemic (Non-hemorrhagic) Stroke (1Pe, 0Era, 365W) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [249002],
  ""targetCohortId"": [249],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 249002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 249;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    249002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",249,TRUE,2
251002,"[P] Acute pancreatitis (7Pe, 180Era) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [251002],
  ""targetCohortId"": [251],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 251002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 251;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    251002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",251,TRUE,2
258002,"[P] Anaphylaxis or Anaphylactic shock events (1Pe, 30Era) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [258002],
  ""targetCohortId"": [258],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 258002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 258;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    258002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",258,TRUE,2
284002,"[P] Myocarditis or Pericarditis (30Pe, 90Era) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [284002],
  ""targetCohortId"": [284],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 284002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 284;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    284002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",284,TRUE,2
292002,"[P] Hepatic Failure (365Pe, 365Era) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [292002],
  ""targetCohortId"": [292],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 292002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 292;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    292002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",292,TRUE,2
329002,"[P] Pneumonitis and lung infections (14Pe, 30Era) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [329002],
  ""targetCohortId"": [329],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 329002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 329;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    329002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",329,TRUE,2
356002,"[P] Epistaxis (3Pe, 7Era) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [356002],
  ""targetCohortId"": [356],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 356002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 356;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    356002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",356,TRUE,2
362002,"[P] Acute Kidney Injury AKI (7Pe, 30Era) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [362002],
  ""targetCohortId"": [362],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 362002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 362;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    362002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",362,TRUE,2
366002,"[P] Streptococcal throat infection (14Pe, 30Era) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [366002],
  ""targetCohortId"": [366],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 366002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 366;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    366002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",366,TRUE,2
367002,"[P] Allergic Rhinitis (14Pe, 30Era) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [367002],
  ""targetCohortId"": [367],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 367002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 367;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    367002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",367,TRUE,2
372002,"[P] Otitis media (3Pe, 30Era) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [372002],
  ""targetCohortId"": [372],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 372002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 372;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    372002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",372,TRUE,2
395002,"[P] Dysmenorrhea (90Pe, 365Era) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [395002],
  ""targetCohortId"": [395],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 395002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 395;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    395002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",395,TRUE,2
396002,"[P] Osteoarthritis (FP) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [396002],
  ""targetCohortId"": [396],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 396002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 396;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    396002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",396,TRUE,2
407002,"[P] Hemorrhoids (1Pe, 30Era) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [407002],
  ""targetCohortId"": [407],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 407002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 407;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    407002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",407,TRUE,2
410002,"[P] Acute Urinary tract infections UTI (1Pe, 30Era) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [410002],
  ""targetCohortId"": [410],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 410002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 410;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    410002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",410,TRUE,2
412002,"Transverse myelitis indexed on diagnosis (1Ps, 0Era, 365W) - - 1st w 365d pr - start bf 2016 first ever occurence with at least 365 days prior observation before 2015-12-31","{
  ""cohortId"": [412002],
  ""targetCohortId"": [412],
  ""subsetDefinitionId"": [2]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 412002;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 412;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    412002 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",412,TRUE,2
26003,"[P] Asthma or Chronic obstructive pulmonary disease (COPD) (FP) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [26003],
  ""targetCohortId"": [26],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 26003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 26;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    26003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",26,TRUE,3
27003,"[P] Asthma without COPD (FP) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [27003],
  ""targetCohortId"": [27],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 27003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 27;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    27003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",27,TRUE,3
30003,"[P] Tuberculosis (FP) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [30003],
  ""targetCohortId"": [30],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 30003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 30;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    30003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",30,TRUE,3
33003,"[P] Dementia (FP) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [33003],
  ""targetCohortId"": [33],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 33003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 33;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    33003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",33,TRUE,3
68003,"[W] Heart failure with inpatient admission (3Pe, 30Era) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [68003],
  ""targetCohortId"": [68],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 68003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 68;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    68003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",68,TRUE,3
70003,"[P] Stroke (ischemic or hemorrhagic) with inpatient admission (7Ps, 30Era) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [70003],
  ""targetCohortId"": [70],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 70003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 70;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    70003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",70,TRUE,3
71003,"[P] Acute myocardial infarction with inpatient admission (7Pe, 180Era) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [71003],
  ""targetCohortId"": [71],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 71003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 71;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    71003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",71,TRUE,3
72003,"[P] Influenza diagnosis or positive test result (7Pe, 90Era) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [72003],
  ""targetCohortId"": [72],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 72003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 72;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    72003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",72,TRUE,3
74003,"[P] Hemorrhagic stroke (intracerebral bleeding) with inpatient admission (7Ps, 180Era) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [74003],
  ""targetCohortId"": [74],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 74003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 74;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    74003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",74,TRUE,3
220003,"[P] Angioedema (3Pe, 180Era) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [220003],
  ""targetCohortId"": [220],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 220003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 220;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    220003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",220,TRUE,3
234003,"Appendicitis (1Pe, 180Era) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [234003],
  ""targetCohortId"": [234],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 234003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 234;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    234003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",234,TRUE,3
238003,"[P] Optic Neuritis (7Pe, 365Era) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [238003],
  ""targetCohortId"": [238],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 238003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 238;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    238003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",238,TRUE,3
248003,"[P] Disseminated intravascular coagulation DIC (1Pe, 0Era, 365W) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [248003],
  ""targetCohortId"": [248],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 248003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 248;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    248003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",248,TRUE,3
249003,"[P] Ischemic (Non-hemorrhagic) Stroke (1Pe, 0Era, 365W) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [249003],
  ""targetCohortId"": [249],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 249003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 249;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    249003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",249,TRUE,3
251003,"[P] Acute pancreatitis (7Pe, 180Era) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [251003],
  ""targetCohortId"": [251],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 251003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 251;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    251003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",251,TRUE,3
258003,"[P] Anaphylaxis or Anaphylactic shock events (1Pe, 30Era) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [258003],
  ""targetCohortId"": [258],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 258003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 258;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    258003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",258,TRUE,3
284003,"[P] Myocarditis or Pericarditis (30Pe, 90Era) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [284003],
  ""targetCohortId"": [284],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 284003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 284;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    284003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",284,TRUE,3
292003,"[P] Hepatic Failure (365Pe, 365Era) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [292003],
  ""targetCohortId"": [292],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 292003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 292;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    292003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",292,TRUE,3
329003,"[P] Pneumonitis and lung infections (14Pe, 30Era) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [329003],
  ""targetCohortId"": [329],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 329003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 329;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    329003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",329,TRUE,3
356003,"[P] Epistaxis (3Pe, 7Era) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [356003],
  ""targetCohortId"": [356],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 356003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 356;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    356003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",356,TRUE,3
362003,"[P] Acute Kidney Injury AKI (7Pe, 30Era) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [362003],
  ""targetCohortId"": [362],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 362003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 362;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    362003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",362,TRUE,3
366003,"[P] Streptococcal throat infection (14Pe, 30Era) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [366003],
  ""targetCohortId"": [366],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 366003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 366;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    366003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",366,TRUE,3
367003,"[P] Allergic Rhinitis (14Pe, 30Era) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [367003],
  ""targetCohortId"": [367],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 367003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 367;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    367003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",367,TRUE,3
372003,"[P] Otitis media (3Pe, 30Era) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [372003],
  ""targetCohortId"": [372],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 372003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 372;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    372003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",372,TRUE,3
395003,"[P] Dysmenorrhea (90Pe, 365Era) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [395003],
  ""targetCohortId"": [395],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 395003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 395;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    395003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",395,TRUE,3
396003,"[P] Osteoarthritis (FP) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [396003],
  ""targetCohortId"": [396],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 396003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 396;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    396003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",396,TRUE,3
407003,"[P] Hemorrhoids (1Pe, 30Era) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [407003],
  ""targetCohortId"": [407],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 407003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 407;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    407003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",407,TRUE,3
410003,"[P] Acute Urinary tract infections UTI (1Pe, 30Era) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [410003],
  ""targetCohortId"": [410],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 410003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 410;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    410003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",410,TRUE,3
412003,"Transverse myelitis indexed on diagnosis (1Ps, 0Era, 365W) - - 1st w 365d pr start OAf 2016 first ever occurence with at least 365 days prior observation after 2016-01-01","{
  ""cohortId"": [412003],
  ""targetCohortId"": [412],
  ""subsetDefinitionId"": [3]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 412003;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 412;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    412003 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_1 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;",412,TRUE,3
26011,"[P] Asthma or Chronic obstructive pulmonary disease (COPD) (FP) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [26011],
  ""targetCohortId"": [26],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 26011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 26;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    26011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",26,TRUE,11
27011,"[P] Asthma without COPD (FP) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [27011],
  ""targetCohortId"": [27],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 27011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 27;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    27011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",27,TRUE,11
30011,"[P] Tuberculosis (FP) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [30011],
  ""targetCohortId"": [30],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 30011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 30;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    30011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",30,TRUE,11
33011,"[P] Dementia (FP) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [33011],
  ""targetCohortId"": [33],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 33011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 33;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    33011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",33,TRUE,11
68011,"[W] Heart failure with inpatient admission (3Pe, 30Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [68011],
  ""targetCohortId"": [68],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 68011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 68;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    68011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",68,TRUE,11
70011,"[P] Stroke (ischemic or hemorrhagic) with inpatient admission (7Ps, 30Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [70011],
  ""targetCohortId"": [70],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 70011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 70;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    70011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",70,TRUE,11
71011,"[P] Acute myocardial infarction with inpatient admission (7Pe, 180Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [71011],
  ""targetCohortId"": [71],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 71011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 71;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    71011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",71,TRUE,11
72011,"[P] Influenza diagnosis or positive test result (7Pe, 90Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [72011],
  ""targetCohortId"": [72],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 72011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 72;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    72011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",72,TRUE,11
74011,"[P] Hemorrhagic stroke (intracerebral bleeding) with inpatient admission (7Ps, 180Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [74011],
  ""targetCohortId"": [74],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 74011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 74;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    74011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",74,TRUE,11
220011,"[P] Angioedema (3Pe, 180Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [220011],
  ""targetCohortId"": [220],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 220011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 220;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    220011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",220,TRUE,11
234011,"Appendicitis (1Pe, 180Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [234011],
  ""targetCohortId"": [234],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 234011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 234;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    234011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",234,TRUE,11
238011,"[P] Optic Neuritis (7Pe, 365Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [238011],
  ""targetCohortId"": [238],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 238011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 238;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    238011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",238,TRUE,11
248011,"[P] Disseminated intravascular coagulation DIC (1Pe, 0Era, 365W) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [248011],
  ""targetCohortId"": [248],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 248011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 248;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    248011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",248,TRUE,11
249011,"[P] Ischemic (Non-hemorrhagic) Stroke (1Pe, 0Era, 365W) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [249011],
  ""targetCohortId"": [249],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 249011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 249;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    249011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",249,TRUE,11
251011,"[P] Acute pancreatitis (7Pe, 180Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [251011],
  ""targetCohortId"": [251],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 251011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 251;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    251011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",251,TRUE,11
258011,"[P] Anaphylaxis or Anaphylactic shock events (1Pe, 30Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [258011],
  ""targetCohortId"": [258],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 258011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 258;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    258011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",258,TRUE,11
284011,"[P] Myocarditis or Pericarditis (30Pe, 90Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [284011],
  ""targetCohortId"": [284],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 284011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 284;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    284011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",284,TRUE,11
292011,"[P] Hepatic Failure (365Pe, 365Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [292011],
  ""targetCohortId"": [292],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 292011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 292;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    292011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",292,TRUE,11
329011,"[P] Pneumonitis and lung infections (14Pe, 30Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [329011],
  ""targetCohortId"": [329],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 329011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 329;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    329011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",329,TRUE,11
356011,"[P] Epistaxis (3Pe, 7Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [356011],
  ""targetCohortId"": [356],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 356011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 356;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    356011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",356,TRUE,11
362011,"[P] Acute Kidney Injury AKI (7Pe, 30Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [362011],
  ""targetCohortId"": [362],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 362011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 362;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    362011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",362,TRUE,11
366011,"[P] Streptococcal throat infection (14Pe, 30Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [366011],
  ""targetCohortId"": [366],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 366011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 366;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    366011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",366,TRUE,11
367011,"[P] Allergic Rhinitis (14Pe, 30Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [367011],
  ""targetCohortId"": [367],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 367011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 367;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    367011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",367,TRUE,11
372011,"[P] Otitis media (3Pe, 30Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [372011],
  ""targetCohortId"": [372],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 372011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 372;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    372011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",372,TRUE,11
395011,"[P] Dysmenorrhea (90Pe, 365Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [395011],
  ""targetCohortId"": [395],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 395011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 395;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    395011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",395,TRUE,11
396011,"[P] Osteoarthritis (FP) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [396011],
  ""targetCohortId"": [396],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 396011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 396;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    396011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",396,TRUE,11
407011,"[P] Hemorrhoids (1Pe, 30Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [407011],
  ""targetCohortId"": [407],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 407011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 407;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    407011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",407,TRUE,11
410011,"[P] Acute Urinary tract infections UTI (1Pe, 30Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [410011],
  ""targetCohortId"": [410],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 410011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 410;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    410011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",410,TRUE,11
412011,"Transverse myelitis indexed on diagnosis (1Ps, 0Era, 365W) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, males","{
  ""cohortId"": [412011],
  ""targetCohortId"": [412],
  ""subsetDefinitionId"": [11]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 412011;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 412;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    412011 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",412,TRUE,11
26021,"[P] Asthma or Chronic obstructive pulmonary disease (COPD) (FP) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [26021],
  ""targetCohortId"": [26],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 26021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 26;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    26021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",26,TRUE,21
27021,"[P] Asthma without COPD (FP) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [27021],
  ""targetCohortId"": [27],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 27021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 27;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    27021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",27,TRUE,21
30021,"[P] Tuberculosis (FP) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [30021],
  ""targetCohortId"": [30],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 30021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 30;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    30021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",30,TRUE,21
33021,"[P] Dementia (FP) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [33021],
  ""targetCohortId"": [33],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 33021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 33;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    33021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",33,TRUE,21
68021,"[W] Heart failure with inpatient admission (3Pe, 30Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [68021],
  ""targetCohortId"": [68],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 68021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 68;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    68021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",68,TRUE,21
70021,"[P] Stroke (ischemic or hemorrhagic) with inpatient admission (7Ps, 30Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [70021],
  ""targetCohortId"": [70],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 70021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 70;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    70021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",70,TRUE,21
71021,"[P] Acute myocardial infarction with inpatient admission (7Pe, 180Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [71021],
  ""targetCohortId"": [71],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 71021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 71;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    71021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",71,TRUE,21
72021,"[P] Influenza diagnosis or positive test result (7Pe, 90Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [72021],
  ""targetCohortId"": [72],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 72021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 72;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    72021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",72,TRUE,21
74021,"[P] Hemorrhagic stroke (intracerebral bleeding) with inpatient admission (7Ps, 180Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [74021],
  ""targetCohortId"": [74],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 74021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 74;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    74021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",74,TRUE,21
220021,"[P] Angioedema (3Pe, 180Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [220021],
  ""targetCohortId"": [220],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 220021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 220;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    220021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",220,TRUE,21
234021,"Appendicitis (1Pe, 180Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [234021],
  ""targetCohortId"": [234],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 234021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 234;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    234021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",234,TRUE,21
238021,"[P] Optic Neuritis (7Pe, 365Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [238021],
  ""targetCohortId"": [238],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 238021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 238;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    238021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",238,TRUE,21
248021,"[P] Disseminated intravascular coagulation DIC (1Pe, 0Era, 365W) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [248021],
  ""targetCohortId"": [248],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 248021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 248;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    248021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",248,TRUE,21
249021,"[P] Ischemic (Non-hemorrhagic) Stroke (1Pe, 0Era, 365W) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [249021],
  ""targetCohortId"": [249],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 249021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 249;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    249021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",249,TRUE,21
251021,"[P] Acute pancreatitis (7Pe, 180Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [251021],
  ""targetCohortId"": [251],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 251021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 251;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    251021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",251,TRUE,21
258021,"[P] Anaphylaxis or Anaphylactic shock events (1Pe, 30Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [258021],
  ""targetCohortId"": [258],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 258021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 258;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    258021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",258,TRUE,21
284021,"[P] Myocarditis or Pericarditis (30Pe, 90Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [284021],
  ""targetCohortId"": [284],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 284021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 284;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    284021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",284,TRUE,21
292021,"[P] Hepatic Failure (365Pe, 365Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [292021],
  ""targetCohortId"": [292],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 292021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 292;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    292021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",292,TRUE,21
329021,"[P] Pneumonitis and lung infections (14Pe, 30Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [329021],
  ""targetCohortId"": [329],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 329021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 329;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    329021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",329,TRUE,21
356021,"[P] Epistaxis (3Pe, 7Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [356021],
  ""targetCohortId"": [356],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 356021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 356;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    356021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",356,TRUE,21
362021,"[P] Acute Kidney Injury AKI (7Pe, 30Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [362021],
  ""targetCohortId"": [362],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 362021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 362;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    362021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",362,TRUE,21
366021,"[P] Streptococcal throat infection (14Pe, 30Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [366021],
  ""targetCohortId"": [366],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 366021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 366;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    366021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",366,TRUE,21
367021,"[P] Allergic Rhinitis (14Pe, 30Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [367021],
  ""targetCohortId"": [367],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 367021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 367;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    367021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",367,TRUE,21
372021,"[P] Otitis media (3Pe, 30Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [372021],
  ""targetCohortId"": [372],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 372021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 372;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    372021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",372,TRUE,21
395021,"[P] Dysmenorrhea (90Pe, 365Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [395021],
  ""targetCohortId"": [395],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 395021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 395;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    395021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",395,TRUE,21
396021,"[P] Osteoarthritis (FP) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [396021],
  ""targetCohortId"": [396],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 396021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 396;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    396021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",396,TRUE,21
407021,"[P] Hemorrhoids (1Pe, 30Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [407021],
  ""targetCohortId"": [407],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 407021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 407;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    407021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",407,TRUE,21
410021,"[P] Acute Urinary tract infections UTI (1Pe, 30Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [410021],
  ""targetCohortId"": [410],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 410021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 410;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    410021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",410,TRUE,21
412021,"Transverse myelitis indexed on diagnosis (1Ps, 0Era, 365W) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, males","{
  ""cohortId"": [412021],
  ""targetCohortId"": [412],
  ""subsetDefinitionId"": [21]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 412021;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 412;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    412021 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",412,TRUE,21
26031,"[P] Asthma or Chronic obstructive pulmonary disease (COPD) (FP) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [26031],
  ""targetCohortId"": [26],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 26031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 26;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    26031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",26,TRUE,31
27031,"[P] Asthma without COPD (FP) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [27031],
  ""targetCohortId"": [27],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 27031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 27;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    27031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",27,TRUE,31
30031,"[P] Tuberculosis (FP) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [30031],
  ""targetCohortId"": [30],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 30031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 30;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    30031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",30,TRUE,31
33031,"[P] Dementia (FP) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [33031],
  ""targetCohortId"": [33],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 33031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 33;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    33031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",33,TRUE,31
68031,"[W] Heart failure with inpatient admission (3Pe, 30Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [68031],
  ""targetCohortId"": [68],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 68031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 68;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    68031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",68,TRUE,31
70031,"[P] Stroke (ischemic or hemorrhagic) with inpatient admission (7Ps, 30Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [70031],
  ""targetCohortId"": [70],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 70031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 70;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    70031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",70,TRUE,31
71031,"[P] Acute myocardial infarction with inpatient admission (7Pe, 180Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [71031],
  ""targetCohortId"": [71],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 71031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 71;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    71031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",71,TRUE,31
72031,"[P] Influenza diagnosis or positive test result (7Pe, 90Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [72031],
  ""targetCohortId"": [72],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 72031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 72;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    72031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",72,TRUE,31
74031,"[P] Hemorrhagic stroke (intracerebral bleeding) with inpatient admission (7Ps, 180Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [74031],
  ""targetCohortId"": [74],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 74031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 74;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    74031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",74,TRUE,31
220031,"[P] Angioedema (3Pe, 180Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [220031],
  ""targetCohortId"": [220],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 220031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 220;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    220031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",220,TRUE,31
234031,"Appendicitis (1Pe, 180Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [234031],
  ""targetCohortId"": [234],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 234031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 234;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    234031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",234,TRUE,31
238031,"[P] Optic Neuritis (7Pe, 365Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [238031],
  ""targetCohortId"": [238],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 238031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 238;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    238031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",238,TRUE,31
248031,"[P] Disseminated intravascular coagulation DIC (1Pe, 0Era, 365W) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [248031],
  ""targetCohortId"": [248],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 248031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 248;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    248031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",248,TRUE,31
249031,"[P] Ischemic (Non-hemorrhagic) Stroke (1Pe, 0Era, 365W) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [249031],
  ""targetCohortId"": [249],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 249031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 249;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    249031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",249,TRUE,31
251031,"[P] Acute pancreatitis (7Pe, 180Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [251031],
  ""targetCohortId"": [251],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 251031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 251;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    251031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",251,TRUE,31
258031,"[P] Anaphylaxis or Anaphylactic shock events (1Pe, 30Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [258031],
  ""targetCohortId"": [258],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 258031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 258;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    258031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",258,TRUE,31
284031,"[P] Myocarditis or Pericarditis (30Pe, 90Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [284031],
  ""targetCohortId"": [284],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 284031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 284;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    284031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",284,TRUE,31
292031,"[P] Hepatic Failure (365Pe, 365Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [292031],
  ""targetCohortId"": [292],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 292031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 292;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    292031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",292,TRUE,31
329031,"[P] Pneumonitis and lung infections (14Pe, 30Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [329031],
  ""targetCohortId"": [329],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 329031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 329;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    329031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",329,TRUE,31
356031,"[P] Epistaxis (3Pe, 7Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [356031],
  ""targetCohortId"": [356],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 356031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 356;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    356031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",356,TRUE,31
362031,"[P] Acute Kidney Injury AKI (7Pe, 30Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [362031],
  ""targetCohortId"": [362],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 362031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 362;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    362031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",362,TRUE,31
366031,"[P] Streptococcal throat infection (14Pe, 30Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [366031],
  ""targetCohortId"": [366],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 366031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 366;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    366031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",366,TRUE,31
367031,"[P] Allergic Rhinitis (14Pe, 30Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [367031],
  ""targetCohortId"": [367],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 367031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 367;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    367031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",367,TRUE,31
372031,"[P] Otitis media (3Pe, 30Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [372031],
  ""targetCohortId"": [372],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 372031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 372;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    372031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",372,TRUE,31
395031,"[P] Dysmenorrhea (90Pe, 365Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [395031],
  ""targetCohortId"": [395],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 395031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 395;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    395031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",395,TRUE,31
396031,"[P] Osteoarthritis (FP) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [396031],
  ""targetCohortId"": [396],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 396031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 396;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    396031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",396,TRUE,31
407031,"[P] Hemorrhoids (1Pe, 30Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [407031],
  ""targetCohortId"": [407],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 407031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 407;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    407031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",407,TRUE,31
410031,"[P] Acute Urinary tract infections UTI (1Pe, 30Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [410031],
  ""targetCohortId"": [410],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 410031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 410;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    410031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",410,TRUE,31
412031,"Transverse myelitis indexed on diagnosis (1Ps, 0Era, 365W) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, males","{
  ""cohortId"": [412031],
  ""targetCohortId"": [412],
  ""subsetDefinitionId"": [31]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 412031;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 412;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8507)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    412031 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",412,TRUE,31
26012,"[P] Asthma or Chronic obstructive pulmonary disease (COPD) (FP) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [26012],
  ""targetCohortId"": [26],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 26012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 26;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    26012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",26,TRUE,12
27012,"[P] Asthma without COPD (FP) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [27012],
  ""targetCohortId"": [27],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 27012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 27;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    27012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",27,TRUE,12
30012,"[P] Tuberculosis (FP) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [30012],
  ""targetCohortId"": [30],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 30012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 30;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    30012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",30,TRUE,12
33012,"[P] Dementia (FP) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [33012],
  ""targetCohortId"": [33],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 33012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 33;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    33012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",33,TRUE,12
68012,"[W] Heart failure with inpatient admission (3Pe, 30Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [68012],
  ""targetCohortId"": [68],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 68012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 68;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    68012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",68,TRUE,12
70012,"[P] Stroke (ischemic or hemorrhagic) with inpatient admission (7Ps, 30Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [70012],
  ""targetCohortId"": [70],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 70012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 70;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    70012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",70,TRUE,12
71012,"[P] Acute myocardial infarction with inpatient admission (7Pe, 180Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [71012],
  ""targetCohortId"": [71],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 71012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 71;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    71012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",71,TRUE,12
72012,"[P] Influenza diagnosis or positive test result (7Pe, 90Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [72012],
  ""targetCohortId"": [72],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 72012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 72;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    72012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",72,TRUE,12
74012,"[P] Hemorrhagic stroke (intracerebral bleeding) with inpatient admission (7Ps, 180Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [74012],
  ""targetCohortId"": [74],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 74012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 74;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    74012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",74,TRUE,12
220012,"[P] Angioedema (3Pe, 180Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [220012],
  ""targetCohortId"": [220],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 220012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 220;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    220012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",220,TRUE,12
234012,"Appendicitis (1Pe, 180Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [234012],
  ""targetCohortId"": [234],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 234012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 234;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    234012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",234,TRUE,12
238012,"[P] Optic Neuritis (7Pe, 365Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [238012],
  ""targetCohortId"": [238],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 238012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 238;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    238012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",238,TRUE,12
248012,"[P] Disseminated intravascular coagulation DIC (1Pe, 0Era, 365W) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [248012],
  ""targetCohortId"": [248],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 248012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 248;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    248012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",248,TRUE,12
249012,"[P] Ischemic (Non-hemorrhagic) Stroke (1Pe, 0Era, 365W) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [249012],
  ""targetCohortId"": [249],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 249012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 249;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    249012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",249,TRUE,12
251012,"[P] Acute pancreatitis (7Pe, 180Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [251012],
  ""targetCohortId"": [251],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 251012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 251;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    251012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",251,TRUE,12
258012,"[P] Anaphylaxis or Anaphylactic shock events (1Pe, 30Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [258012],
  ""targetCohortId"": [258],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 258012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 258;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    258012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",258,TRUE,12
284012,"[P] Myocarditis or Pericarditis (30Pe, 90Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [284012],
  ""targetCohortId"": [284],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 284012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 284;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    284012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",284,TRUE,12
292012,"[P] Hepatic Failure (365Pe, 365Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [292012],
  ""targetCohortId"": [292],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 292012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 292;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    292012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",292,TRUE,12
329012,"[P] Pneumonitis and lung infections (14Pe, 30Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [329012],
  ""targetCohortId"": [329],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 329012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 329;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    329012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",329,TRUE,12
356012,"[P] Epistaxis (3Pe, 7Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [356012],
  ""targetCohortId"": [356],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 356012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 356;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    356012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",356,TRUE,12
362012,"[P] Acute Kidney Injury AKI (7Pe, 30Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [362012],
  ""targetCohortId"": [362],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 362012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 362;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    362012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",362,TRUE,12
366012,"[P] Streptococcal throat infection (14Pe, 30Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [366012],
  ""targetCohortId"": [366],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 366012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 366;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    366012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",366,TRUE,12
367012,"[P] Allergic Rhinitis (14Pe, 30Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [367012],
  ""targetCohortId"": [367],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 367012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 367;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    367012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",367,TRUE,12
372012,"[P] Otitis media (3Pe, 30Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [372012],
  ""targetCohortId"": [372],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 372012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 372;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    372012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",372,TRUE,12
395012,"[P] Dysmenorrhea (90Pe, 365Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [395012],
  ""targetCohortId"": [395],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 395012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 395;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    395012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",395,TRUE,12
396012,"[P] Osteoarthritis (FP) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [396012],
  ""targetCohortId"": [396],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 396012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 396;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    396012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",396,TRUE,12
407012,"[P] Hemorrhoids (1Pe, 30Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [407012],
  ""targetCohortId"": [407],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 407012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 407;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    407012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",407,TRUE,12
410012,"[P] Acute Urinary tract infections UTI (1Pe, 30Era) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [410012],
  ""targetCohortId"": [410],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 410012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 410;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    410012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",410,TRUE,12
412012,"Transverse myelitis indexed on diagnosis (1Ps, 0Era, 365W) - - 1st w 365d pr - M first ever occurence with at least 365 days prior observation, females","{
  ""cohortId"": [412012],
  ""targetCohortId"": [412],
  ""subsetDefinitionId"": [12]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 412012;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 412;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    412012 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",412,TRUE,12
26022,"[P] Asthma or Chronic obstructive pulmonary disease (COPD) (FP) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [26022],
  ""targetCohortId"": [26],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 26022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 26;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    26022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",26,TRUE,22
27022,"[P] Asthma without COPD (FP) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [27022],
  ""targetCohortId"": [27],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 27022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 27;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    27022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",27,TRUE,22
30022,"[P] Tuberculosis (FP) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [30022],
  ""targetCohortId"": [30],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 30022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 30;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    30022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",30,TRUE,22
33022,"[P] Dementia (FP) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [33022],
  ""targetCohortId"": [33],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 33022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 33;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    33022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",33,TRUE,22
68022,"[W] Heart failure with inpatient admission (3Pe, 30Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [68022],
  ""targetCohortId"": [68],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 68022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 68;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    68022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",68,TRUE,22
70022,"[P] Stroke (ischemic or hemorrhagic) with inpatient admission (7Ps, 30Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [70022],
  ""targetCohortId"": [70],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 70022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 70;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    70022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",70,TRUE,22
71022,"[P] Acute myocardial infarction with inpatient admission (7Pe, 180Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [71022],
  ""targetCohortId"": [71],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 71022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 71;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    71022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",71,TRUE,22
72022,"[P] Influenza diagnosis or positive test result (7Pe, 90Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [72022],
  ""targetCohortId"": [72],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 72022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 72;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    72022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",72,TRUE,22
74022,"[P] Hemorrhagic stroke (intracerebral bleeding) with inpatient admission (7Ps, 180Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [74022],
  ""targetCohortId"": [74],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 74022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 74;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    74022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",74,TRUE,22
220022,"[P] Angioedema (3Pe, 180Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [220022],
  ""targetCohortId"": [220],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 220022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 220;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    220022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",220,TRUE,22
234022,"Appendicitis (1Pe, 180Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [234022],
  ""targetCohortId"": [234],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 234022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 234;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    234022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",234,TRUE,22
238022,"[P] Optic Neuritis (7Pe, 365Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [238022],
  ""targetCohortId"": [238],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 238022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 238;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    238022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",238,TRUE,22
248022,"[P] Disseminated intravascular coagulation DIC (1Pe, 0Era, 365W) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [248022],
  ""targetCohortId"": [248],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 248022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 248;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    248022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",248,TRUE,22
249022,"[P] Ischemic (Non-hemorrhagic) Stroke (1Pe, 0Era, 365W) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [249022],
  ""targetCohortId"": [249],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 249022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 249;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    249022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",249,TRUE,22
251022,"[P] Acute pancreatitis (7Pe, 180Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [251022],
  ""targetCohortId"": [251],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 251022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 251;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    251022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",251,TRUE,22
258022,"[P] Anaphylaxis or Anaphylactic shock events (1Pe, 30Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [258022],
  ""targetCohortId"": [258],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 258022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 258;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    258022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",258,TRUE,22
284022,"[P] Myocarditis or Pericarditis (30Pe, 90Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [284022],
  ""targetCohortId"": [284],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 284022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 284;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    284022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",284,TRUE,22
292022,"[P] Hepatic Failure (365Pe, 365Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [292022],
  ""targetCohortId"": [292],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 292022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 292;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    292022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",292,TRUE,22
329022,"[P] Pneumonitis and lung infections (14Pe, 30Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [329022],
  ""targetCohortId"": [329],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 329022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 329;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    329022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",329,TRUE,22
356022,"[P] Epistaxis (3Pe, 7Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [356022],
  ""targetCohortId"": [356],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 356022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 356;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    356022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",356,TRUE,22
362022,"[P] Acute Kidney Injury AKI (7Pe, 30Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [362022],
  ""targetCohortId"": [362],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 362022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 362;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    362022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",362,TRUE,22
366022,"[P] Streptococcal throat infection (14Pe, 30Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [366022],
  ""targetCohortId"": [366],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 366022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 366;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    366022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",366,TRUE,22
367022,"[P] Allergic Rhinitis (14Pe, 30Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [367022],
  ""targetCohortId"": [367],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 367022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 367;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    367022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",367,TRUE,22
372022,"[P] Otitis media (3Pe, 30Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [372022],
  ""targetCohortId"": [372],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 372022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 372;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    372022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",372,TRUE,22
395022,"[P] Dysmenorrhea (90Pe, 365Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [395022],
  ""targetCohortId"": [395],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 395022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 395;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    395022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",395,TRUE,22
396022,"[P] Osteoarthritis (FP) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [396022],
  ""targetCohortId"": [396],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 396022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 396;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    396022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",396,TRUE,22
407022,"[P] Hemorrhoids (1Pe, 30Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [407022],
  ""targetCohortId"": [407],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 407022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 407;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    407022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",407,TRUE,22
410022,"[P] Acute Urinary tract infections UTI (1Pe, 30Era) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [410022],
  ""targetCohortId"": [410],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 410022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 410;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    410022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",410,TRUE,22
412022,"Transverse myelitis indexed on diagnosis (1Ps, 0Era, 365W) - - 1st w 365d pr - start bf 2016 - M first ever occurence with at least 365 days prior observation before 2015-12-31, females","{
  ""cohortId"": [412022],
  ""targetCohortId"": [412],
  ""subsetDefinitionId"": [22]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 412022;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 412;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0



  AND c.cohort_start_date <= DATEFROMPARTS(2015,12,31)

;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    412022 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",412,TRUE,22
26032,"[P] Asthma or Chronic obstructive pulmonary disease (COPD) (FP) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [26032],
  ""targetCohortId"": [26],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 26032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 26;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    26032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",26,TRUE,32
27032,"[P] Asthma without COPD (FP) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [27032],
  ""targetCohortId"": [27],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 27032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 27;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    27032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",27,TRUE,32
30032,"[P] Tuberculosis (FP) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [30032],
  ""targetCohortId"": [30],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 30032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 30;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    30032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",30,TRUE,32
33032,"[P] Dementia (FP) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [33032],
  ""targetCohortId"": [33],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 33032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 33;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    33032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",33,TRUE,32
68032,"[W] Heart failure with inpatient admission (3Pe, 30Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [68032],
  ""targetCohortId"": [68],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 68032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 68;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    68032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",68,TRUE,32
70032,"[P] Stroke (ischemic or hemorrhagic) with inpatient admission (7Ps, 30Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [70032],
  ""targetCohortId"": [70],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 70032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 70;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    70032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",70,TRUE,32
71032,"[P] Acute myocardial infarction with inpatient admission (7Pe, 180Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [71032],
  ""targetCohortId"": [71],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 71032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 71;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    71032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",71,TRUE,32
72032,"[P] Influenza diagnosis or positive test result (7Pe, 90Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [72032],
  ""targetCohortId"": [72],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 72032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 72;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    72032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",72,TRUE,32
74032,"[P] Hemorrhagic stroke (intracerebral bleeding) with inpatient admission (7Ps, 180Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [74032],
  ""targetCohortId"": [74],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 74032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 74;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    74032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",74,TRUE,32
220032,"[P] Angioedema (3Pe, 180Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [220032],
  ""targetCohortId"": [220],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 220032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 220;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    220032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",220,TRUE,32
234032,"Appendicitis (1Pe, 180Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [234032],
  ""targetCohortId"": [234],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 234032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 234;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    234032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",234,TRUE,32
238032,"[P] Optic Neuritis (7Pe, 365Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [238032],
  ""targetCohortId"": [238],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 238032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 238;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    238032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",238,TRUE,32
248032,"[P] Disseminated intravascular coagulation DIC (1Pe, 0Era, 365W) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [248032],
  ""targetCohortId"": [248],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 248032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 248;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    248032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",248,TRUE,32
249032,"[P] Ischemic (Non-hemorrhagic) Stroke (1Pe, 0Era, 365W) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [249032],
  ""targetCohortId"": [249],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 249032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 249;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    249032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",249,TRUE,32
251032,"[P] Acute pancreatitis (7Pe, 180Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [251032],
  ""targetCohortId"": [251],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 251032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 251;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    251032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",251,TRUE,32
258032,"[P] Anaphylaxis or Anaphylactic shock events (1Pe, 30Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [258032],
  ""targetCohortId"": [258],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 258032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 258;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    258032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",258,TRUE,32
284032,"[P] Myocarditis or Pericarditis (30Pe, 90Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [284032],
  ""targetCohortId"": [284],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 284032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 284;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    284032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",284,TRUE,32
292032,"[P] Hepatic Failure (365Pe, 365Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [292032],
  ""targetCohortId"": [292],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 292032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 292;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    292032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",292,TRUE,32
329032,"[P] Pneumonitis and lung infections (14Pe, 30Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [329032],
  ""targetCohortId"": [329],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 329032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 329;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    329032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",329,TRUE,32
356032,"[P] Epistaxis (3Pe, 7Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [356032],
  ""targetCohortId"": [356],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 356032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 356;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    356032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",356,TRUE,32
362032,"[P] Acute Kidney Injury AKI (7Pe, 30Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [362032],
  ""targetCohortId"": [362],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 362032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 362;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    362032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",362,TRUE,32
366032,"[P] Streptococcal throat infection (14Pe, 30Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [366032],
  ""targetCohortId"": [366],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 366032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 366;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    366032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",366,TRUE,32
367032,"[P] Allergic Rhinitis (14Pe, 30Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [367032],
  ""targetCohortId"": [367],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 367032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 367;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    367032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",367,TRUE,32
372032,"[P] Otitis media (3Pe, 30Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [372032],
  ""targetCohortId"": [372],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 372032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 372;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    372032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",372,TRUE,32
395032,"[P] Dysmenorrhea (90Pe, 365Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [395032],
  ""targetCohortId"": [395],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 395032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 395;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    395032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",395,TRUE,32
396032,"[P] Osteoarthritis (FP) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [396032],
  ""targetCohortId"": [396],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 396032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 396;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    396032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",396,TRUE,32
407032,"[P] Hemorrhoids (1Pe, 30Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [407032],
  ""targetCohortId"": [407],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 407032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 407;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    407032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",407,TRUE,32
410032,"[P] Acute Urinary tract infections UTI (1Pe, 30Era) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [410032],
  ""targetCohortId"": [410],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 410032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 410;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    410032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",410,TRUE,32
412032,"Transverse myelitis indexed on diagnosis (1Ps, 0Era, 365W) - - 1st w 365d pr start OAf 2016 - M first ever occurence with at least 365 days prior observation after 2016-01-01, females","{
  ""cohortId"": [412032],
  ""targetCohortId"": [412],
  ""subsetDefinitionId"": [32]
}","DELETE FROM @cohort_database_schema.@cohort_table WHERE cohort_definition_id = 412032;
DROP TABLE IF EXISTS #cohort_sub_base;
SELECT * INTO #cohort_sub_base FROM @cohort_database_schema.@cohort_table
WHERE cohort_definition_id = 412;
DROP TABLE IF EXISTS #S_1;
 SELECT
  c.subject_id,
  c.cohort_start_date,
  c.cohort_end_date
INTO #S_1
FROM (
  SELECT
    subject_id,
    cohort_start_date,
    cohort_end_date,
    row_number() over (partition by subject_id order by cohort_start_date ASC) ordinal
  FROM #cohort_sub_base t
  
) c

  JOIN @cdm_database_schema.observation_period op
    ON c.subject_id = op.person_id
    AND c.cohort_start_date >= op.observation_period_start_date
    AND c.cohort_start_date <= op.observation_period_end_date


 WHERE c.ordinal = 1


  AND DATEDIFF(day, op.observation_period_start_date, c.cohort_start_date) >= 365
  AND DATEDIFF(day, c.cohort_start_date, op.observation_period_end_date) >= 0


  AND c.cohort_start_date >= DATEFROMPARTS(2016,1,1)


;
DROP TABLE IF EXISTS #S_2;
 SELECT
  T.subject_id,
  T.cohort_start_date,
  T.cohort_end_date
INTO #S_2
FROM #S_1 T
JOIN @cdm_database_schema.person p ON T.subject_id = p.person_id
WHERE 1 = 1-- simplifies ternary logic
AND p.gender_concept_id IN (8532)


AND YEAR(T.cohort_start_date) - p.year_of_birth >= 0
AND YEAR(T.cohort_start_date) - p.year_of_birth <= 99999
;
INSERT INTO @cohort_database_schema.@cohort_table
SELECT
    412032 as cohort_definition_id,
    T.subject_id,
    T.cohort_start_date,
    T.cohort_end_date
FROM #S_2 T;

DROP TABLE IF EXISTS #cohort_sub_base;
DROP TABLE IF EXISTS #S_1;
DROP TABLE IF EXISTS #S_2;",412,TRUE,32
